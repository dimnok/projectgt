-- Миграция: Добавление GIN триграммного индекса для поиска по name в work_items
-- Дата: 06 ноября 2025 года
-- Цель: Оптимизация поиска по наименованию работ внутри объекта

-- ============================================================================
-- 1. СОЗДАНИЕ РАСШИРЕНИЯ pg_trgm (если еще не создано)
-- ============================================================================

CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- ============================================================================
-- 2. СОЗДАНИЕ GIN ТРИГРАММНОГО ИНДЕКСА
-- ============================================================================

-- GIN триграммный индекс для быстрого поиска по name с использованием ILIKE
-- Оптимизирует поиск внутри объекта (50-200k записей вместо миллионов)
CREATE INDEX IF NOT EXISTS idx_work_items_name_trgm 
ON work_items USING gin (name gin_trgm_ops);

-- Комментарий для документации
COMMENT ON INDEX idx_work_items_name_trgm IS 
'GIN триграммный индекс для оптимизации поиска по наименованию работ (name) с использованием ILIKE. Позволяет быстро находить записи даже при поиске с % в начале паттерна. Оптимизирует поиск внутри объекта (50-200k записей), так как поиск всегда выполняется после фильтрации по объекту.';

-- ============================================================================
-- 3. ПРОВЕРКА СОЗДАНИЯ ИНДЕКСА
-- ============================================================================

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_indexes 
    WHERE indexname = 'idx_work_items_name_trgm'
  ) THEN
    RAISE EXCEPTION 'Индекс idx_work_items_name_trgm не создан!';
  END IF;

  RAISE NOTICE 'Миграция успешно применена! GIN триграммный индекс создан.';
END $$;

