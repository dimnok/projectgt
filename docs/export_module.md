# Модуль "Выгрузка" (Export)

## Описание

Модуль "Выгрузка" предназначен для формирования и экспорта отчетов по выполненным работам в формате Excel. Модуль позволяет фильтровать данные по различным критериям с поддержкой множественного выбора и выгружать агрегированную информацию о работах.

## Функциональность

### Основные возможности:
- **Фильтрация по периоду** - обязательный фильтр для выбора временного диапазона
- **Множественная фильтрация по объектам** - выбор нескольких объектов одновременно
- **Множественная фильтрация по договорам** - выбор нескольких договоров одновременно
- **Множественная фильтрация по системам** - выбор нескольких систем одновременно
- **Множественная фильтрация по подсистемам** - выбор нескольких подсистем одновременно
- **Каскадные фильтры** - умная система взаимосвязанных фильтров
- **Отображение данных в таблице** - просмотр агрегированных данных с возможностью сортировки
- **Экспорт в Excel** - выгрузка данных в файл Excel с форматированием

### Структура отчета:
Отчет содержит следующие колонки:
- **Объект** - наименование объекта
- **Договор** - номер договора
- **Система** - наименование системы
- **Подсистема** - наименование подсистемы
- **Работа** - наименование выполненной работы
- **Секция** - секция объекта
- **Этаж** - этаж объекта
- **Ед. изм.** - единица измерения
- **Количество** - объем выполненных работ
- **Цена** - цена за единицу
- **Сумма** - итоговая сумма

## Архитектура

Модуль следует принципам Clean Architecture и разделен на три слоя:

### Domain слой (`lib/features/export/domain/`)
- **Entities:**
  - `ExportFilter` - фильтры для выгрузки данных (поддерживает списки)
  - `ExportReport` - агрегированные данные отчета
- **Repositories:**
  - `ExportRepository` - абстрактный интерфейс для получения данных

### Data слой (`lib/features/export/data/`)
- **Models:**
  - `ExportFilterModel` - data-модель фильтров с JSON сериализацией (поддерживает списки)
  - `ExportReportModel` - data-модель отчета с JSON сериализацией
- **DataSources:**
  - `ExportDataSource` - абстрактный интерфейс источника данных
  - `ExportDataSourceImpl` - реализация с SQL запросами к Supabase (использует inFilter для множественного выбора)
- **Repositories:**
  - `ExportRepositoryImpl` - реализация репозитория с маппингом данных

### Presentation слой (`lib/features/export/presentation/`)
- **Screens:**
  - `ExportScreen` - основной экран модуля с двумя табами
  - `ExportTabReports` - таб отчетов
  - `ExportTabSearch` - таб поиска
- **Widgets:**
  - `ExportFilterWidget` - панель фильтрации с мультиселектом
  - `ExportTableWidget` - адаптивная таблица с данными
- **Providers:**
  - `ExportProvider` - StateNotifier для управления состоянием
  - `ExportFilterProvider` - управление состоянием фильтров
  - Каскадные провайдеры для умной фильтрации
- **Services:**
  - `ExportService` - сервис для экспорта в Excel

## Технические детали

### Множественный выбор:
- Все фильтры (кроме периода) поддерживают множественный выбор
- Domain сущность `ExportFilter` использует `List<String>` вместо `String?`
- Data source использует `inFilter()` для SQL запросов с множественными значениями
- UI предоставляет мультиселект dropdown'ы

### Каскадные фильтры:
- Умная система взаимосвязанных фильтров через estimates
- Доступные значения в каждом фильтре зависят от выбранных значений в других
- Провайдеры: `availableObjectsForExportProvider`, `availableContractsForExportProvider`, etc.

### Зависимости:
- `excel: ^4.0.6` - для создания Excel файлов
- `dropdown_textfield` - для мультиселект dropdown'ов
- `supabase_flutter` - для работы с базой данных
- `riverpod` - для управления состоянием
- `freezed` - для неизменяемых классов

### SQL запросы:
Модуль использует комплексные SQL запросы с JOIN между таблицами:
- `works` - основная таблица смен
- `objects` - объекты строительства
- `work_items` - выполненные работы
- `estimates` - сметы
- `contracts` - договоры

### Форматирование Excel:
- Заголовки таблицы выделены жирным шрифтом
- Автоматический подбор ширины колонок
- Форматирование числовых значений
- Использование типов `TextCellValue` и `DoubleCellValue`

## Использование

### Навигация:
Модуль доступен через боковое меню приложения в разделе "Выгрузка" с иконкой `Icons.file_download_outlined`.

### Маршрутизация:
- Путь: `/export`
- Имя маршрута: `export`

### Процесс работы:
1. Выбор обязательного периода (дата начала и окончания)
2. Опциональный выбор дополнительных фильтров (множественный выбор)
3. Нажатие кнопки "Сформировать отчет"
4. Просмотр данных в таблице
5. Экспорт в Excel через кнопку "Выгрузить отчет"
6. Выбор имени файла

### Состояния интерфейса:
- **Загрузка** - отображение индикатора загрузки
- **Ошибка** - отображение сообщения об ошибке
- **Пустые данные** - сообщение об отсутствии данных
- **Данные загружены** - отображение таблицы с возможностью экспорта

## Интеграция

Модуль полностью интегрирован в основное приложение:
- Добавлен маршрут в `app_router.dart`
- Добавлен пункт меню в `app_drawer.dart`
- Следует общим принципам архитектуры приложения
- Использует общие провайдеры и сервисы

## Оптимизации (2024-12-19)

### Множественный выбор:
- ✅ Обновлена domain сущность `ExportFilter` для поддержки списков
- ✅ Обновлена data модель `ExportFilterModel` для поддержки списков
- ✅ Обновлен data source для использования `inFilter()` вместо `eq()`
- ✅ Исправлена логика в виджете фильтров - убрана проблема с `.first`
- ✅ Унифицирована логика сброса фильтров (текущий месяц)
- ✅ Исправлены предупреждения BuildContext в async методах

### Удаленный код:
- ❌ Убрана логика с `.first` - теперь используются полные списки
- ❌ Убрано несоответствие между виджетом (30 дней) и провайдером (текущий месяц)
- ❌ Убраны предупреждения линтера

## Тестирование

Для тестирования модуля рекомендуется:
1. Проверить корректность множественной фильтрации данных
2. Убедиться в правильности SQL запросов с `inFilter()`
3. Протестировать каскадные фильтры
4. Протестировать экспорт в Excel на различных наборах данных
5. Проверить обработку ошибок и граничных случаев
6. Тестировать адаптивность интерфейса на разных устройствах

## Возможные улучшения

- Добавление дополнительных форматов экспорта (CSV, PDF)
- Сохранение настроек фильтров пользователя
- Добавление предварительного просмотра перед экспортом
- Возможность экспорта в облачные сервисы
- Добавление шаблонов отчетов
- Планировщик автоматических отчетов 