# Модуль "Выгрузка" (Export)

## Описание

Модуль "Выгрузка" предназначен для формирования и экспорта отчетов по выполненным работам в формате Excel. Модуль позволяет фильтровать данные по различным критериям и выгружать агрегированную информацию о работах, часах сотрудников и использованных материалах.

## Функциональность

### Основные возможности:
- **Фильтрация по периоду** - обязательный фильтр для выбора временного диапазона
- **Фильтрация по объекту** - опциональный фильтр для выбора конкретного объекта
- **Фильтрация по договору** - опциональный фильтр для выбора конкретного договора
- **Фильтрация по системе** - опциональный фильтр для выбора конкретной системы
- **Фильтрация по подсистеме** - опциональный фильтр для выбора конкретной подсистемы
- **Отображение данных в таблице** - просмотр агрегированных данных с возможностью сортировки
- **Экспорт в Excel** - выгрузка данных в файл Excel с форматированием

### Структура отчета:
Отчет содержит следующие колонки:
- **Дата** - дата выполнения работ
- **Объект** - наименование объекта
- **Договор** - номер договора
- **Система** - наименование системы
- **Подсистема** - наименование подсистемы
- **Работа** - наименование выполненной работы
- **Ед. изм.** - единица измерения
- **Количество** - объем выполненных работ
- **Сотрудник** - ФИО сотрудника
- **Часы** - количество отработанных часов
- **Материал** - наименование использованного материала
- **Кол-во материала** - количество использованного материала
- **Ед. изм. материала** - единица измерения материала

## Архитектура

Модуль следует принципам Clean Architecture и разделен на три слоя:

### Domain слой (`lib/features/export/domain/`)
- **Entities:**
  - `ExportFilter` - фильтры для выгрузки данных
  - `ExportReport` - агрегированные данные отчета
- **Repositories:**
  - `ExportRepository` - абстрактный интерфейс для получения данных

### Data слой (`lib/features/export/data/`)
- **Models:**
  - `ExportFilterModel` - data-модель фильтров с JSON сериализацией
  - `ExportReportModel` - data-модель отчета с JSON сериализацией
- **DataSources:**
  - `ExportDataSource` - абстрактный интерфейс источника данных
  - `ExportDataSourceImpl` - реализация с SQL запросами к Supabase
- **Repositories:**
  - `ExportRepositoryImpl` - реализация репозитория с маппингом данных

### Presentation слой (`lib/features/export/presentation/`)
- **Screens:**
  - `ExportScreen` - основной экран модуля
- **Widgets:**
  - `ExportFilterPanel` - панель фильтрации
  - `ExportTableWidget` - таблица с данными
- **Providers:**
  - `ExportProvider` - StateNotifier для управления состоянием
  - Провайдеры для получения справочных данных
- **Services:**
  - `ExportService` - сервис для экспорта в Excel

## Технические детали

### Зависимости:
- `excel: ^4.0.6` - для создания Excel файлов
- `file_picker` - для выбора места сохранения файла
- `supabase_flutter` - для работы с базой данных
- `riverpod` - для управления состоянием
- `freezed` - для неизменяемых классов

### SQL запросы:
Модуль использует комплексные SQL запросы с JOIN между таблицами:
- `works` - основная таблица смен
- `objects` - объекты строительства
- `work_items` - выполненные работы
- `estimates` - сметы
- `contracts` - договоры
- `work_hours` - часы сотрудников
- `employees` - сотрудники
- `work_materials` - использованные материалы

### Форматирование Excel:
- Заголовки таблицы выделены жирным шрифтом
- Автоматический подбор ширины колонок
- Форматирование числовых значений
- Использование типов `TextCellValue` и `DoubleCellValue`

## Использование

### Навигация:
Модуль доступен через боковое меню приложения в разделе "Выгрузка" с иконкой `Icons.file_download_outlined`.

### Маршрутизация:
- Путь: `/export`
- Имя маршрута: `export`

### Процесс работы:
1. Выбор обязательного периода (дата начала и окончания)
2. Опциональный выбор дополнительных фильтров
3. Нажатие кнопки "Сформировать отчет"
4. Просмотр данных в таблице
5. Экспорт в Excel через кнопку "Экспорт в Excel"
6. Выбор имени файла и места сохранения

### Состояния интерфейса:
- **Загрузка** - отображение индикатора загрузки
- **Ошибка** - отображение сообщения об ошибке
- **Пустые данные** - сообщение об отсутствии данных
- **Данные загружены** - отображение таблицы с возможностью экспорта

## Интеграция

Модуль полностью интегрирован в основное приложение:
- Добавлен маршрут в `app_router.dart`
- Добавлен пункт меню в `app_drawer.dart`
- Следует общим принципам архитектуры приложения
- Использует общие провайдеры и сервисы

## Тестирование

Для тестирования модуля рекомендуется:
1. Проверить корректность фильтрации данных
2. Убедиться в правильности SQL запросов
3. Протестировать экспорт в Excel на различных наборах данных
4. Проверить обработку ошибок и граничных случаев
5. Тестировать адаптивность интерфейса на разных устройствах

## Возможные улучшения

- Добавление дополнительных форматов экспорта (CSV, PDF)
- Сохранение настроек фильтров пользователя
- Добавление предварительного просмотра перед экспортом
- Возможность экспорта в облачные сервисы
- Добавление шаблонов отчетов
- Планировщик автоматических отчетов 