# План перехода на авторизацию по номеру телефона (Phone-only Auth)

Этот план описывает процесс перевода приложения на единый способ входа через телефон (Telegram/SMS) с сохранением Email как технического идентификатора.

**Важное правило:** После каждого выполненного этапа я предоставляю краткий отчет и ожидаю вашего подтверждения для перехода к следующему шагу.

---

## Этап 1: Укрепление и автоматизация базы данных
- [x] Добавить `UNIQUE constraint` на колонку `phone` в таблице `public.profiles`.
- [x] Создать PostgreSQL функцию и триггер для автоматической синхронизации номера телефона и метаданных из `public.profiles` в `auth.users`.
- [x] Выполнить финальную проверку и нормализацию всех существующих записей.

## Этап 2: Рефакторинг серверной логики (Edge Function)
- [x] Оптимизировать поиск в функции `otp-notisend` (замена перебора на точечный запрос `.eq`).
- [x] Доработать логику возврата Email: функция должна всегда возвращать существующий email профиля, если он есть, вместо генерации нового.
- [x] Улучшить обработку ошибок и логирование в функции.

## Этап 3: Рефакторинг инфраструктуры Flutter (Data Layer)
- [x] Обновить `AuthDataSource` и `AuthRepository`: пометить методы входа по паролю и Email OTP как устаревшие (deprecated).
- [x] Модифицировать `SupabaseAuthDataSource`: адаптировать методы верификации под новую логику Edge-функции.
- [x] Удалить неиспользуемые провайдеры, связанные с почтовой авторизацией.

## Этап 4: Рефакторинг интерфейса (UI/UX)
- [x] Переработать `LoginScreen`: удалить переключатель способов входа, оставить только ввод номера телефона.
- [x] Реализовать продвинутую валидацию и маску ввода номера (+7...) для удобства пользователя.
- [x] Обновить `OtpInputBottomSheet`, убрав упоминания о почте и адаптировав тексты под телефон.

## Этап 5: Тестирование и финализация
- [x] Протестировать сценарий "Старый пользователь" (вход по телефону в существующий аккаунт с почтой).
- [x] Протестировать сценарий "Новый пользователь" (регистрация -> создание профиля -> onboarding).
- [x] Удалить неиспользуемые экраны и виджеты, связанные со старым способом входа.
- [x] Обновить документацию модуля авторизации.

