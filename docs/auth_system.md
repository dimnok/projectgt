# Система аутентификации и профилей (RBAC v3)

## 0) Главный принцип
В приложении отсутствует понятие «глобального администратора». Все права и доступы пользователя определяются его членством в конкретной компании через таблицу `company_members`.

---

## 1. Процесс входа и онбординга

### 1.1 Регистрация и вход (OTP)
1. Пользователь вводит номер телефона.
2. Получает 6-значный код в Telegram (через Edge Function).
3. Приложение подтверждает код и авторизует пользователя.

### 1.2 Выбор рабочего пространства (Onboarding)
После первого входа пользователь **обязан** выбрать один из двух путей:
1. **Создать компанию**: Пользователь вводит данные организации и автоматически становится её **Owner** (Владельцем).
2. **Вступить по приглашению**: Если пользователя пригласили (через Email/код), он принимает приглашение и получает роль, назначенную владельцем той компании.

> **Важно:** Больше нет ручного «одобрения администратором платформы». Доступ в систему открыт, но данные изолированы внутри компаний.

---

## 2. Структура ролей (RBAC)

### 2.1 Системные роли (внутри компании)
Доступ определяется в `company_members.system_role`:
- **Owner**: Создатель компании. Полный доступ, управление подпиской и админами.
- **Admin**: Помощник владельца (лимит 2 чел). Полный доступ к модулям, но без права удаления компании.

### 2.2 Кастомные роли
Создаются владельцем компании (например, "Прораб", "Бухгалтер") на основе атомарных прав (Permissions).

### 2.3 Legacy (Устарело)
Поля `role` (`user`/`admin`) и `status` в таблице `profiles` являются устаревшими и используются только для обратной совместимости. **Не использовать в новом коде.**

---

## 3. Технические детали

### 3.1 Состояния аутентификации
```dart
enum AuthStatus {
  initial,        // Начальное состояние
  authenticated,  // Аутентифицирован (есть сессия Supabase)
  unauthenticated, // Не аутентифицирован
  loading,        // Загрузка
  error,          // Ошибка
}
```

### 3.2 Модель профиля (domain/entities/profile.dart)
```dart
class Profile {
  final String id;
  final String email;
  final String? fullName;
  final String? phone;
  final String? lastCompanyId; // ID последней выбранной компании
  // ... остальные поля метаданных
}
```

### 3.3 Защита маршрутов
Система маршрутизации в `lib/core/common/app_router.dart` проверяет:
1. Наличие активной сессии.
2. Наличие записи в `company_members` для текущей выбранной компании.

---

## 4. Безопасность
- **Никаких service role ключей на клиенте.**
- **Изоляция профилей**: Пользователь видит только свои данные и данные коллег по компании (Coworkers only RLS).
- Все проверки прав на чтение/запись данных выполняются на стороне базы данных через **Supabase RLS** и функцию `get_my_company_ids()`.
- Подробное описание модели доступа: `docs/architecture/rbac.md`.
