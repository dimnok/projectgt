# ะกะธััะตะผะฐ Push-ัะฒะตะดะพะผะปะตะฝะธะน ะดะปั ะฐะดะผะธะฝะธัััะฐัะพัะพะฒ

**ะะฐัะฐ ะฐะบััะฐะปะธะทะฐัะธะธ:** 11 ะพะบััะฑัั 2025 ะณะพะดะฐ (ะพะฑะฝะพะฒะปะตะฝะพ: ะดะพะฑะฐะฒะปะตะฝะพ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ััะผะผ ั ะฟัะพะฑะตะปะฐะผะธ)

## ะะฑะทะพั

ะ ProjectGT ัะตะฐะปะธะทะพะฒะฐะฝะฐ ัะธััะตะผะฐ push-ัะฒะตะดะพะผะปะตะฝะธะน ะดะปั ะฐะดะผะธะฝะธัััะฐัะพัะพะฒ ะพ ัะพะฑััะธัั ะพัะบัััะธั ะธ ะทะฐะบัััะธั ัะผะตะฝ. ะกะธััะตะผะฐ ะฟะพัััะพะตะฝะฐ ะฝะฐ Firebase Cloud Messaging (FCM) API v1 ะธ Supabase Edge Functions.

**ะกัะฐััั:** โ ะะะขะะะะ. ะะธะฝะธะผะฐะปัะฝะฐั ััะตะผะฐ ัะฐะทะฒะตัะฝััะฐ ะธ ัะฐะฑะพัะฐะตั ะฒ production-ััะตะดะต FCM HTTP v1.

**ะะตััะธั Edge Function:** v32 (ั ัะพัะผะฐัะธัะพะฒะฐะฝะธะตะผ ััะผะผ)

**ะะพัะปะตะดะฝัั ัะฒะพะดะบะฐ:** admin_count=1, raw_tokens_count=1, tokens_total=1, sent=1.

## ะะปััะตะฒัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. **Flutter-ะบะปะธะตะฝั**
- `lib/data/services/fcm_token_service.dart` โ ัะฟัะฐะฒะปะตะฝะธะต FCM ัะพะบะตะฝะฐะผะธ
- `lib/main.dart` โ ะธะฝะธัะธะฐะปะธะทะฐัะธั Firebase ะธ ัะพะฝะพะฒัั ะพะฑัะฐะฑะพััะธะบะพะฒ
- `lib/features/works/presentation/screens/work_form_screen.dart` โ ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฟัะธ ะพัะบัััะธะธ ัะผะตะฝั
- `lib/features/works/presentation/screens/tabs/work_data_tab.dart` โ ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฟัะธ ะทะฐะบัััะธะธ ัะผะตะฝั

### 2. **ะะฐะทะฐ ะดะฐะฝะฝัั**
- ะขะฐะฑะปะธัะฐ `public.user_tokens` โ ััะฐะฝะตะฝะธะต FCM ัะพะบะตะฝะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- ะขะฐะฑะปะธัะฐ `public.profiles` โ ะธะฝัะพัะผะฐัะธั ะพ ะฟะพะปัะทะพะฒะฐัะตะปัั ะธ ะธั ัะพะปัั

### 3. **Backend (Supabase Edge Functions)**
- `send_admin_work_event` โ ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฐะดะผะธะฝะฐะผ ะพ ัะพะฑััะธัั ัะผะตะฝั
- `send-fcm` โ ะฝะธะทะบะพััะพะฒะฝะตะฒะฐั ะพัะฟัะฐะฒะบะฐ FCM ัะพะพะฑัะตะฝะธะน ัะตัะตะท API v1

## ะััะธัะตะบัััะฐ ัะธััะตะผั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        Flutter Client                            โ
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ               โ
โ  โ FcmTokenService โโโโโโโโโโถโ  Firebase SDK    โ               โ
โ  โ  - init()       โ         โ  - getToken()    โ               โ
โ  โ  - saveToken()  โ         โ  - onTokenRefreshโ               โ
โ  โโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ               โ
โ           โ                                                       โ
โ           โ save token                                           โ
โ           โผ                                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ  โ  User opens/closes shift                    โ                โ
โ  โ  โ invoke('send_admin_work_event')          โ                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ HTTPS
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      Supabase Backend                            โ
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ  โ    Edge Function: send_admin_work_event     โ                โ
โ  โ                                              โ                โ
โ  โ  1. ะะพะปััะฐะตั work_id ะธ action               โ                โ
โ  โ  2. ะงะธัะฐะตั ะดะฐะฝะฝัะต ัะผะตะฝั ะธะท ะะ               โ                โ
โ  โ  3. ะะฐัะพะดะธั ะฒัะตั ะฐะดะผะธะฝะพะฒ (role='admin')     โ                โ
โ  โ  4. ะะพะปััะฐะตั ะฐะบัะธะฒะฝัะต ัะพะบะตะฝั ะฐะดะผะธะฝะพะฒ        โ                โ
โ  โ  5. ะคะพัะผะธััะตั notification payload          โ                โ
โ  โ  6. ะัะฟัะฐะฒะปัะตั ัะตัะตะท FCM API v1             โ                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ           โ                          โฒ                           โ
โ           โ                          โ                           โ
โ           โผ                          โ                           โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโ               โ
โ  โ  user_tokens    โ    โ      profiles        โ               โ
โ  โ  - token        โ    โ  - role = 'admin'    โ               โ
โ  โ  - platform     โ    โ  - status = true     โ               โ
โ  โ  - is_active    โ    โโโโโโโโโโโโโโโโโโโโโโโโ               โ
โ  โโโโโโโโโโโโโโโโโโโ                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ FCM API v1
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   Firebase Cloud Messaging                       โ
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ  โ  FCM ะพัะฟัะฐะฒะปัะตั push-ัะฒะตะดะพะผะปะตะฝะธั ะฝะฐ        โ                 โ
โ  โ  ััััะพะนััะฒะฐ ะฐะดะผะธะฝะพะฒ (iOS/Android)          โ                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะะตัะฐะปัะฝัะน ะฟัะพัะตัั ัะฐะฑะพัั

### ะญัะฐะฟ 1: ะะตะณะธัััะฐัะธั FCM ัะพะบะตะฝะพะฒ

#### 1.1. ะะฝะธัะธะฐะปะธะทะฐัะธั Firebase (ะฟัะธ ะทะฐะฟััะบะต ะฟัะธะปะพะถะตะฝะธั)

**ะคะฐะนะป:** `lib/main.dart`

```dart
// ะะฝะธัะธะฐะปะธะทะฐัะธั Firebase ั ะพะฟัะธัะผะธ ะดะปั ัะตะบััะตะน ะฟะปะฐััะพัะผั
await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);

// ะะตะณะธัััะฐัะธั ัะพะฝะพะฒะพะณะพ ะพะฑัะฐะฑะพััะธะบะฐ ัะพะพะฑัะตะฝะธะน FCM
FirebaseMessaging.onBackgroundMessage(firebaseMessagingBackgroundHandler);

// ะะพะบะฐะท ัะฒะตะดะพะผะปะตะฝะธะน ะฒ ัะพัะณัะฐัะฝะดะต ะฝะฐ iOS/macOS
await FirebaseMessaging.instance.setForegroundNotificationPresentationOptions(
  alert: true,
  badge: true,
  sound: true,
);
```

#### 1.2. ะะฝะธัะธะฐะปะธะทะฐัะธั FcmTokenService

**ะคะฐะนะป:** `lib/main.dart` (ะฒะฝัััะธ MyApp)

```dart
// FCM: ัะตะณะธัััะธััะตะผ ัะพะบะตะฝ ะฟัะธ ะทะฐะฟััะบะต
WidgetsBinding.instance.addPostFrameCallback((_) {
  ref.read(fcmTokenServiceProvider).initialize();
});
```

#### 1.3. ะะพะปััะตะฝะธะต ะธ ัะพััะฐะฝะตะฝะธะต ัะพะบะตะฝะฐ

**ะคะฐะนะป:** `lib/data/services/fcm_token_service.dart`

ะัะพัะตัั:

1. **ะะฐะฟัะพั ัะฐะทัะตัะตะฝะธะน** ะฝะฐ push-ัะฒะตะดะพะผะปะตะฝะธั (iOS/Android)
   ```dart
   await FirebaseMessaging.instance.requestPermission(
     alert: true,
     badge: true,
     sound: true,
   );
   ```

2. **ะะพะปััะตะฝะธะต FCM ัะพะบะตะฝะฐ** ะพั Firebase
   ```dart
   final String? token = await FirebaseMessaging.instance.getToken(
     vapidKey: kIsWeb ? 'YOUR_VAPID_KEY' : null,
   );
   ```

3. **ะะพะปััะตะฝะธะต Installation ID** ะดะปั ัะฝะธะบะฐะปัะฝะพะน ะฟัะธะฒัะทะบะธ ััััะพะนััะฒะฐ
   ```dart
   String? installationId = await FirebaseInstallations.instance.getId();
   ```

4. **ะกะพััะฐะฝะตะฝะธะต ะฒ ัะฐะฑะปะธัั `user_tokens`**
   ```dart
   await Supabase.instance.client.from('user_tokens').upsert(
     {
       'user_id': user.id,
       'token': token,
       'platform': platform, // 'ios', 'android', 'web'
       'installation_id': installationId,
       'is_active': true,
       'updated_at': DateTime.now().toIso8601String(),
     },
     onConflict: 'installation_id,platform',
   );
   ```

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะดะฝะฐ ะทะฐะฟะธัั ะฝะฐ ัััะฐะฝะพะฒะบั/ะฟะปะฐััะพัะผั ะทะฐ ัััั `UNIQUE (installation_id, platform)`
- ะัะธ ัะผะตะฝะต ัะพะบะตะฝะฐ ัััะพะบะฐ ะพะฑะฝะพะฒะปัะตััั (ะฝะต ัะพะทะดะฐัััั ะฝะพะฒะฐั)
- ะัะธ ัะผะตะฝะต ะฟะพะปัะทะพะฒะฐัะตะปั ัะพะบะตะฝ ะฟะตัะตะฟัะธะฒัะทัะฒะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
- ะัะธ ะฒััะพะดะต ะธะท ะฐะบะบะฐัะฝัะฐ ัะพะบะตะฝ ะฟะพะผะตัะฐะตััั ะบะฐะบ `is_active=false`

#### 1.4. ะะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะฐ

```dart
// ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ัะพะบะตะฝะฐ (ั debounce 1 ัะตะบ)
FirebaseMessaging.instance.onTokenRefresh.listen((token) async {
  pendingToken = token;
  await Future<void>.delayed(const Duration(seconds: 1));
  _saveToken(token);
});
```

### ะญัะฐะฟ 2: ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฟัะธ ัะพะฑััะธัั ัะผะตะฝั

#### 2.1. ะัะบัััะธะต ัะผะตะฝั

**ะคะฐะนะป:** `lib/features/works/presentation/screens/work_form_screen.dart`

**ะขัะธะณะณะตั:** ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะบะฝะพะฟะบั "ะัะบัััั ัะผะตะฝั"

```dart
// ะัะฟัะฐะฒะบะฐ PUSH ะฐะดะผะธะฝะฐะผ ะพ ะพัะบัััะธะธ ัะผะตะฝั ัะตัะตะท Edge Function
try {
  final supabase = ref.read(supabaseClientProvider);
  final accessToken = supabase.auth.currentSession?.accessToken;
  
  if (accessToken != null) {
    final resp = await supabase.functions.invoke(
      'send_admin_work_event',
      body: {
        'action': 'open',
        'work_id': createdWork.id!,
      },
      headers: {
        'Authorization': 'Bearer $accessToken',
      },
    );
    
    debugPrint('send_admin_work_event(open): status=${resp.status}, data=${resp.data}');
  }
} catch (_) {
  // ะะต ะฑะปะพะบะธััะตะผ UX ะธะท-ะทะฐ ัะฒะตะดะพะผะปะตะฝะธั
}
```

#### 2.2. ะะฐะบัััะธะต ัะผะตะฝั

**ะคะฐะนะป:** `lib/features/works/presentation/screens/tabs/work_data_tab.dart`

**ะขัะธะณะณะตั:** ะะพะปัะทะพะฒะฐัะตะปั ะฟะพะดัะฒะตัะถะดะฐะตั ะทะฐะบัััะธะต ัะผะตะฝั

```dart
// ะัะฟัะฐะฒะบะฐ PUSH ะฐะดะผะธะฝะฐะผ ะพ ะทะฐะบัััะธะธ ัะผะตะฝั
try {
  if (updatedWork.id != null) {
    final token = Supabase.instance.client.auth.currentSession?.accessToken;
    
    if (token != null) {
      await Supabase.instance.client.functions.invoke(
        'send_admin_work_event',
        body: {
          'action': 'close',
          'work_id': updatedWork.id!
        },
        headers: {
          'Authorization': 'Bearer $token'
        },
      );
    }
  }
} catch (_) {
  // ะะต ะฑะปะพะบะธััะตะผ UX
}
```

### ะญัะฐะฟ 3: ะะฑัะฐะฑะพัะบะฐ ะฝะฐ ัะตัะฒะตัะต (Edge Function)

**Edge Function:** `send_admin_work_event` (v32)

**ะะฐัััะพะนะบะธ:**
- `verify_jwt=true` โ ััะตะฑัะตััั JWT ัะพะบะตะฝ ะฐะฒัะพัะธะทะฐัะธะธ
- CORS ะฒะบะปัััะฝ
- ะัะฟะพะปัะทัะตั `SERVICE_ROLE_KEY` ะดะปั ะพะฑัะพะดะฐ RLS ะฟัะธ ััะตะฝะธะธ ะะ
- ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ััะผะผ ั ัะฐะทะดะตะปะธัะตะปัะผะธ ััััั (ะฟัะพะฑะตะปะฐะผะธ) ะธ ัะธะผะฒะพะปะพะผ โฝ

**ะะปะณะพัะธัะผ ัะฐะฑะพัั:**

1. **ะะฐะปะธะดะฐัะธั ะฒัะพะดะฝัั ะดะฐะฝะฝัั**
   ```javascript
   const { action, work_id } = await req.json();
   // action: 'open' | 'close'
   // work_id: UUID
   ```

2. **ะงัะตะฝะธะต ะดะฐะฝะฝัั ัะผะตะฝั ะธะท ะะ**
   - ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ัะผะตะฝะต (`works`)
   - ะะพะปััะตะฝะธะต ะพะฑัะตะบัะฐ (`objects`)
   - ะะพะปััะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั, ะพัะบััะฒัะตะณะพ ัะผะตะฝั (`profiles`)
   - ะะพะดัััั ัะพัััะดะฝะธะบะพะฒ (`work_hours`)
   - ะะพะดัััั ััะผะผั ะธ ะฒััะฐะฑะพัะบะธ (ะดะปั ะทะฐะบัััะธั)

3. **ะะพะธัะบ ะฒัะตั ะฐะดะผะธะฝะธัััะฐัะพัะพะฒ**
   ```sql
   SELECT id, email 
   FROM profiles 
   WHERE role = 'admin' 
     AND (status = true OR status IS NULL)
   ```

4. **ะะพะปััะตะฝะธะต ะฐะบัะธะฒะฝัั ัะพะบะตะฝะพะฒ ะฐะดะผะธะฝะพะฒ**
   ```sql
   SELECT token, platform 
   FROM user_tokens 
   WHERE user_id IN (admin_ids)
     AND is_active = true
     AND platform IN ('ios', 'android')
   ```

5. **ะคะพัะผะธัะพะฒะฐะฝะธะต notification payload**

6. **ะัะฟัะฐะฒะบะฐ ัะตัะตะท FCM HTTP v1 API**
   ```javascript
   await fetch('https://fcm.googleapis.com/v1/projects/pgtmess/messages:send', {
     method: 'POST',
     headers: {
       'Authorization': `Bearer ${accessToken}`,
       'Content-Type': 'application/json',
     },
     body: JSON.stringify({ message: fcmMessage }),
   });
   ```

7. **ะะพะทะฒัะฐั ัะตะทัะปััะฐัะฐ**
   ```json
   {
     "sent": 1,
     "total": 1,
     "admin_count": 1,
     "raw_tokens_count": 1,
     "tokens_total": 1
   }
   ```

### ะญัะฐะฟ 4: ะะพััะฐะฒะบะฐ push-ัะฒะตะดะพะผะปะตะฝะธะน

Firebase Cloud Messaging ะดะพััะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธั ะฝะฐ ััััะพะนััะฒะฐ ะฐะดะผะธะฝะธัััะฐัะพัะพะฒ ัะตัะตะท:
- **APNs** (Apple Push Notification service) ะดะปั iOS
- **FCM** (Firebase Cloud Messaging) ะดะปั Android
- **Web Push** ะดะปั ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะน

## ะัะธะผะตัั ัะฒะตะดะพะผะปะตะฝะธะน

### ะัะบัััะธะต ัะผะตะฝั

```text
Title: ๐ ะกะผะตะฝะฐ - ะะขะะะซะขะ

Body:
๐ ะะฑัะตะบั: ะขะฆ "ะะฐะปะตัะตั"
๐ค ะะพะปัะทะพะฒะฐัะตะปั: ะะฒะฐะฝ ะะฒะฐะฝะพะฒ
๐ฅ ะกะพัััะดะฝะธะบะพะฒ: 5
```

**ะะพะด ัะพัะผะธัะพะฒะฐะฝะธั (Edge Function):**
```javascript
{
  notification: {
    title: '๐ ะกะผะตะฝะฐ - ะะขะะะซะขะ',
    body: `๐ ะะฑัะตะบั: ${objectName}\n๐ค ะะพะปัะทะพะฒะฐัะตะปั: ${userName}\n๐ฅ ะกะพัััะดะฝะธะบะพะฒ: ${employeesCount}`
  },
  data: {
    type: 'work_event',
    action: 'open',
    work_id: workId,
    object_id: objectId,
    employees_count: employeesCount.toString()
  },
  apns: {
    payload: {
      aps: {
        sound: 'default',
        badge: 1
      }
    }
  },
  android: {
    priority: 'high',
    notification: {
      sound: 'default',
      channelId: 'work_events'
    }
  }
}
```

### ะะฐะบัััะธะต ัะผะตะฝั

```text
Title: ๐ ะกะผะตะฝะฐ - ะะะะะซะขะ

Body:
๐ ะะฑัะตะบั: ะขะฆ "ะะฐะปะตัะตั"
๐ค ะะพะปัะทะพะฒะฐัะตะปั: ะะฒะฐะฝ ะะฒะฐะฝะพะฒ
๐ฐ ะกัะผะผะฐ: 125 000 โฝ
โ๏ธ ะััะฐะฑะพัะบะฐ: 25 000 โฝ
```

**ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ััะผะผ:**
```javascript
// ะคัะฝะบัะธั ัะพัะผะฐัะธัะพะฒะฐะฝะธั: 245766 -> "245 766 โฝ"
const formatCurrency = (num) => {
  const rounded = Math.round(num);
  const formatted = rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  return `${formatted} โฝ`;
};
```

**ะะฐัััั ะฒััะฐะฑะพัะบะธ:**
```javascript
// ะััะฐะฑะพัะบะฐ = ะกัะผะผะฐ / ะะพะปะธัะตััะฒะพ ัะพัััะดะฝะธะบะพะฒ
const production = employeesCount > 0 ? sumRaw / employeesCount : 0;
```

**ะะพะด ัะพัะผะธัะพะฒะฐะฝะธั (Edge Function):**
```javascript
{
  notification: {
    title: '๐ ะกะผะตะฝะฐ - ะะะะะซะขะ',
    body: `๐ ะะฑัะตะบั: ${objectName}\n๐ค ะะพะปัะทะพะฒะฐัะตะปั: ${userName}\n๐ฐ ะกัะผะผะฐ: ${formatCurrency(sum)}\nโ๏ธ ะััะฐะฑะพัะบะฐ: ${formatCurrency(production)}`
  },
  data: {
    type: 'work_event',
    action: 'close',
    work_id: workId,
    object_id: objectId,
    employees_count: employeesCount.toString(),
    sum: sum.toString(),
    production: production.toString()
  },
  apns: {
    payload: {
      aps: {
        sound: 'default',
        badge: 1
      }
    }
  },
  android: {
    priority: 'high',
    notification: {
      sound: 'default',
      channelId: 'work_events'
    }
  }
}
```

## ะกัััะบัััะฐ ะฑะฐะทั ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัะฐ `public.user_tokens`

ะฅัะฐะฝะธั FCM ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะดะปั push-ัะฒะตะดะพะผะปะตะฝะธะน.

**ะะพะปะธัะตััะฒะพ ะทะฐะฟะธัะตะน:** ะทะฐะฒะธัะธั ะพั ะบะพะปะธัะตััะฒะฐ ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

**RLS:** โ ะะบะปัััะฝ

| ะะพะปะพะฝะบะฐ          | ะขะธะฟ          | ะะฟะธัะฐะฝะธะต                                    | ะะณัะฐะฝะธัะตะฝะธั        |
|------------------|--------------|---------------------------------------------|--------------------|
| id               | uuid         | ะฃะฝะธะบะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั ะทะฐะฟะธัะธ            | PRIMARY KEY        |
| user_id          | uuid         | ID ะฟะพะปัะทะพะฒะฐัะตะปั                             | FK auth.users(id)  |
| token            | text         | FCM ัะพะบะตะฝ ััััะพะนััะฒะฐ                        | NOT NULL, UNIQUE   |
| platform         | text         | ะะปะฐััะพัะผะฐ (ios/android/web)                 | NOT NULL, CHECK    |
| installation_id  | text         | ID ัััะฐะฝะพะฒะบะธ Firebase                       | -                  |
| is_active        | boolean      | ะะบัะธะฒะตะฝ ะปะธ ัะพะบะตะฝ                            | DEFAULT true       |
| device_id        | text         | ID ััััะพะนััะฒะฐ                               | -                  |
| device_model     | text         | ะะพะดะตะปั ััััะพะนััะฒะฐ                           | -                  |
| os_version       | text         | ะะตััะธั ะะก                                   | -                  |
| app_version      | text         | ะะตััะธั ะฟัะธะปะพะถะตะฝะธั                           | -                  |
| created_at       | timestamptz  | ะะฐัะฐ ัะพะทะดะฐะฝะธั                               | DEFAULT now()      |
| updated_at       | timestamptz  | ะะฐัะฐ ะพะฑะฝะพะฒะปะตะฝะธั                             | DEFAULT now()      |

**ะะฝะดะตะบัั:**
```sql
CREATE UNIQUE INDEX user_tokens_token_unique ON user_tokens(token);
CREATE UNIQUE INDEX user_tokens_installation_platform_unique ON user_tokens(installation_id, platform);
CREATE INDEX user_tokens_user_id_idx ON user_tokens(user_id);
CREATE INDEX user_tokens_active_idx ON user_tokens(is_active);
```

**ะขัะธะณะณะตัั:**
```sql
-- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต updated_at
CREATE TRIGGER user_tokens_set_updated_at
BEFORE UPDATE ON user_tokens
FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```

**RLS ะะพะปะธัะธะบะธ:**
```sql
-- ะะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ะฒะธะดะตัั ัะพะปัะบะพ ัะฒะพะธ ัะพะบะตะฝั
CREATE POLICY "Users can view own tokens"
  ON user_tokens FOR SELECT
  USING (auth.uid() = user_id);

-- ะะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ะดะพะฑะฐะฒะปััั ัะพะปัะบะพ ัะฒะพะธ ัะพะบะตะฝั
CREATE POLICY "Users can insert own tokens"
  ON user_tokens FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- ะะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ะพะฑะฝะพะฒะปััั ัะพะปัะบะพ ัะฒะพะธ ัะพะบะตะฝั
CREATE POLICY "Users can update own tokens"
  ON user_tokens FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- ะะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ัะดะฐะปััั ัะพะปัะบะพ ัะฒะพะธ ัะพะบะตะฝั
CREATE POLICY "Users can delete own tokens"
  ON user_tokens FOR DELETE
  USING (auth.uid() = user_id);
```

**โ๏ธ ะะฐะถะฝะพ:** Edge Function ะธัะฟะพะปัะทัะตั `SERVICE_ROLE_KEY` ะดะปั ะพะฑัะพะดะฐ RLS ะฟัะธ ััะตะฝะธะธ ัะพะบะตะฝะพะฒ ะฒัะตั ะฐะดะผะธะฝะพะฒ.

### ะกะฒัะทั ั ัะฐะฑะปะธัะตะน `profiles`

```
profiles (1) โโโโโโ< user_tokens (N)
  โ
  โโโ id (PK)
  โ
  โโโ role = 'admin'  โโโ ะคะธะปััั ะดะปั ะฟะพะปััะฐัะตะปะตะน ัะฒะตะดะพะผะปะตะฝะธะน
      status = true/NULL
```

## ะะพะฝัะธะณััะฐัะธั Firebase

### ะัะพะตะบั Firebase
- **Project ID:** `pgtmess`
- **ะกัะฐััั:** ACTIVE

### iOS
- **Bundle ID:** `dev.projectgt.projectgt`
- **Team ID:** `L37HR2KV4M`
- **APNs Authentication Key:** `.p8` ัะฐะนะป ะทะฐะณััะถะตะฝ
  - **Key ID:** `TYMLTYTH4P`
  - **Scope:** Sandbox & Production
- **Entitlements:** `aps-environment: production`
- **Config:** `ios/Runner/GoogleService-Info.plist`

### Android
- **Package:** `dev.projectgt.projectgt`
- **Config:** `android/app/google-services.json`
- **Min SDK:** 23

### Web
- **VAPID Key:** `BGPPZr58sdNUlGT4RFTLiteNdyOxQWI9mJdxnP4ycqEA0qUrGh6sDRKdkvXN6O1jpdmeH1ETcwn8ePeTPocORW4`
- **Service Worker:** `web/firebase-messaging-sw.js`

## ะกะตะบัะตัั Supabase

ะะปั ัะฐะฑะพัั Edge Functions ััะตะฑััััั ัะปะตะดัััะธะต ัะตะบัะตัั (Supabase Dashboard โ Project Settings โ Edge Functions โ Secrets):

1. **SERVICE_ACCOUNT** โ JSON-ัะฐะนะป ัะตัะฒะธัะฝะพะณะพ ะฐะบะบะฐัะฝัะฐ Firebase ะดะปั FCM HTTP v1 API
   ```json
   {
     "type": "service_account",
     "project_id": "pgtmess",
     "private_key_id": "...",
     "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
     "client_email": "firebase-adminsdk-...@pgtmess.iam.gserviceaccount.com",
     "client_id": "...",
     "auth_uri": "https://accounts.google.com/o/oauth2/auth",
     "token_uri": "https://oauth2.googleapis.com/token",
     "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
     "client_x509_cert_url": "..."
   }
   ```

2. **SERVICE_ROLE_KEY** โ ะะปัั ัะตัะฒะตัะฐ Supabase ะดะปั ะพะฑัะพะดะฐ RLS ะฟัะธ ััะตะฝะธะธ `profiles` ะธ `user_tokens`

## ะะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผ

### ะัะพะฑะปะตะผะฐ: `tokens_total: 0` (ัะพะบะตะฝั ะฝะต ะฝะฐะนะดะตะฝั)

**ะัะธัะธะฝั ะธ ัะตัะตะฝะธั:**

1. **ะะปะธะตะฝั ะฝะต ะฟะตัะตะดะฐัั Authorization header**
   ```dart
   // โ ะัะฐะฒะธะปัะฝะพ:
   headers: {
     'Authorization': 'Bearer $accessToken',
   }
   ```

2. **ะฃ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะตั ัะพะปะธ admin**
   ```sql
   -- ะัะพะฒะตัะบะฐ ะฒ ะะ:
   SELECT id, email, role, status 
   FROM profiles 
   WHERE role = 'admin';
   ```

3. **ะะตั ะฐะบัะธะฒะฝัั ัะพะบะตะฝะพะฒ ะฒ user_tokens**
   ```sql
   -- ะัะพะฒะตัะบะฐ ัะพะบะตะฝะพะฒ ะฐะดะผะธะฝะฐ:
   SELECT * 
   FROM user_tokens 
   WHERE user_id = '<admin_user_id>' 
     AND is_active = true;
   ```

4. **ะกะตะบัะตัั ะฝะต ัััะฐะฝะพะฒะปะตะฝั ะฒ Supabase**
   - ะัะพะฒะตัะธัั ะฝะฐะปะธัะธะต `SERVICE_ACCOUNT` ะธ `SERVICE_ROLE_KEY`
   - ะะตัะตะทะฐะฟัััะธัั Edge Functions ะฟะพัะปะต ัััะฐะฝะพะฒะบะธ ัะตะบัะตัะพะฒ

5. **iOS: ะฝะตัะพะพัะฒะตัััะฒะธะต ััะตะดั APNs**
   - Debug build ััะตะฑัะตั Sandbox APNs
   - Ad Hoc/TestFlight/App Store ััะตะฑััั Production APNs
   - ะฃะฑะตะดะธัััั, ััะพ `.p8` ะบะปัั ะฟะพะดะดะตัะถะธะฒะฐะตั ะฝัะถะฝัั ััะตะดั

### ะัะพะฑะปะตะผะฐ: ะฃะฒะตะดะพะผะปะตะฝะธั ะฝะต ะฟัะธัะพะดัั ะฝะฐ ััััะพะนััะฒะพ

1. **ะัะพะฒะตัะบะฐ FCM ัะพะบะตะฝะฐ**
   ```dart
   // ะะพะฑะฐะฒะธัั ะปะพะณะธัะพะฒะฐะฝะธะต:
   final token = await FirebaseMessaging.instance.getToken();
   debugPrint('FCM Token: $token');
   ```

2. **ะัะพะฒะตัะบะฐ ัะฐะทัะตัะตะฝะธะน ะฝะฐ ัะฒะตะดะพะผะปะตะฝะธั**
   ```dart
   final settings = await FirebaseMessaging.instance.getNotificationSettings();
   debugPrint('Authorization status: ${settings.authorizationStatus}');
   // AuthorizationStatus.authorized - ัะฐะทัะตัะตะฝะพ
   // AuthorizationStatus.denied - ะทะฐะฟัะตัะตะฝะพ
   ```

3. **ะขะตัั ะพัะฟัะฐะฒะบะธ ะฝะฐะฟััะผัั ัะตัะตะท FCM**
   - ะัะฟะพะปัะทะพะฒะฐัั Firebase Console โ Cloud Messaging โ Send test message
   - ะััะฐะฒะธัั ัะพะบะตะฝ ััััะพะนััะฒะฐ ะธ ะพัะฟัะฐะฒะธัั ัะตััะพะฒะพะต ัะพะพะฑัะตะฝะธะต

4. **ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ Edge Function**
   ```bash
   # ะ Supabase Dashboard โ Edge Functions โ Logs
   # ะัะบะฐัั ัััะพะบะธ:
   # - "start" - ััะฝะบัะธั ะทะฐะฟััะตะฝะฐ
   # - "no_tokens" - ัะพะบะตะฝั ะฝะต ะฝะฐะนะดะตะฝั
   # - "summary" - ะธัะพะณะพะฒะฐั ััะฐัะธััะธะบะฐ ะพัะฟัะฐะฒะบะธ
   ```

### ะัะพะฑะปะตะผะฐ: ะัะฑะปะธัะพะฒะฐะฝะธะต ัะพะบะตะฝะพะฒ

**ะะตัะตะฝะธะต:** ะฃะถะต ัะตะฐะปะธะทะพะฒะฐะฝะพ ัะตัะตะท ัะฝะธะบะฐะปัะฝะพััั `(installation_id, platform)`:
```dart
// ะัะธ ัะพััะฐะฝะตะฝะธะธ ัะพะบะตะฝะฐ ัะฝะฐัะฐะปะฐ ะดะตะฐะบัะธะฒะธัััััั ััะฐััะต ะทะฐะฟะธัะธ ััะพะน ัััะฐะฝะพะฒะบะธ:
await Supabase.instance.client
  .from('user_tokens')
  .update({'is_active': false})
  .eq('installation_id', installationId)
  .eq('platform', platform)
  .neq('token', token);
```

## ะะณัะฐะฝะธัะตะฝะธั ะธ ะพัะพะฑะตะฝะฝะพััะธ

### ะะฑะปะฐััั ะฟัะธะผะตะฝะตะฝะธั
- โ ะัะฟัะฐะฒะปัะตะผ PUSH **ัะพะปัะบะพ ะฐะดะผะธะฝะฐะผ** (`profiles.role='admin'`)
- โ ะขะพะปัะบะพ ะฐะบัะธะฒะฝัะผ ะฐะดะผะธะฝะฐะผ (`status=true` ะธะปะธ `status IS NULL`)
- โ ะะพะดะดะตัะถะธะฒะฐะตะผ ะฟะปะฐััะพัะผั **iOS** ะธ **Android**
- โ๏ธ **Web** ัะพะบะตะฝั ะธะณะฝะพัะธัััััั Edge Function (ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ)

### ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน **ะฝะต ะฑะปะพะบะธััะตั UX**
- ะัะธะฑะบะธ ะพัะฟัะฐะฒะบะธ **ะผะพะปัะฐ ะธะณะฝะพัะธัััััั** (try-catch ะฑะตะท re-throw)
- ะะตะฑะฐัะฝั 1 ัะตะบัะฝะดะฐ ะดะปั `onTokenRefresh` ะฟัะตะดะพัะฒัะฐัะฐะตั ะดัะฑะปะธะบะฐัั

### ะะตะทะพะฟะฐัะฝะพััั
- JWT ัะพะบะตะฝ **ะพะฑัะทะฐัะตะปะตะฝ** (`verify_jwt=true`)
- RLS ะฝะฐ `user_tokens` ะทะฐัะธัะฐะตั ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- Edge Function ะธัะฟะพะปัะทัะตั `SERVICE_ROLE_KEY` ัะพะปัะบะพ ะดะปั ััะตะฝะธั ะฐะดะผะธะฝัะบะธั ัะพะบะตะฝะพะฒ

## ะะปะฐะฝั ัะฐะทะฒะธัะธั

### โ ะะตะฐะปะธะทะพะฒะฐะฝะพ
- [x] ะะฐะทะพะฒะฐั ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฟัะธ ะพัะบัััะธะธ/ะทะฐะบัััะธะธ ัะผะตะฝั
- [x] FCM ัะพะบะตะฝั ั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ัะธะฝััะพะฝะธะทะฐัะธะตะน
- [x] ะฃะฝะธะบะฐะปัะฝะพััั ัะพะบะตะฝะพะฒ ะฟะพ `(installation_id, platform)`
- [x] ะะตัะตะฟัะธะฒัะทะบะฐ ัะพะบะตะฝะพะฒ ะฟัะธ ัะผะตะฝะต ะฟะพะปัะทะพะฒะฐัะตะปั
- [x] ะะตะฐะบัะธะฒะฐัะธั ัะพะบะตะฝะพะฒ ะฟัะธ logout
- [x] ะคะธะปัััะฐัะธั ะฟะพ ัะพะปัะผ (ัะพะปัะบะพ ะฐะดะผะธะฝั)
- [x] ะะพะดะดะตัะถะบะฐ iOS (Production APNs) ะธ Android
- [x] ะะพะดัะพะฑะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะฒ Edge Function
- [x] ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ะดะตะฝะตะถะฝัั ััะผะผ ั ะฟัะพะฑะตะปะฐะผะธ (245 766 โฝ)

### ๐ ะะปะฐะฝะธััะตััั
- [ ] ะะพะบะฐะท SnackBar ั ัะตะทัะปััะฐัะพะผ ะพัะฟัะฐะฒะบะธ (`{sent}/{total}`)
- [ ] ะะฐัััะพะนะบะธ ัะฒะตะดะพะผะปะตะฝะธะน ะดะปั ะฐะดะผะธะฝะพะฒ (ะฒะบะปััะธัั/ะพัะบะปััะธัั)
- [ ] ะััะฟะฟะธัะพะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน (ะตัะปะธ ะฝะตัะบะพะปัะบะพ ัะผะตะฝ ะทะฐ ะบะพัะพัะบะพะต ะฒัะตะผั)
- [ ] ะัะปะพะถะตะฝะฝัะต ัะฒะตะดะพะผะปะตะฝะธั (ะฝะฐะฟัะธะผะตั, ะฝะฐะฟะพะผะธะฝะฐะฝะธะต ะทะฐะบัััั ัะผะตะฝั)
- [ ] ะะพะณะฐััะต ัะฒะตะดะพะผะปะตะฝะธั ั ะบะฐััะธะฝะบะฐะผะธ ะพะฑัะตะบัะพะฒ
- [ ] ะะตะนััะฒะธั ะฒ ัะฒะตะดะพะผะปะตะฝะธัั ("ะัะบัััั ัะผะตะฝั", "ะะณะฝะพัะธัะพะฒะฐัั")
- [ ] ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ะดััะณะธั ัะพะฑััะธัั (ะฝะพะฒัะน ัะพัััะดะฝะธะบ, ะผะฐัะตัะธะฐะปั ะธ ั.ะด.)
- [ ] ะะพะดะดะตัะถะบะฐ Web push-ัะฒะตะดะพะผะปะตะฝะธะน ะดะปั ะฐะดะผะธะฝะพะฒ
- [ ] ะกัะฐัะธััะธะบะฐ ะดะพััะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธะน ะฒ ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ
- [ ] A/B ัะตััะธัะพะฒะฐะฝะธะต ัะตะบััะพะฒ ัะฒะตะดะพะผะปะตะฝะธะน

### ๐ก ะขะตัะฝะธัะตัะบะธะต ัะปัััะตะฝะธั
- [ ] ะะพะบัััะธะต ัะตััะฐะผะธ (unit + integration)
- [ ] ะะพะฝะธัะพัะธะฝะณ ะดะพััะฐะฒะปัะตะผะพััะธ FCM
- [ ] Retry ะผะตัะฐะฝะธะทะผ ะดะปั failed ะพัะฟัะฐะฒะพะบ
- [ ] Rate limiting ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั ัะฟะฐะผะฐ
- [ ] ะะฝะฐะปะธัะธะบะฐ: ัะบะพะปัะบะพ ะฐะดะผะธะฝะพะฒ ะพัะบััะปะธ ัะฒะตะดะพะผะปะตะฝะธะต

## ะขะตััะธัะพะฒะฐะฝะธะต

### ะกัะตะฝะฐัะธะน 1: ะะตะณะธัััะฐัะธั ัะพะบะตะฝะฐ

1. ะฃััะฐะฝะพะฒะธัั ะฟัะธะปะพะถะตะฝะธะต ะฝะฐ ััััะพะนััะฒะพ
2. ะะพะนัะธ ะฟะพะด ััััะฝะพะน ะทะฐะฟะธััั ะฐะดะผะธะฝะฐ
3. ะะฐัั ัะฐะทัะตัะตะฝะธะต ะฝะฐ push-ัะฒะตะดะพะผะปะตะฝะธั
4. ะัะพะฒะตัะธัั ะฒ ะะ:
   ```sql
   SELECT * 
   FROM user_tokens 
   WHERE user_id = '<your_user_id>';
   ```
5. ะฃะฑะตะดะธัััั, ััะพ `is_active = true` ะธ `platform` ัะพะพัะฒะตัััะฒัะตั ััััะพะนััะฒั

### ะกัะตะฝะฐัะธะน 2: ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟัะธ ะพัะบัััะธะธ ัะผะตะฝั

1. ะะพะนัะธ ะฟะพะด ััััะฝะพะน ะทะฐะฟะธััั ะพะฑััะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (ะฝะต ะฐะดะผะธะฝะฐ)
2. ะัะบัััั ัะผะตะฝั (ะฒัะฑัะฐัั ะพะฑัะตะบั, ะดะพะฑะฐะฒะธัั ัะพัััะดะฝะธะบะพะฒ)
3. ะะฐะถะฐัั "ะัะบัััั ัะผะตะฝั"
4. ะะฐ ััััะพะนััะฒะต ะฐะดะผะธะฝะฐ ะดะพะปะถะฝะพ ะฟัะธะนัะธ ัะฒะตะดะพะผะปะตะฝะธะต:
   ```
   ๐ ะกะผะตะฝะฐ - ะะขะะะซะขะ
   ๐ ะะฑัะตะบั: [ะฝะฐะทะฒะฐะฝะธะต]
   ๐ค ะะพะปัะทะพะฒะฐัะตะปั: [ะธะผั]
   ๐ฅ ะกะพัััะดะฝะธะบะพะฒ: [N]
   ```

### ะกัะตะฝะฐัะธะน 3: ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟัะธ ะทะฐะบัััะธะธ ัะผะตะฝั

1. ะัะบัััั ัััะตััะฒััััั ัะผะตะฝั
2. ะะพะฑะฐะฒะธัั ัะฐะฑะพัั ะธ ะผะฐัะตัะธะฐะปั (ะพะฑัะฐั ััะผะผะฐ, ะฝะฐะฟัะธะผะตั, 345766 โฝ)
3. ะะพะฑะฐะฒะธัั ะฝะตัะบะพะปัะบะพ ัะพัััะดะฝะธะบะพะฒ (ะฝะฐะฟัะธะผะตั, 3 ัะตะปะพะฒะตะบะฐ)
4. ะะฐะบัััั ัะผะตะฝั
5. ะะฐ ััััะพะนััะฒะต ะฐะดะผะธะฝะฐ ะดะพะปะถะฝะพ ะฟัะธะนัะธ ัะฒะตะดะพะผะปะตะฝะธะต:
   ```
   ๐ ะกะผะตะฝะฐ - ะะะะะซะขะ
   ๐ ะะฑัะตะบั: [ะฝะฐะทะฒะฐะฝะธะต]
   ๐ค ะะพะปัะทะพะฒะฐัะตะปั: [ะธะผั]
   ๐ฐ ะกัะผะผะฐ: 345 766 โฝ (ั ะฟัะพะฑะตะปะฐะผะธ!)
   โ๏ธ ะััะฐะฑะพัะบะฐ: 115 255 โฝ (345766 / 3, ั ะฟัะพะฑะตะปะฐะผะธ!)
   ```
6. **ะัะพะฒะตัะธัั ัะพัะผะฐัะธัะพะฒะฐะฝะธะต:** ััะผะผั ะดะพะปะถะฝั ัะพะดะตัะถะฐัั ะฟัะพะฑะตะปั ะผะตะถะดั ัััััะฐะผะธ

### ะกัะตะฝะฐัะธะน 4: ะกะผะตะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั

1. ะะพะนัะธ ะฟะพะด ะพะดะฝะธะผ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
2. ะัะพะฒะตัะธัั ัะพะบะตะฝ ะฒ ะะ
3. ะัะนัะธ ะธ ะฒะพะนัะธ ะฟะพะด ะดััะณะธะผ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
4. ะัะพะฒะตัะธัั, ััะพ ัะพะบะตะฝ ะฟะตัะตะฟัะธะฒัะทะฐะฝ ะบ ะฝะพะฒะพะผั `user_id`
5. ะกัะฐััะน ัะพะบะตะฝ ะฟะพะผะตัะตะฝ ะบะฐะบ `is_active = false`

### ะกัะตะฝะฐัะธะน 5: Logout

1. ะะพะนัะธ ะฒ ะฟัะธะปะพะถะตะฝะธะต
2. ะัะพะฒะตัะธัั ัะพะบะตะฝ ะฒ ะะ (`is_active = true`)
3. ะัะนัะธ ะธะท ะฟัะธะปะพะถะตะฝะธั
4. ะัะพะฒะตัะธัั, ััะพ ัะพะบะตะฝ ะฟะพะผะตัะตะฝ ะบะฐะบ `is_active = false`

## ะัะธะผะตัะฐะฝะธั ะดะปั ัะฐะทัะฐะฑะพััะธะบะพะฒ

### ะะฑัะธะต ัะตะบะพะผะตะฝะดะฐัะธะธ
- ะัะตะณะดะฐ ะธัะฟะพะปัะทัะนัะต `try-catch` ะฟัะธ ะฒัะทะพะฒะต `send_admin_work_event` โ ะฝะต ะฑะปะพะบะธััะนัะต UX
- ะัะฟะพะปัะทัะนัะต `debugPrint` ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั ัะตะทัะปััะฐัะพะฒ ะฒ dev-ัะตะถะธะผะต
- ะะต ะทะฐะฑัะฒะฐะนัะต ะฟะตัะตะดะฐะฒะฐัั `Authorization: Bearer $accessToken`
- ะัะพะฒะตััะนัะต `accessToken != null` ะฟะตัะตะด ะฒัะทะพะฒะพะผ Edge Function

### ะะตะทะพะฟะฐัะฝะพััั
- ะะธะบะพะณะดะฐ ะฝะต ะบะพะผะผะธัััะต `SERVICE_ACCOUNT` JSON ะฒ ัะตะฟะพะทะธัะพัะธะน
- ะัะฟะพะปัะทัะนัะต Supabase Secrets ะดะปั ััะฐะฝะตะฝะธั ััะฒััะฒะธัะตะปัะฝัั ะดะฐะฝะฝัั
- RLS ะฝะฐ `user_tokens` ะทะฐัะธัะฐะตั ัะพะบะตะฝั โ ะฝะต ะพัะบะปััะฐะนัะต ะตะณะพ

### ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- FCM ะธะผะตะตั ะปะธะผะธัั: 500 ัะพะพะฑัะตะฝะธะน ะฒ ัะตะบัะฝะดั ะฝะฐ ะฟัะพะตะบั
- ะัะฟะพะปัะทัะนัะต batch-ะพัะฟัะฐะฒะบั ะดะปั ะฑะพะปััะธั ะณััะฟะฟ ะฟะพะปััะฐัะตะปะตะน (ะฑัะดััะฐั ะพะฟัะธะผะธะทะฐัะธั)
- ะััะธััะนัะต ัะฟะธัะบะธ ะฐะดะผะธะฝะพะฒ, ะตัะปะธ ะทะฐะฟัะพัั ัะฐัััะต

### Debugging
- ะัะฟะพะปัะทัะนัะต Firebase Console โ Cloud Messaging ะดะปั ัะตััะพะฒัั ะพัะฟัะฐะฒะพะบ
- ะะพะณะธ Edge Functions ะดะพัััะฟะฝั ะฒ Supabase Dashboard โ Functions โ Logs
- ะัะฟะพะปัะทัะนัะต `flutter logs` ะดะปั ะฟัะพัะผะพััะฐ FCM ัะพะฑััะธะน ะฝะฐ ััััะพะนััะฒะต

### ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต
- ะัะต ะดะตะฝะตะถะฝัะต ััะผะผั ะฒ ัะฒะตะดะพะผะปะตะฝะธัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพัะผะฐัะธัััััั ั ะฟัะพะฑะตะปะฐะผะธ
- ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ะฟัะพะธััะพะดะธั ะฝะฐ ัะตัะฒะตัะต (Edge Function v32)
- ะคะพัะผะฐั: `245 766 โฝ` (ัะธัะปะพ ั ะฟัะพะฑะตะปะฐะผะธ ะผะตะถะดั ัััััะฐะผะธ + ัะธะผะฒะพะป ััะฑะปั)
- ะะปะธะตะฝััะบะธะน ะบะพะด ะฝะต ััะตะฑัะตั ะธะทะผะตะฝะตะฝะธะน โ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ะฟัะพะทัะฐัะฝะพ

## ะกะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั

- [FCM_ADMIN_NOTIFICATIONS_CHECKLIST.md](./FCM_ADMIN_NOTIFICATIONS_CHECKLIST.md) โ ัะตะบ-ะปะธัั ะฒะฝะตะดัะตะฝะธั
- [FCM_INTEGRATION_STATUS.md](./FCM_INTEGRATION_STATUS.md) โ ััะฐััั ะธะฝัะตะณัะฐัะธะธ FCM
- [notifications_integration.md](./notifications_integration.md) โ ะปะพะบะฐะปัะฝัะต ัะฒะตะดะพะผะปะตะฝะธั
- [works/works_module.md](./works/works_module.md) โ ะผะพะดัะปั ัะผะตะฝ

## ะะพัะปะตะดะฝัั ะฐะบััะฐะปะธะทะฐัะธั

**ะะฐัะฐ:** 11 ะพะบััะฑัั 2025 ะณะพะดะฐ

**ะะปััะตะฒัะต ะพะฑะฝะพะฒะปะตะฝะธั:**
- โ ะกะพะทะดะฐะฝ ะฟะพะปะฝัะน ะพะฑะทะพั ัะธััะตะผั ัะฒะตะดะพะผะปะตะฝะธะน ะดะปั ะฐะดะผะธะฝะพะฒ
- โ ะะฟะธัะฐะฝ ะดะตัะฐะปัะฝัะน ะฟัะพัะตัั ัะฐะฑะพัั ะฒัะตั ะบะพะผะฟะพะฝะตะฝัะพะฒ
- โ ะะพะฑะฐะฒะปะตะฝั ะฟัะธะผะตัั ะบะพะดะฐ ะธ ัะฒะตะดะพะผะปะตะฝะธะน
- โ ะะฐะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะฐ ััััะบัััะฐ ะะ ะธ RLS ะฟะพะปะธัะธะบะธ
- โ ะะพะฑะฐะฒะปะตะฝั ะธะฝััััะบัะธะธ ะฟะพ ะดะธะฐะณะฝะพััะธะบะต ะธ ัะตััะธัะพะฒะฐะฝะธั
- โ **ะะฑะฝะพะฒะปะตะฝะพ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ััะผะผ**: 345766 โ 345 766 โฝ (Edge Function v32)

**ะกัะฐััั:** ะะพะบัะผะตะฝัะฐัะธั ะฐะบััะฐะปัะฝะฐ ะธ ัะพะพัะฒะตัััะฒัะตั ัะตะบััะตะน ัะตะฐะปะธะทะฐัะธะธ ะฒ production.

