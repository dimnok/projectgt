# üêõ –û—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –≤ –º–æ–¥—É–ª–µ –§–û–¢

**–î–∞—Ç–∞:** 4 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ (—Å—É—Ç–æ—á–Ω—ã–µ) —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚Äî –æ–Ω–∏ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å **–≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º**, —Ä–∞–±–æ—Ç–∞–≤—à–∏–º –Ω–∞ –æ–±—ä–µ–∫—Ç–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ª–∏ –∏–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö.

**–ü—Ä–∏–º–µ—Ä:**
- **–ò–ª—å—è –ë–∞—Ö–æ–Ω—å–∫–æ** ‚Äî –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 700‚ÇΩ/—Å–º–µ–Ω–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ "–¶–û–î –î—É–±–Ω–∞" ‚úÖ
- **–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–æ–º–∞–∫–∏–Ω** ‚Äî –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 700‚ÇΩ/—Å–º–µ–Ω–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ "–¶–û–î –î—É–±–Ω–∞" ‚úÖ
- **–î—Ä—É–≥–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏** ‚Äî –ù–ï –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ ‚ùå

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –Ω–∞ –æ–±—ä–µ–∫—Ç–µ "–¶–û–î –î—É–±–Ω–∞", –¥–∞–∂–µ —Ç–µ–º, –∫–æ–º—É –Ω–µ –±—ã–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Å—Ç–∞–≤–∫–∏.

---

## üîç –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

### 1. PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è `calculate_payroll_for_month()`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 55-72 –≤ –º–∏–≥—Ä–∞—Ü–∏–∏):**
```sql
trip_calc AS (
  SELECT 
    wh.employee_id,
    SUM(COALESCE(
      (SELECT rate 
       FROM business_trip_rates btr 
       WHERE btr.object_id = w.object_id 
         AND w.date >= btr.valid_from 
         AND (btr.valid_to IS NULL OR w.date <= btr.valid_to)
       ORDER BY btr.valid_from DESC
       LIMIT 1), 0)
    ) as trip_total
  FROM work_hours wh
  JOIN works w ON wh.work_id = w.id
  WHERE EXTRACT(YEAR FROM w.date) = p_year
    AND EXTRACT(MONTH FROM w.date) = p_month
    AND w.object_id IS NOT NULL
  GROUP BY wh.employee_id
)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–ª–µ `employee_id` –≤ `business_trip_rates`
- ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `minimum_hours`
- ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –Ω–∞–¥ –æ–±—â–∏–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ –ø–æ–ª—É—á–∞–ª–∏ —Å—Ç–∞–≤–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–º—É.

---

### 2. Fallback –ª–æ–≥–∏–∫–∞ –≤ Dart (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (`lib/features/fot/presentation/providers/payroll_providers.dart`, —Å—Ç—Ä–æ–∫–∏ 246-263):**
```dart
for (final entry in entries) {
  final objectId = entry.objectId;
  if (objectId != null && objectId.isNotEmpty) {
    try {
      final rate = await getActiveRateUseCase(objectId, entry.date);
      if (rate != null) {
        businessTripTotal += rate.rate;  // ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è employee_id!
      }
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–≤–æ–∫
    }
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –º–µ—Ç–æ–¥ `getActiveRateUseCase(objectId, date)` ‚Äî –ø–æ–ª—É—á–∞–ª —Å—Ç–∞–≤–∫—É —Ç–æ–ª—å–∫–æ –ø–æ –æ–±—ä–µ–∫—Ç—É
- ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–ª—Å—è `employee_id` (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞)
- ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å `minimum_hours`

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PostgreSQL —Ñ—É–Ω–∫—Ü–∏–∏

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö:**

```sql
trip_calc AS (
  SELECT 
    wh.employee_id,
    SUM(COALESCE(
      -- –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
      (SELECT rate 
       FROM business_trip_rates btr 
       WHERE btr.object_id = w.object_id 
         AND btr.employee_id = wh.employee_id  -- ‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞
         AND w.date >= btr.valid_from 
         AND (btr.valid_to IS NULL OR w.date <= btr.valid_to)
         AND wh.hours >= COALESCE(btr.minimum_hours, 0)  -- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —á–∞—Å–æ–≤
       ORDER BY btr.valid_from DESC
       LIMIT 1),
      -- –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π, –∏—â–µ–º –æ–±—â—É—é —Å—Ç–∞–≤–∫—É –¥–ª—è –æ–±—ä–µ–∫—Ç–∞
      (SELECT rate 
       FROM business_trip_rates btr 
       WHERE btr.object_id = w.object_id 
         AND btr.employee_id IS NULL  -- ‚úÖ –û–±—â–∞—è —Å—Ç–∞–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö
         AND w.date >= btr.valid_from 
         AND (btr.valid_to IS NULL OR w.date <= btr.valid_to)
         AND wh.hours >= COALESCE(btr.minimum_hours, 0)  -- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —á–∞—Å–æ–≤
       ORDER BY btr.valid_from DESC
       LIMIT 1),
      0  -- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π, –Ω–∏ –æ–±—â–µ–π —Å—Ç–∞–≤–∫–∏ = 0
    )) as trip_total
  FROM work_hours wh
  JOIN works w ON wh.work_id = w.id
  WHERE EXTRACT(YEAR FROM w.date) = p_year
    AND EXTRACT(MONTH FROM w.date) = p_month
    AND w.object_id IS NOT NULL
  GROUP BY wh.employee_id
)
```

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:** –°–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (`employee_id = —Å–æ—Ç—Ä—É–¥–Ω–∏–∫`), –ø–æ—Ç–æ–º –æ–±—â–∞—è (`employee_id IS NULL`)
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —á–∞—Å–æ–≤:** `wh.hours >= COALESCE(btr.minimum_hours, 0)`
3. ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π fallback:** –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞–≤–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 0

---

### 2. –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ `BusinessTripRateDataSource`

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `getActiveRateForEmployeeAndDate()`:**

```dart
Future<BusinessTripRateModel?> getActiveRateForEmployeeAndDate(
  String employeeId,
  String objectId,
  DateTime date,
  double hours,
) async {
  try {
    final dateStr = date.toIso8601String().split('T')[0];

    // 1. –ò—â–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    final individualResponse = await _client
        .from(_tableName)
        .select()
        .eq('object_id', objectId)
        .eq('employee_id', employeeId)  // ‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
        .lte('valid_from', dateStr)
        .or('valid_to.is.null,valid_to.gte.$dateStr')
        .order('valid_from', ascending: false)
        .limit(1)
        .maybeSingle();

    if (individualResponse != null) {
      final rate = BusinessTripRateModel.fromJson(individualResponse);
      // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
      if (hours >= rate.minimumHours) {
        return rate;
      }
      return null; // –ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∏–Ω–∏–º—É–º —á–∞—Å–æ–≤
    }

    // 2. –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π, –∏—â–µ–º –æ–±—â—É—é –¥–ª—è –æ–±—ä–µ–∫—Ç–∞
    final generalResponse = await _client
        .from(_tableName)
        .select()
        .eq('object_id', objectId)
        .filter('employee_id', 'is', 'null')  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ employee_id IS NULL
        .lte('valid_from', dateStr)
        .or('valid_to.is.null,valid_to.gte.$dateStr')
        .order('valid_from', ascending: false)
        .limit(1)
        .maybeSingle();

    if (generalResponse == null) return null;

    final rate = BusinessTripRateModel.fromJson(generalResponse);
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
    if (hours >= rate.minimumHours) {
      return rate;
    }
    return null; // –ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∏–Ω–∏–º—É–º —á–∞—Å–æ–≤
  } catch (e) {
    throw Exception('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–≤–∫–∏: $e');
  }
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
1. ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `employeeId` –∏ `hours` –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
2. ‚úÖ –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø–æ–∏—Å–∫: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è ‚Üí –æ–±—â–∞—è —Å—Ç–∞–≤–∫–∞
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `minimum_hours` –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
4. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å NULL —á–µ—Ä–µ–∑ `.filter('employee_id', 'is', 'null')`

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ fallback –ª–æ–≥–∏–∫–∏ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ (`lib/features/fot/presentation/providers/payroll_providers.dart`):**

```dart
// –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏ –¥–∞—Ç—ã —Å–º–µ–Ω—ã
// —Å —É—á—ë—Ç–æ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Å–æ–≤
double businessTripTotal = 0;
final tripRateDataSource = ref.read(businessTripRateDataSourceProvider);

for (final entry in entries) {
  final objectId = entry.objectId;
  if (objectId != null && objectId.isNotEmpty) {
    try {
      // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ —Å —É—á—ë—Ç–æ–º employee_id –∏ hours
      final rate = await tripRateDataSource.getActiveRateForEmployeeAndDate(
        employeeId,     // ‚úÖ –ü–µ—Ä–µ–¥–∞—ë–º ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        objectId,
        entry.date,
        entry.hours,    // ‚úÖ –ü–µ—Ä–µ–¥–∞—ë–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
      );
      if (rate != null) {
        businessTripTotal += rate.rate;
      }
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–≤–æ–∫
    }
  }
}
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–°–æ—Ç—Ä—É–¥–Ω–∏–∫                | –ß–∞—Å—ã | –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ
-------------------------|------|------------------
–ò–ª—å—è –ë–∞—Ö–æ–Ω—å–∫–æ           |  37  | ‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞
–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–æ–º–∞–∫–∏–Ω       |  25  | ‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞
–ë–∞–π—ã—à –®–µ—Ä–º–∞—Ç–æ–≤          |  40  | ‚ùå 700‚ÇΩ (–æ—à–∏–±–∫–∞!)
–î–º–∏—Ç—Ä–∏–π –ó–µ–º—Ü–µ–≤          |  30  | ‚ùå 700‚ÇΩ (–æ—à–∏–±–∫–∞!)
... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ)     |  ... | ‚ùå 700‚ÇΩ (–æ—à–∏–±–∫–∞!)
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–°–æ—Ç—Ä—É–¥–Ω–∏–∫                | –ß–∞—Å—ã | –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ | –°—Ç–∞—Ç—É—Å
-------------------------|------|-----------------|----------------
–ò–ª—å—è –ë–∞—Ö–æ–Ω—å–∫–æ           |  37  | 2800‚ÇΩ          | ‚úÖ –ï—Å—Ç—å —Å—Ç–∞–≤–∫–∞ (4 —Å–º–µ–Ω—ã √ó 700‚ÇΩ)
–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –õ–æ–º–∞–∫–∏–Ω       |  25  | 2100‚ÇΩ          | ‚úÖ –ï—Å—Ç—å —Å—Ç–∞–≤–∫–∞ (3 —Å–º–µ–Ω—ã √ó 700‚ÇΩ)
–ë–∞–π—ã—à –®–µ—Ä–º–∞—Ç–æ–≤          |  40  | 0‚ÇΩ             | ‚úÖ –ù–µ—Ç —Å—Ç–∞–≤–∫–∏
–î–º–∏—Ç—Ä–∏–π –ó–µ–º—Ü–µ–≤          |  30  | 0‚ÇΩ             | ‚úÖ –ù–µ—Ç —Å—Ç–∞–≤–∫–∏
... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ)     |  ... | 0‚ÇΩ             | ‚úÖ –ù–µ—Ç —Å—Ç–∞–≤–∫–∏
```

---

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
- **–§–∞–π–ª:** `supabase/migrations/[timestamp]_fix_business_trip_rates_calculation.sql`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `calculate_payroll_for_month()` —Å —É—á—ë—Ç–æ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –∏ `minimum_hours`

### 2. Data Source
- **–§–∞–π–ª:** `lib/data/datasources/business_trip_rate_data_source.dart`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `getActiveRateForEmployeeAndDate()` (79 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞)

### 3. Provider
- **–§–∞–π–ª:** `lib/features/fot/presentation/providers/payroll_providers.dart`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –û–±–Ω–æ–≤–ª–µ–Ω–∞ fallback –ª–æ–≥–∏–∫–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **–§–∞–π–ª:** `docs/fot/fot_module.md`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö" –≤ "–ö–ª—é—á–µ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è `calculate_payroll_for_month()`
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –Ω–∞–¥ –æ–±—â–∏–º–∏
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `minimum_hours` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ë–î
- [x] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `getActiveRateForEmployeeAndDate()` –≤ `BusinessTripRateDataSource`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ fallback –ª–æ–≥–∏–∫–∞ –≤ `payroll_providers.dart`
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å `.filter('employee_id', 'is', 'null')` –≤ Supabase
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ë–î —á–µ—Ä–µ–∑ MCP Supabase
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–æ–≤
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è `fot_module.md`
- [x] –°–æ–∑–¥–∞–Ω –æ—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏

---

## üéØ –ò—Ç–æ–≥–æ

**–ö—Ä–∏—Ç–∏—á–Ω—ã–π –±–∞–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω:**
- ‚úÖ –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ —Å—Ç–∞–≤–∫–∞–º–∏
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –Ω–∞–¥ –æ–±—â–∏–º–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ (`minimum_hours`)
- ‚úÖ Fallback –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ë–î
- ‚úÖ –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~30 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è (—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ë–î –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ)  
**–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–Ω–æ–µ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á—ë—Ç—ã)

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 4 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–ê–≤—Ç–æ—Ä:** Cursor AI Assistant

