# –û—Ç—á—ë—Ç: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª—è –§–û–¢

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 4 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 4 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 4 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê ‚Äî –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 40-80 —Ä–∞–∑! + –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫—Ä–∏—Ç–∏—á–Ω—ã–π –±–∞–≥ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞
–î–∞–Ω–Ω—ã–µ –≤ –º–æ–¥—É–ª–µ –§–û–¢ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è **–æ—á–µ–Ω—å –¥–æ–ª–≥–æ** (5-15+ —Å–µ–∫—É–Ω–¥), —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

#### 1. üî¥ **N+1 Query Problem** (–ö—Ä–∏—Ç–∏—á–Ω–æ!)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (`filteredPayrollsProvider`, —Å—Ç—Ä–æ–∫–∏ 182-217):

```dart
for (final employeeId in filteredEmployeeIds) {          // 10 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
  for (final entry in entries) {                          // 20 —Å–º–µ–Ω —É –∫–∞–∂–¥–æ–≥–æ
    // ‚ùå –û–¢–î–ï–õ–¨–ù–´–ô –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π —Å–º–µ–Ω—ã!
    final rateForDate = await getRateUseCase(employeeId, entry.date);  // 200 –∑–∞–ø—Ä–æ—Å–æ–≤!
  }
  
  for (final entry in entries) {                          // –°–Ω–æ–≤–∞ 20 —Å–º–µ–Ω
    // ‚ùå –ï–©–Å –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π —Å–º–µ–Ω—ã!
    final rate = await getActiveRateUseCase(objectId, entry.date);     // 200 –∑–∞–ø—Ä–æ—Å–æ–≤!
  }
}
```

**–ò—Ç–æ–≥–æ:** –ü—Ä–∏ 10 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö √ó 20 —Å–º–µ–Ω = **400 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î!** üî•

#### 2. üü° **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö** (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**–¢–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫** (`payroll_list_screen.dart`, —Å—Ç—Ä–æ–∫–∏ 50-55):

```dart
// ‚ùå –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–∫–∞–∂–¥—ã–π –∂–¥—ë—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π)
await ref.read(employeeProvider.notifier).getEmployees();    // ~1-2 —Å–µ–∫
await ref.read(objectProvider.notifier).loadObjects();       // ~0.5-1 —Å–µ–∫
ref.invalidate(filteredPayrollsProvider);                    // –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ:
  // - payrollWorkHoursProvider                             // ~1-2 —Å–µ–∫
  // - allPenaltiesProvider                                 // ~0.5 —Å–µ–∫
  // - allBonusesProvider                                   // ~0.5 —Å–µ–∫
  // - 400 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—Ç–∞–≤–æ–∫                                  // ~5-10 —Å–µ–∫
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 8-17 —Å–µ–∫—É–Ω–¥ ‚è±Ô∏è

#### 3. üü° **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ JOIN –≤ SQL** (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**–¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å** (`payrollWorkHoursProvider`, —Å—Ç—Ä–æ–∫–∏ 26-38):

```dart
final response = await client.from('work_hours').select('''
  id,
  work_id,
  employee_id,
  hours,
  works!inner(date, object_id),
  employees(position)              // ‚ùå –ò–∑–±—ã—Ç–æ—á–Ω—ã–π JOIN!
''');
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∂–æ–π–Ω–∏–º `employees`, –Ω–æ –ø–æ—Ç–æ–º –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ `employeeProvider`.

#### 4. üü¢ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–≤–æ–∫** (–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

–°—Ç–∞–≤–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ, —Ö–æ—Ç—è –æ–Ω–∏ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞.

---

## üéØ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 –ø—Ä–æ–±–ª–µ–º—ã (üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ)

#### 1.1. –ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å —Å—Ç–∞–≤–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

**–ë—ã–ª–æ:**
```dart
for (final entry in entries) {
  final rateForDate = await getRateUseCase(employeeId, entry.date);
}
```

**–°—Ç–∞–Ω–µ—Ç:**
```dart
// –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä—ã (employeeId, date)
final rateRequests = <(String, DateTime)>{};
for (final employeeId in filteredEmployeeIds) {
  for (final entry in employeeEntries[employeeId]!) {
    rateRequests.add((employeeId, entry.date));
  }
}

// –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 200!
final allRates = await batchGetEmployeeRates(rateRequests);
```

**SQL –¥–ª—è –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å–∞:**
```sql
SELECT employee_id, effective_from, hourly_rate
FROM employee_rates
WHERE (employee_id, effective_from) IN (
  ('emp1', '2024-10-01'), ('emp1', '2024-10-02'), ...
)
AND effective_from <= date
ORDER BY effective_from DESC;
```

#### 1.2. –ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫

**–ë—ã–ª–æ:**
```dart
for (final entry in entries) {
  final rate = await getActiveRateUseCase(objectId, entry.date);
}
```

**–°—Ç–∞–Ω–µ—Ç:**
```dart
// –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä—ã (objectId, date)
final tripRateRequests = <(String, DateTime)>{};
for (final employeeId in filteredEmployeeIds) {
  for (final entry in employeeEntries[employeeId]!) {
    if (entry.objectId != null) {
      tripRateRequests.add((entry.objectId, entry.date));
    }
  }
}

// –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 200!
final allTripRates = await batchGetBusinessTripRates(tripRateRequests);
```

**SQL –¥–ª—è –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å–∞:**
```sql
SELECT object_id, effective_from, rate
FROM business_trip_rates
WHERE (object_id, effective_from) IN (
  ('obj1', '2024-10-01'), ('obj2', '2024-10-02'), ...
)
AND effective_from <= date
ORDER BY effective_from DESC;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ 400 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 2 –∑–∞–ø—Ä–æ—Å–∞ = **—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ ~200 —Ä–∞–∑!** üöÄ

---

### –≠—Ç–∞–ø 2: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 2.1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

**–ë—ã–ª–æ:**
```dart
await ref.read(employeeProvider.notifier).getEmployees();  // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
await ref.read(objectProvider.notifier).loadObjects();     // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
```

**–°—Ç–∞–Ω–µ—Ç:**
```dart
// –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
await Future.wait([
  ref.read(employeeProvider.notifier).getEmployees(),
  ref.read(objectProvider.notifier).loadObjects(),
  ref.refresh(payrollWorkHoursProvider.future),
  ref.refresh(allPenaltiesProvider.future),
  ref.refresh(allBonusesProvider.future),
]);

// –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á—ë—Ç—ã –§–û–¢
ref.invalidate(filteredPayrollsProvider);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ 5-7 —Å–µ–∫—É–Ω–¥ ‚Üí 2-3 —Å–µ–∫—É–Ω–¥—ã = **—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ ~2 —Ä–∞–∑–∞!** üöÄ

#### 2.2. –£–ø—Ä–æ—â–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞ work_hours

**–ë—ã–ª–æ:**
```sql
SELECT id, work_id, employee_id, hours,
       works!inner(date, object_id),
       employees(position)              -- –ò–∑–±—ã—Ç–æ—á–Ω–æ!
FROM work_hours
```

**–°—Ç–∞–Ω–µ—Ç:**
```sql
SELECT id, work_id, employee_id, hours,
       works!inner(date, object_id)     -- –£–±—Ä–∞–ª–∏ employees JOIN
FROM work_hours
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ 20-30%.

---

### –≠—Ç–∞–ø 3: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 3.1. In-memory –∫—ç—à –¥–ª—è —Å—Ç–∞–≤–æ–∫

```dart
final employeeRatesCacheProvider = 
    StateProvider<Map<(String, DateTime), double>>((ref) => {});

final businessTripRatesCacheProvider = 
    StateProvider<Map<(String, DateTime), double>>((ref) => {});
```

**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å—Ç–∞–≤–∫–∏ –≤ –∫—ç—à
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –≤ —Ç–æ–º –∂–µ –º–µ—Å—è—Ü–µ ‚Äî –±–µ—Ä—ë–º –∏–∑ –∫—ç—à–∞
- –ü—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞) —Å—Ç–∞–Ω—É—Ç **–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º–∏**.

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï)

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| **–û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏** | 8-17 —Å–µ–∫—É–Ω–¥ | **0.12-0.20 —Å–µ–∫—É–Ω–¥—ã** üöÄ | **40-80√ó –±—ã—Å—Ç—Ä–µ–µ!** |
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤** | ~405 –∑–∞–ø—Ä–æ—Å–æ–≤ | **1 RPC** | **405√ó –º–µ–Ω—å—à–µ** |
| **–í—Ä–µ–º—è —Ä–∞—Å—á—ë—Ç–∞ –§–û–¢ (–ë–î)** | 5-10 —Å–µ–∫—É–Ω–¥ | **21ms** | **238-476√ó –±—ã—Å—Ç—Ä–µ–µ!** |
| **–°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏** | –í—ã—Å–æ–∫–∏–µ (400+ –∑–∞–ø—Ä–æ—Å–æ–≤) | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (1 –∑–∞–ø—Ä–æ—Å) | **–ö—Ä–∏—Ç–∏—á–Ω–æ –º–µ–Ω—å—à–µ** |

### üéØ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—Ä—ã –∏–∑ –∫–æ–Ω—Å–æ–ª–∏:
```
‚úÖ FOT data loaded via RPC in 167ms
‚úÖ FOT data loaded via RPC in 178ms
‚úÖ FOT data loaded via RPC in 122ms
‚úÖ FOT data loaded via RPC in 203ms
```

**–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å:** ~167ms (–≤–º–µ—Å—Ç–æ 8-17 —Å–µ–∫—É–Ω–¥)

---

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

1. **üî¥ –í—ã—Å–æ–∫–∏–π:** –≠—Ç–∞–ø 1 (–ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞–≤–æ–∫) ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. **üü° –°—Ä–µ–¥–Ω–∏–π:** –≠—Ç–∞–ø 2 (–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞) ‚Äî –∑–∞–º–µ—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ UX
3. **üü¢ –ù–∏–∑–∫–∏–π:** –≠—Ç–∞–ø 3 (–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Äî —É–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –≠—Ç–∞–ø 1: –ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã
1. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
   - `lib/features/fot/data/datasources/employee_rate_remote_data_source.dart`
     - `Future<Map<(String, DateTime), double>> batchGetRatesForDates(...)`
   - `lib/features/fot/data/datasources/business_trip_rate_remote_data_source.dart`
     - `Future<Map<(String, DateTime), double>> batchGetRatesForDates(...)`

2. **–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä:**
   - `lib/features/fot/presentation/providers/payroll_providers.dart`
     - –ó–∞–º–µ–Ω–∏—Ç—å —Ü–∏–∫–ª—ã `await getRateUseCase()` –Ω–∞ –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã
     - –ó–∞–º–µ–Ω–∏—Ç—å —Ü–∏–∫–ª—ã `await getActiveRateUseCase()` –Ω–∞ –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã

#### –≠—Ç–∞–ø 2: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
1. **–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é:**
   - `lib/features/fot/presentation/screens/payroll_list_screen.dart`
     - –ú–µ—Ç–æ–¥ `_initializeData()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Future.wait()`

2. **–£–ø—Ä–æ—Å—Ç–∏—Ç—å SQL:**
   - `lib/features/fot/presentation/providers/payroll_providers.dart`
     - `payrollWorkHoursProvider` ‚Äî —É–±—Ä–∞—Ç—å JOIN –∫ `employees`

#### –≠—Ç–∞–ø 3: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–°–æ–∑–¥–∞—Ç—å –∫—ç—à-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
   - `lib/features/fot/presentation/providers/rate_cache_provider.dart`
     - `employeeRatesCacheProvider`
     - `businessTripRatesCacheProvider`

2. **–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É:**
   - `lib/features/fot/presentation/providers/payroll_providers.dart`
     - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫—ç—à –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î
     - –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞

---

## üóÑÔ∏è –ê–Ω–∞–ª–∏–∑: –†–∞—Å—á—ë—Ç—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ë–î vs –ö–ª–∏–µ–Ω—Ç–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ MCP Supabase –≤—ã—è–≤–∏–ª–∞:**

‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**
```sql
CREATE FUNCTION get_employee_rate(p_employee_id uuid, p_date date)
RETURNS numeric
```
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É.

‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:**
- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –§–û–¢
- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (materialized views)
- –û–±—ã—á–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (views) –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤

üü¢ **–ï—Å—Ç—å —Ç–æ–ª—å–∫–æ:**
- Foreign Key —Ç—Ä–∏–≥–≥–µ—Ä—ã (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏)
- –¢—Ä–∏–≥–≥–µ—Ä `update_business_trip_rates_updated_at` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏)

---

### –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –í–∞—Ä–∏–∞–Ω—Ç 1: üñ•Ô∏è **Client-Side —Ä–∞—Å—á—ë—Ç—ã** (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏ (–ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º—É–ª—ã)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (unit-—Ç–µ—Å—Ç—ã –Ω–∞ Dart)
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ë–î (–º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –ë–î –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –õ–µ–≥—á–µ –æ—Ç–ª–∞–¥–∫–∞ (–º–æ–∂–Ω–æ –ø–æ—à–∞–≥–æ–≤–æ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã)
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ (–≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –ú–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (N+1 –ø—Ä–æ–±–ª–µ–º–∞)
- ‚ùå –ü–µ—Ä–µ–¥–∞—á–∞ –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ç–∏
- ‚ùå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚ùå –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

**–õ—É—á—à–µ –¥–ª—è:**
- –°–ª–æ–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å —á–∞—Å—Ç—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å –∏ –±—ã—Å—Ç—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- –ö–æ–≥–¥–∞ —Ä–∞—Å—á—ë—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç UI-—Å–æ—Å—Ç–æ—è–Ω–∏—è

---

#### –í–∞—Ä–∏–∞–Ω—Ç 2: üóÑÔ∏è **Server-Side —Ä–∞—Å—á—ë—Ç—ã** (PostgreSQL —Ñ—É–Ω–∫—Ü–∏–∏)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–∏–Ω–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ (1-2 –≤–º–µ—Å—Ç–æ 400)
- ‚úÖ –ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ç–∏
- ‚úÖ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ë–î –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–π)
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
- ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (Web, Mobile, API)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É (–º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î)
- ‚ùå –°–ª–æ–∂–Ω–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–Ω—É–∂–Ω—ã SQL-—Ç–µ—Å—Ç—ã)
- ‚ùå –ü—Ä–∏–≤—è–∑–∫–∞ –∫ PostgreSQL
- ‚ùå –û—Ç–ª–∞–¥–∫–∞ —Å–ª–æ–∂–Ω–µ–µ (–Ω–µ—Ç –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –¥–µ–±–∞–≥–∞)
- ‚ùå –î–≤–µ –∫–æ–¥–æ–≤—ã–µ –±–∞–∑—ã (SQL + Dart)

**–õ—É—á—à–µ –¥–ª—è:**
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (—Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è)
- –ë–æ–ª—å—à–∏–µ –æ–±—ä—ë–º—ã –¥–∞–Ω–Ω—ã—Ö
- –ö–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–∞

---

#### –í–∞—Ä–∏–∞–Ω—Ç 3: üéØ **Hybrid –ø–æ–¥—Ö–æ–¥** (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø!)

**–ß—Ç–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ë–î:**

##### 3.1. –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Å—Ç–∞–≤–æ–∫

```sql
CREATE MATERIALIZED VIEW mv_employee_rates_monthly AS
SELECT 
  er.employee_id,
  DATE_TRUNC('month', wh.date) AS month,
  SUM(wh.hours * er.hourly_rate) AS base_salary,
  SUM(wh.hours) AS total_hours
FROM work_hours wh
JOIN works w ON wh.work_id = w.id
JOIN employee_rates er ON wh.employee_id = er.employee_id
  AND w.date BETWEEN er.valid_from AND COALESCE(er.valid_to, '9999-12-31')
GROUP BY er.employee_id, DATE_TRUNC('month', wh.date);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE UNIQUE INDEX ON mv_employee_rates_monthly (employee_id, month);
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –∏–ª–∏ –≤—Ä—É—á–Ω—É—é —Ä–∞–∑ –≤ —á–∞—Å:
```sql
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_employee_rates_monthly;
```

##### 3.2. PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–∞—Ç—á-—Ä–∞—Å—á—ë—Ç–∞ –§–û–¢

```sql
CREATE OR REPLACE FUNCTION calculate_payroll_for_month(
  p_year INT,
  p_month INT
)
RETURNS TABLE (
  employee_id UUID,
  employee_name TEXT,
  total_hours NUMERIC,
  base_salary NUMERIC,
  business_trip_total NUMERIC,
  bonuses_total NUMERIC,
  penalties_total NUMERIC,
  net_salary NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  WITH 
  -- 1. –ë–∞–∑–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ (–∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)
  base_calc AS (
    SELECT 
      wh.employee_id,
      SUM(wh.hours) as hours,
      SUM(wh.hours * 
        (SELECT hourly_rate FROM employee_rates er 
         WHERE er.employee_id = wh.employee_id 
         AND w.date BETWEEN er.valid_from AND COALESCE(er.valid_to, '9999-12-31')
         LIMIT 1)
      ) as base_sal
    FROM work_hours wh
    JOIN works w ON wh.work_id = w.id
    WHERE EXTRACT(YEAR FROM w.date) = p_year
      AND EXTRACT(MONTH FROM w.date) = p_month
    GROUP BY wh.employee_id
  ),
  -- 2. –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ
  trip_calc AS (
    SELECT 
      wh.employee_id,
      SUM(
        (SELECT rate FROM business_trip_rates btr 
         WHERE btr.object_id = w.object_id 
         AND w.date BETWEEN btr.effective_from AND COALESCE(btr.effective_to, '9999-12-31')
         LIMIT 1)
      ) as trip_total
    FROM work_hours wh
    JOIN works w ON wh.work_id = w.id
    WHERE EXTRACT(YEAR FROM w.date) = p_year
      AND EXTRACT(MONTH FROM w.date) = p_month
      AND w.object_id IS NOT NULL
    GROUP BY wh.employee_id
  ),
  -- 3. –ü—Ä–µ–º–∏–∏
  bonus_calc AS (
    SELECT 
      employee_id,
      COALESCE(SUM(amount), 0) as bonuses
    FROM payroll_bonus
    WHERE EXTRACT(YEAR FROM date) = p_year
      AND EXTRACT(MONTH FROM date) = p_month
    GROUP BY employee_id
  ),
  -- 4. –®—Ç—Ä–∞—Ñ—ã
  penalty_calc AS (
    SELECT 
      employee_id,
      COALESCE(SUM(amount), 0) as penalties
    FROM payroll_penalty
    WHERE EXTRACT(YEAR FROM date) = p_year
      AND EXTRACT(MONTH FROM date) = p_month
    GROUP BY employee_id
  )
  
  -- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç
  SELECT 
    e.id,
    e.full_name,
    COALESCE(bc.hours, 0),
    COALESCE(bc.base_sal, 0),
    COALESCE(tc.trip_total, 0),
    COALESCE(bonus.bonuses, 0),
    COALESCE(pen.penalties, 0),
    COALESCE(bc.base_sal, 0) + 
      COALESCE(tc.trip_total, 0) + 
      COALESCE(bonus.bonuses, 0) - 
      COALESCE(pen.penalties, 0) as net_salary
  FROM employees e
  LEFT JOIN base_calc bc ON e.id = bc.employee_id
  LEFT JOIN trip_calc tc ON e.id = tc.employee_id
  LEFT JOIN bonus_calc bonus ON e.id = bonus.employee_id
  LEFT JOIN penalty_calc pen ON e.id = pen.employee_id
  WHERE bc.employee_id IS NOT NULL  -- –¢–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å —á–∞—Å–∞–º–∏
  ORDER BY e.full_name;
END;
$$ LANGUAGE plpgsql STABLE;
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Dart:**
```dart
final payrollData = await supabase.rpc('calculate_payroll_for_month', params: {
  'p_year': 2025,
  'p_month': 10,
});
```

**–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 400!** üöÄ

---

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hybrid –ø–æ–¥—Ö–æ–¥:**

1. **–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ë–î (—ç—Ç–∞–ø 1):**
   - ‚úÖ –§—É–Ω–∫—Ü–∏—è `calculate_payroll_for_month()` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Å—á—ë—Ç
   - ‚úÖ –ë–∞—Ç—á-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–≤–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å)

2. **–û—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:**
   - UI-–ª–æ–≥–∏–∫–∞ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
   - –°–ª–æ–∂–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º

3. **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–≥–æ:**
   - –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (–∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–µ—Ç –º–Ω–æ–≥–æ)
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)

---

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ü–æ–¥—Ö–æ–¥ | –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î | –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ì–∏–±–∫–æ—Å—Ç—å |
|--------|---------------|----------------|-----------|----------|
| **Client-Side (—Ç–µ–∫—É—â–∏–π)** | ~400 | 8-17 —Å–µ–∫ | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |
| **Client-Side (—Å –±–∞—Ç—á–∞–º–∏)** | ~7 | 2-4 —Å–µ–∫ | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |
| **Server-Side (—Ñ—É–Ω–∫—Ü–∏—è)** | 1 | 0.5-1 —Å–µ–∫ | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è |
| **Hybrid (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)** | 1-2 | 0.5-2 —Å–µ–∫ | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |

---

### üìã –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è Hybrid –ø–æ–¥—Ö–æ–¥–∞

**–≠—Ç–∞–ø 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `mv_employee_rates_monthly`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç—Ä–∏–≥–≥–µ—Ä –∏–ª–∏ cron)

**–≠—Ç–∞–ø 1: Server-Side —Ñ—É–Ω–∫—Ü–∏—è**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `calculate_payroll_for_month()`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º —Ä–∞—Å—á—ë—Ç–æ–º

**–≠—Ç–∞–ø 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Dart**
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `filteredPayrollsProvider`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `supabase.rpc()` –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤
- [ ] –ú–∞–ø–ø–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ `PayrollCalculation`

**–≠—Ç–∞–ø 3: Fallback –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞**
- [ ] –ï—Å–ª–∏ –ë–î-—Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```dart
final stopwatch = Stopwatch()..start();

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...

stopwatch.stop();
print('‚úÖ FOT data loaded in ${stopwatch.elapsedMilliseconds}ms');
```

### –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è:** –ï—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ >100, –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ—Ä—Ü–∏—è–º–∏
2. **Virtual Scrolling:** –í —Ç–∞–±–ª–∏—Ü–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏
3. **Web Workers (–¥–ª—è Web):** –†–∞—Å—á—ë—Ç—ã –§–û–¢ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
4. **Progressive Loading:** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Ä–µ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –ø–æ—Ç–æ–º —Ä–∞—Å—á—ë—Ç—ã)

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –ü–æ–¥—Ö–æ–¥ A: Client-Side —Å –±–∞—Ç—á–∞–º–∏ (–±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

- [ ] **–≠—Ç–∞–ø 1.1:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å —Å—Ç–∞–≤–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- [ ] **–≠—Ç–∞–ø 1.2:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- [ ] **–≠—Ç–∞–ø 2.1:** –í–Ω–µ–¥—Ä–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
- [ ] **–≠—Ç–∞–ø 2.2:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å work_hours
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å <5 —Å–µ–∫)
- [ ] **–≠—Ç–∞–ø 3:** –í–Ω–µ–¥—Ä–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–≤–æ–∫
- [ ] **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –û–±–Ω–æ–≤–∏—Ç—å `fot_module.md` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- [ ] **Code Review:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- [ ] **Production:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ–¥ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü–æ–¥—Ö–æ–¥ B: Hybrid (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

- [ ] **–≠—Ç–∞–ø 0.1:** –°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] **–≠—Ç–∞–ø 0.2:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [x] **–≠—Ç–∞–ø 1.1:** –°–æ–∑–¥–∞—Ç—å PostgreSQL —Ñ—É–Ω–∫—Ü–∏—é `calculate_payroll_for_month()` ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] **–≠—Ç–∞–ø 1.2:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚úÖ –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [x] **–≠—Ç–∞–ø 1.3:** –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º —Ä–∞—Å—á—ë—Ç–æ–º ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
- [x] **–≠—Ç–∞–ø 2.1:** –û–±–Ω–æ–≤–∏—Ç—å `filteredPayrollsProvider` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RPC ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- [x] **–≠—Ç–∞–ø 2.2:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –≤ `PayrollCalculation` ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] **–≠—Ç–∞–ø 2.3:** –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç (–ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î) ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω
- [x] **–≠—Ç–∞–ø 3.1:** –í–Ω–µ–¥—Ä–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚úÖ Future.wait —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] **–≠—Ç–∞–ø 3.2:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å work_hours ‚úÖ –£–±—Ä–∞–Ω employees JOIN
- [x] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å <2 —Å–µ–∫) ‚úÖ **120-200ms!** (–±—ã–ª–æ 8-17 —Å–µ–∫)
- [x] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚úÖ –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [x] **–ë–∞–≥-—Ñ–∏–∫—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö ‚úÖ –¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è employee_id –∏ minimum_hours
- [x] **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –û–±–Ω–æ–≤–∏—Ç—å `fot_module.md` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º hybrid –ø–æ–¥—Ö–æ–¥–∞ ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞
- [x] **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –°–æ–∑–¥–∞–Ω –æ—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã—Ö ‚úÖ `–û–¢–ß–ï–¢_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_–ö–û–ú–ê–ù–î–ò–†–û–í–û–ß–ù–´–•.md`
- [ ] **Code Review:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ (Dart + SQL)
- [ ] **Production:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ–¥ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## üìö –°—Å—ã–ª–∫–∏

- **–§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏:**
  - `lib/features/fot/presentation/providers/payroll_providers.dart` (—Å—Ç—Ä–æ–∫–∏ 182-217)
  - `lib/features/fot/presentation/screens/payroll_list_screen.dart` (—Å—Ç—Ä–æ–∫–∏ 50-55)

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
  - `docs/fot/fot_module.md` ‚Äî –æ–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è –§–û–¢

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 4 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–ê–≤—Ç–æ—Ä:** Cursor AI Assistant  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üí° –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ (1-2 –¥–Ω—è)
**–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ü–æ–¥—Ö–æ–¥ A:** Client-Side —Å –±–∞—Ç—á–∞–º–∏
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ë–î)
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 4-5 —Ä–∞–∑ (—Å 8-17 —Å–µ–∫ –¥–æ 2-4 —Å–µ–∫)
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –≤ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏
- ‚ö†Ô∏è –í—Å—ë –µ—â—ë –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ (1-2 –Ω–µ–¥–µ–ª–∏)
**–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ü–æ–¥—Ö–æ–¥ B:** Hybrid
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (0.5-2 —Å–µ–∫)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–æ–ª—å—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ API)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SQL-—Ñ—É–Ω–∫—Ü–∏–π
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∫–∞

### –ü–æ—á–µ–º—É Hybrid ‚Äî –ª—É—á—à–∏–π –≤—ã–±–æ—Ä?

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 400 = –≤ 200 —Ä–∞–∑ –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** PostgreSQL –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–π
3. **–ì–∏–±–∫–æ—Å—Ç—å:** UI-–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å)
4. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—é –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ Web, Mobile, API
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** RLS –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏
6. **–ë—É–¥—É—â–µ–µ:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é **–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:**

1. **–°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:** `supabase/migrations/YYYYMMDDHHMMSS_optimize_payroll.sql`
2. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL-—Ñ—É–Ω–∫—Ü–∏—é** `calculate_payroll_for_month()` –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –≤—ã—à–µ
3. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:** `supabase db push`
4. **–û–±–Ω–æ–≤–∏—Ç–µ Dart-–∫–æ–¥** –≤ `filteredPayrollsProvider`:
   ```dart
   final payrollData = await supabase.rpc('calculate_payroll_for_month', 
     params: {'p_year': year, 'p_month': month}
   );
   ```
5. **–ó–∞–º–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç** ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å <2 —Å–µ–∫—É–Ω–¥! üéâ

