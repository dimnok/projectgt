# –ú–æ–¥—É–ª—å –î–æ–≥–æ–≤–æ—Ä—ã (Contracts)

**–î–∞—Ç–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:** 08 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Multi-tenancy (–∏–∑–æ–ª—è—Ü–∏—è –ø–æ `company_id`), –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤ –∏ –ë–î (Audit).

## ‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ
–ú–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ç–∞–±–ª–∏—Ü—ã `contracts` –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–µ–π `contract_files`, `ks2_acts` –∏ `estimates`. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∂–µ—Å—Ç–∫–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î —á–µ—Ä–µ–∑ `company_id`. –ú–æ–¥—É–ª—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ `contractors` –∏ `objects`.

## üìù –û–ø–∏—Å–∞–Ω–∏–µ
–ú–æ–¥—É–ª—å **Contracts** –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏ —Å –∑–∞–∫–∞–∑—á–∏–∫–∞–º–∏ –∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞–º–∏. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–æ–≥–æ–≤–æ—Ä–∞: –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –¥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—ã—Ä–∞–±–æ—Ç–∫–∏ (–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç) –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–æ–≤ –ö–°-2.

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –û–±—ä–µ–∫—Ç—É –∏ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—É.
- –£—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: –ù–î–°, –∞–≤–∞–Ω—Å—ã, –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è, –≥–µ–Ω–ø–æ–¥—Ä—è–¥–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç.
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–∫–∞–Ω–æ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞ (`contract_files`).
- –í–µ–¥–µ–Ω–∏–µ —Å–º–µ—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (`estimates`).
- –†–∞—Å—á–µ—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –≤—ã—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω (`ContractWorksService`).
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—á–µ—Ç –∞–∫—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –ö–°-2 (`ks2_acts`).

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- **–í–ª–∞–¥–µ–Ω–∏–µ (Owner):** `contracts`, `contract_files`, `ks2_acts`, `estimates`.
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (Usage):** `contractors` (–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã), `objects` (–û–±—ä–µ–∫—Ç—ã), `companies` (–Ø–¥—Ä–æ), `profiles` (–°–æ–∑–¥–∞—Ç–µ–ª–∏ –∑–∞–ø–∏—Å–µ–π), `work_items` (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Ä–∞–±–æ—Ç–∫–∏).

## üñºÔ∏è –°–ª–æ–π Presentation
- **–≠–∫—Ä–∞–Ω—ã:**
  - `ContractsListScreen`: –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Å–æ —Å–ø–∏—Å–∫–æ–º, –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π.
  - `ContractFormScreen`: –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è).
  - `ContractsListMobileView` / `ContractsListDesktopView`: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º.
- **–í–∏–¥–∂–µ—Ç—ã:**
  - `ContractDetailsPanel`: –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
  - `ContractCostsInfo`: –ë–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (—Å—É–º–º–∞, –ù–î–°, –≤—ã—Ä–∞–±–æ—Ç–∫–∞).
  - `ContractFilesSection`: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∞.
- **–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
  - `contractProvider`: –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏.
  - `contractWorksSummaryProvider`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫–∏ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É.
  - `contractFilesProvider`: –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞.

## ‚öôÔ∏è –°–ª–æ–π Domain/Data
- **–°—É—â–Ω–æ—Å—Ç–∏:** `Contract`, `ContractFile`, `Ks2Act`, `Estimate` (Freezed, –≤–∫–ª—é—á–∞—é—Ç `companyId`).
- **Use Cases:** `GetContractsUseCase`, `CreateContractUseCase`, `UpdateContractUseCase`, `DeleteContractUseCase` –∏ –¥—Ä.
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:** `ContractRepository` / `ContractRepositoryImpl`, `Ks2Repository` / `Ks2RepositoryImpl`.
- **–ú–æ–¥–µ–ª–∏:** `ContractModel`, `ContractFileModel`, `Ks2ActModel`, `EstimateModel` (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Multi-tenancy).
- **Data Source:** `SupabaseContractDataSource`, `SupabaseContractFileDataSource`, `SupabaseEstimateDataSource` (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `activeCompanyId`).

## üìÇ –î–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤
```
lib/features/
‚îú‚îÄ‚îÄ contracts/
‚îÇ   ‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contract_costs_providers.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ contract_files_providers.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contract_form_content.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contract_form_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contracts_list_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (desktop/mobile views)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ widgets/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ contract_costs_info.dart
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ contract_details_panel.dart
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ contract_works_service.dart
‚îú‚îÄ‚îÄ estimates/
‚îÇ   ‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ estimate_providers.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ estimate_form_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ estimates_list_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ widgets/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ estimate_table_view.dart
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ ks2/
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ks2_repository_impl.dart
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ks2_repository.dart
‚îÇ   ‚îî‚îÄ‚îÄ presentation/
‚îÇ       ‚îú‚îÄ‚îÄ providers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ks2_providers.dart
‚îÇ       ‚îî‚îÄ‚îÄ widgets/
‚îÇ           ‚îú‚îÄ‚îÄ ks2_acts_sheet.dart
‚îÇ           ‚îî‚îÄ‚îÄ ks2_creation_sheet.dart
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Audit)

### –¢–∞–±–ª–∏—Ü—ã
1. **`contracts`**: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä, –¥–∞—Ç–∞, —Å—É–º–º–∞, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã).
   - `company_id` (UUID, NOT NULL) ‚Äî FK –Ω–∞ `companies`.
   - **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `get_my_company_ids()`).
2. **`contract_files`**: –î–æ–∫—É–º–µ–Ω—Ç—ã.
   - `company_id` (UUID, NOT NULL).
   - **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `get_my_company_ids()`).
3. **`estimates`**: –°–º–µ—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏.
   - `company_id` (UUID, NOT NULL).
   - **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `get_my_company_ids()`).
4. **`ks2_acts`**: –ê–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.
   - `company_id` (UUID, NOT NULL).
   - **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `get_my_company_ids()`).

### –ò–Ω–¥–µ–∫—Å—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ `company_id` –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è.
- –§—É–Ω–∫—Ü–∏—è `get_my_company_ids()` (Security Definer) –¥–ª—è RLS.
- RPC `get_estimate_groups` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Å–º–µ—Ç.
- RPC `calculate_contract_works` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Ä–∞–±–æ—Ç–∫–∏.

## üß† –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- **–ò–∑–æ–ª—è—Ü–∏—è:** –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ `activeCompanyId` –Ω–∞ —É—Ä–æ–≤–Ω–µ Data Source –∏ Repository.
- **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞, —Å–º–µ—Ç—ã –∏–ª–∏ –∞–∫—Ç–∞ `company_id` –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **KS-2:** –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ Edge Function `ks2_operations`, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `companyId` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞.
- **–§–∞–π–ª—ã:** –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∫–µ—Ç–µ `contracts`, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –ë–î –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `company_id`.

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Edge Functions:**
  - `ks2_operations`: –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–∫—Ç–æ–≤ –ö–°-2.
- **Database RPC:**
  - `calculate_contract_works(contract_id, object_id)`: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –≤—ã—Ä–∞–±–æ—Ç–∫–∏ –ø–æ —Å–º–µ—Ç–∞–º.
- **Storage:**
  - Bucket `contracts`: –§–∞–π–ª—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: `/{contract_id}/{timestamp}_{filename}`).

## üó∫Ô∏è Roadmap
- üü¢ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è Multi-tenancy (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).
- üü¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–ø–∏—Å–∫–∞ –∏ —Ñ–æ—Ä–º (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).
- üü¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è `company_id` –≤–æ –≤—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –º–æ–¥–µ–ª–∏ (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).
- üü° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è RLS –ø–æ–ª–∏—Ç–∏–∫ (–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤).
- üî¥ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç —Å–º–µ—Ç –∏–∑ Excel (–í –ø–ª–∞–Ω–µ).
- üî¥ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—á–∞—Ç–Ω—ã—Ö —Ñ–æ—Ä–º –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (–í –ø–ª–∞–Ω–µ).
