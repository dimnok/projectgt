# –ú–æ–¥—É–ª—å Estimates (–°–º–µ—Ç—ã)

**–î–∞—Ç–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:** 08 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Multi-tenancy (company_id), –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ RLS —É—Ä–æ–≤–Ω—è –∫–æ–º–ø–∞–Ω–∏–∏, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü `kit_components` –∏ `material_aliases`.

---

## üìå –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ
–ú–æ–¥—É–ª—å –≤–ª–∞–¥–µ–µ—Ç —Ç—Ä–µ–º—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏: `estimates`, `kit_components` –∏ `material_aliases`. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î —á–µ—Ä–µ–∑ `company_id`. –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π `get_my_company_ids()`.

**–í–ê–ñ–ù–û:** –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã Multi-tenancy –≤—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views) –º–æ–¥—É–ª—è —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∞—é—Ç `company_id` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## üìù –û–ø–∏—Å–∞–Ω–∏–µ
–ú–æ–¥—É–ª—å **Estimates** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–Ω–æ-—Å–º–µ—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π:
- –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–º–µ—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π.
- –ò–º–ø–æ—Ä—Ç —Å–º–µ—Ç –∏–∑ Excel (xlsx) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º —Å–∏—Å—Ç–µ–º –∏ –ø–æ–¥—Å–∏—Å—Ç–µ–º.
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞–º–∏ (BOM) —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å–º–µ—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏.
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (mapping) –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∫ —Å–º–µ—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º.
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º "–î–æ–≥–æ–≤–æ—Ä—ã" –∏ "–û–±—ä–µ–∫—Ç—ã".
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–∫—Ç–æ–≤ –ö–°-2.

---

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è (owner):
- `public.estimates` ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–º–µ—Ç—ã.
- `public.kit_components` ‚Äî —Å–æ—Å—Ç–∞–≤ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤.
- `public.material_aliases` ‚Äî —Å–≤—è–∑–∏ –Ω–∞–∑–≤–∞–Ω–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Å–æ —Å–º–µ—Ç–æ–π.

### –¢–∞–±–ª–∏—Ü—ã –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π (usage):
- `public.companies` ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö.
- `public.contracts` ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ —Å–º–µ—Ç—ã –∫ –¥–æ–≥–æ–≤–æ—Ä—É.
- `public.objects` ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ —Å–º–µ—Ç—ã –∫ –æ–±—ä–µ–∫—Ç—É.
- `public.work_items` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–º–µ—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö.

---

## üñºÔ∏è –°–ª–æ–π Presentation

### –≠–∫—Ä–∞–Ω—ã:
- `EstimatesListScreen` ‚Äî —Ä–µ–µ—Å—Ç—Ä —Å–º–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º.
- `EstimateDetailsScreen` ‚Äî —Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥ –ø–æ–∑–∏—Ü–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–º–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `EstimateTableView`).
- `EstimateFormScreen` ‚Äî —Ñ–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏.

### –í–∏–¥–∂–µ—Ç—ã Design System:
- `EstimateTableView` ‚Äî –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º.
- `ImportEstimateFormModal` ‚Äî –ø–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä –∏–º–ø–æ—Ä—Ç–∞ (Design System Dialog/BottomSheet).
- `MaterialsLinkButton` ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–∑–∏—Ü–∏–π.

### –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã (Riverpod):
- `estimateGroupsProvider` ‚Äî —Å–ø–∏—Å–æ–∫ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ—Ç (RPC `get_estimate_groups`).
- `estimatesMappingPagerProvider` ‚Äî –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
- `estimateNotifierProvider` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º CRUD –æ–ø–µ—Ä–∞—Ü–∏–π.

---

## üèóÔ∏è –°–ª–æ–π Domain/Data

- **–°—É—â–Ω–æ—Å—Ç–∏:** `Estimate`, `EstimateCompletionHistory`.
- **Use Cases:** `GetEstimatesUseCase`, `CreateEstimateUseCase`, `UpdateEstimateUseCase`, `DeleteEstimateUseCase`.
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** `EstimateRepositoryImpl` (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç `EstimateDataSource`).
- **–ú–æ–¥–µ–ª–∏:** `EstimateModel` (snake_case, freezed), `EstimateCompletionModel` (–¥–ª—è –æ—Ç—á–µ—Ç–æ–≤).

---

## üìÇ –î–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤
```
lib/features/estimates/
‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îú‚îÄ‚îÄ mixins/          # –õ–æ–≥–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π (delete, edit)
‚îÇ   ‚îú‚îÄ‚îÄ providers/       # Riverpod –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (estimate_providers.dart)
‚îÇ   ‚îú‚îÄ‚îÄ screens/         # EstimatesListScreen, EstimateDetailsScreen, etc.
‚îÇ   ‚îú‚îÄ‚îÄ utils/           # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ widgets/         # –¢–∞–±–ª–∏—Ü—ã, –∫–∞—Ä—Ç–æ—á–∫–∏, –¥–∏–∞–ª–æ–≥–∏
lib/domain/
‚îú‚îÄ‚îÄ entities/            # Estimate.dart
‚îú‚îÄ‚îÄ repositories/        # EstimateRepository.dart
‚îî‚îÄ‚îÄ usecases/estimate/   # CRUD usecases
lib/data/
‚îú‚îÄ‚îÄ datasources/         # EstimateDataSource.dart (Supabase)
‚îú‚îÄ‚îÄ models/              # EstimateModel.dart, EstimateCompletionModel.dart
‚îú‚îÄ‚îÄ repositories/        # EstimateRepositoryImpl.dart
‚îî‚îÄ‚îÄ services/            # ExcelEstimateService.dart
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Audit)

### –¢–∞–±–ª–∏—Ü–∞ `estimates`
- **–ö–æ–ª–æ–Ω–∫–∏:** `id`, `company_id` (not null), `contract_id`, `object_id`, `system`, `subsystem`, `name`, `number`, `unit`, `quantity`, `price`, `total`, `estimate_title`.
- **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω. –ü–æ–ª–∏—Ç–∏–∫–∞: `company_id IN (SELECT get_my_company_ids())`.
- **–ò–Ω–¥–µ–∫—Å—ã:** `idx_estimates_grouping` (title, object, contract), `idx_estimates_sort` (system, subsystem, number).

### –¢–∞–±–ª–∏—Ü–∞ `kit_components`
- **–ö–æ–ª–æ–Ω–∫–∏:** `id`, `company_id`, `parent_estimate_id`, `component_estimate_id`, `qty_per_kit`.
- **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω. –ü–æ–ª–∏—Ç–∏–∫–∞: `company_id IN (SELECT get_my_company_ids())`.

### –¢–∞–±–ª–∏—Ü–∞ `material_aliases`
- **–ö–æ–ª–æ–Ω–∫–∏:** `id`, `company_id`, `estimate_id`, `supplier_id`, `alias_raw`, `normalized_alias` (generated), `multiplier_to_estimate`.
- **RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω. –ü–æ–ª–∏—Ç–∏–∫–∞: `company_id IN (SELECT get_my_company_ids())`.

### üëÅÔ∏è –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)
–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤—ã–±–æ—Ä–∫–∏ –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è Multi-tenancy –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:
1.  **`estimates_with_contracts`**: –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–º–µ—Ç. –í–∫–ª—é—á–∞–µ—Ç `company_id` –∏ `contract_number`.
2.  **`v_work_items_expanded`**: –†–∞–∑–≤–µ—Ä—Ç–∫–∞ —Ä–∞–±–æ—Ç —Å —É—á–µ—Ç–æ–º –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤. –í–∫–ª—é—á–∞–µ—Ç `company_id`.
3.  **`v_kit_components_detailed`**: –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏ –ø–æ–∑–∏—Ü–∏–π. –í–∫–ª—é—á–∞–µ—Ç `company_id`.

---

## ‚öôÔ∏è –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
1. **–ò–∑–æ–ª—è—Ü–∏—è:** –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –æ–±—è–∑–∞–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä `.eq('company_id', activeCompanyId)`.
2. **–ò–º–ø–æ—Ä—Ç:** –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ExcelEstimateService`. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–ª–æ–Ω–æ–∫, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—ã, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Ñ–∞–π–ª–µ.
3. **–ö–æ–º–ø–ª–µ–∫—Ç—ã:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤ –∫–æ–º–ø–ª–µ–∫—Ç (RPC `add_kit_component`) —Å–æ–∑–¥–∞–µ—Ç—Å—è "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è" —Å–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —Å –Ω–æ–º–µ—Ä–æ–º '0', –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–º–µ—Ç–µ, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
4. **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:** –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–∑–∏—Ü–∏–π (similarity) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö.

---

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Edge Functions:**
    - `ks2_operations` ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–æ–≤ –ö–°-2 (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç `companyId`).
    - `excel_parse` ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å–ª–æ–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
- **RPC:**
    - `get_estimate_groups` ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–º–µ—Ç –¥–ª—è —Ä–µ–µ—Å—Ç—Ä–∞.
    - `add_kit_component` ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞.

---

## üó∫Ô∏è Roadmap
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Multi-tenancy –∏ RLS.
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤ (BOM).
- ‚úÖ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
- üü¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–º–µ—Ç –Ω–∞ –ø–µ—á–∞—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã.
- üü° –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∞—É–¥–∏—Ç) —Ü–µ–Ω –≤ —Å–º–µ—Ç–µ.
- üî¥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ì—Ä–∞–Ω–¥-–°–º–µ—Ç–æ–π (xml/arps).
