# –ú–æ–¥—É–ª—å –°–º–µ—Ç—ã (Estimates)

**–î–∞—Ç–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:** 25 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞ (–ü–µ—Ä–µ–Ω–æ—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞–º–∏ –ö–°-6–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫, —É–¥–∞–ª–µ–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞, —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è)
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç—É–∞–ª—å–Ω–æ (Strict Multi-tenancy, RBAC, Material Integration, Animated UI UX, KS-6a with Period Management, Pixel-perfect Header Sync)

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ
- **–í–ª–∞–¥–µ–Ω–∏–µ:** –ú–æ–¥—É–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–ª–∞–¥–µ–µ—Ç —Ç–∞–±–ª–∏—Ü–µ–π `public.estimates`.
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥—É–ª—è ¬´–û–±—ä–µ–∫—Ç—ã¬ª (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `object_ids`) –∏ ¬´–°–∫–ª–∞–¥¬ª (—Ä–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —á–µ—Ä–µ–∑ `material_aliases`).
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `SECURITY DEFINER` RPC-—Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç —É—Ç–µ—á–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä—è–º—ã—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö. –°–º–µ—Ç—ã –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –æ–±—ä–µ–∫—Ç—É (`object_id IS NULL`) –¥–æ—Å—Ç—É–ø–Ω—ã **—Ç–æ–ª—å–∫–æ** –í–ª–∞–¥–µ–ª—å—Ü–∞–º –∫–æ–º–ø–∞–Ω–∏–∏.
- **UI/UX:** –í—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ Desktop –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç `DesktopDialogContent.show()` —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π (`fade` + `scale`).

---

## üìÇ –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è
–ú–æ–¥—É–ª—å **–°–º–µ—Ç—ã** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–Ω—ã–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç. –û–Ω –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–∏–∑ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ—Ç) —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏ —Å–∫–ª–∞–¥—Å–∫–∏–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏.

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- **–ò–º–ø–æ—Ä—Ç –∏–∑ Excel:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ `.xls` –∏ `.xlsx` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–∞—Ä—Å–∏–º–≥–æ–º —á–µ—Ä–µ–∑ Edge Functions.
- **Strict Access Control:** –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å–º–µ—Ç—ã, –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ –∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–º.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ –°–∫–ª–∞–¥–æ–º:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –∫–∞–∂–¥–æ–π —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.
- **–ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** –î–∞–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `work_items` –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
- **–ñ—É—Ä–Ω–∞–ª –ö–°-6–∞:** –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏–¥ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –∏ –∏—Ç–æ–≥–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å—Ç–∫–æ–π –∏ **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ª–µ–≤—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏** (Sticky Columns) –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Å–∫—Ä–æ–ª–ª–µ.
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫–µ–ª–µ—Ç–æ–Ω–æ–≤ (shimmer) –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
- **–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π UX:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ `flutter_animate` –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –¥–µ—Ç–∞–ª—è—Ö –ø–æ–∑–∏—Ü–∏–π –∏ –ø–ª–∞–≤–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–æ–Ω.

---

## üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
–ú–æ–¥—É–ª—å —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º **Clean Architecture**, –æ–¥–Ω–∞–∫–æ —Å–ª–æ–∏ Data –∏ Domain —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ–±—â–∏–µ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫—Ä–æ—Å—Å-–º–æ–¥—É–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π.

### –°–ª–æ–π Presentation (UI)
- `lib/features/estimates/presentation/screens/estimates_list_screen.dart` ‚Äî –†–µ–µ—Å—Ç—Ä —Å–º–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –æ–±—ä–µ–∫—Ç–∞–º.
- `lib/features/estimates/presentation/screens/estimate_desktop_view.dart` ‚Äî –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω —Ä–∞–±–æ—Ç—ã —Å–æ —Å–º–µ—Ç–æ–π –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ. –í–∫–ª—é—á–∞–µ—Ç –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∏ –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º —Å–º–µ—Ç—ã –∏ –∂—É—Ä–Ω–∞–ª–æ–º –ö–°-6–∞.
- `lib/features/estimates/presentation/screens/estimate_details_screen.dart` ‚Äî –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω —Ä–∞–±–æ—Ç—ã —Å–æ —Å–º–µ—Ç–æ–π (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞).
- `lib/features/estimates/presentation/widgets/estimate_table_view.dart` ‚Äî –ö–∞—Å—Ç–æ–º–Ω–∞—è –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –º–µ–Ω—é.
- `lib/features/estimates/presentation/widgets/ks6a_table_view.dart` ‚Äî –¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞ –ö–°-6–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã, —Å—Ç–∞—Ç—É—Å—ã (–ß–µ—Ä–Ω–æ–≤–∏–∫/–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ). –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞–º–∏ –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `estimate_desktop_view.dart`. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∏–∫—Å–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –º–µ–∂–¥—É —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–æ–π —á–∞—Å—Ç—è–º–∏. –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. [docs/estimates/ks6a_journal.md](ks6a_journal.md).
- `lib/features/estimates/presentation/utils/ks6a_processor.dart` ‚Äî –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ö–°-6–∞. –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏ —Ä–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º.
- `lib/features/estimates/presentation/widgets/estimate_edit_dialog.dart` ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `DesktopDialogContent.show()` —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π.
- `lib/features/estimates/presentation/widgets/estimate_item_details_dialog.dart` ‚Äî –û–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ–∑–∏—Ü–∏–∏ —Å –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–∞—Å–∫–∞–¥–Ω—ã–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏ **–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –±–ª–æ–∫–æ–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤** (shimmer-–∑–∞–≥—Ä—É–∑–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π).
- `lib/features/estimates/presentation/screens/import_estimate_form_modal.dart` ‚Äî –ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä –∏–º–ø–æ—Ä—Ç–∞ —Å–º–µ—Ç, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–∏–∞–ª–æ–≥–æ–≤.
- `lib/features/estimates/presentation/providers/estimate_providers.dart` ‚Äî –ù–∞–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (Riverpod), –≤–∫–ª—é—á–∞—è `estimateGroupsProvider` –∏ `estimateCompletionByIdsProvider`.

### –°–ª–æ–π Domain (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
- `lib/domain/entities/estimate.dart` ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.
- `lib/domain/repositories/estimate_repository.dart` ‚Äî –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
- `lib/domain/usecases/estimate/` ‚Äî –ù–∞–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (Get, Create, Update, Delete).

### –°–ª–æ–π Data (–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- `lib/data/datasources/estimate_data_source.dart` ‚Äî –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase RPC.
- `lib/data/models/estimate_model.dart` ‚Äî DTO –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–º–µ—Ç—ã.
- `lib/data/models/estimate_completion_model.dart` ‚Äî –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å –ø–æ–ª—è–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.

---

## üå≤ –î–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤
```text
lib/features/estimates/
‚îî‚îÄ‚îÄ presentation/
    ‚îú‚îÄ‚îÄ mixins/
    ‚îÇ   ‚îî‚îÄ‚îÄ estimate_actions_mixin.dart
    ‚îú‚îÄ‚îÄ providers/
    ‚îÇ   ‚îî‚îÄ‚îÄ estimate_providers.dart
    ‚îú‚îÄ‚îÄ screens/
    ‚îÇ   ‚îú‚îÄ‚îÄ estimate_desktop_view.dart
    ‚îÇ   ‚îú‚îÄ‚îÄ estimate_details_screen.dart
    ‚îÇ   ‚îú‚îÄ‚îÄ estimate_form_screen.dart
    ‚îÇ   ‚îú‚îÄ‚îÄ estimate_mobile_view.dart
    ‚îÇ   ‚îú‚îÄ‚îÄ estimates_list_screen.dart
    ‚îÇ   ‚îî‚îÄ‚îÄ import_estimate_form_modal.dart
    ‚îú‚îÄ‚îÄ utils/
    ‚îÇ   ‚îú‚îÄ‚îÄ estimate_sorter.dart
    ‚îÇ   ‚îî‚îÄ‚îÄ ks6a_processor.dart
    ‚îî‚îÄ‚îÄ widgets/
        ‚îú‚îÄ‚îÄ estimate_completion_history_panel.dart
        ‚îú‚îÄ‚îÄ estimate_details_modal.dart
        ‚îú‚îÄ‚îÄ estimate_edit_dialog.dart
        ‚îú‚îÄ‚îÄ estimate_item_card.dart
        ‚îú‚îÄ‚îÄ estimate_item_details_dialog.dart
        ‚îú‚îÄ‚îÄ estimate_table_view.dart
        ‚îú‚îÄ‚îÄ ks6a_table_view.dart
        ‚îî‚îÄ‚îÄ material_from_receipts_picker.dart
```

---

## üóÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Audit)

### –¢–∞–±–ª–∏—Ü–∞ `public.estimates`
| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|:---|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–∏ |
| company_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é (Multi-tenancy) |
| object_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç (Nullable) |
| contract_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä (Nullable) |
| system | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã |
| subsystem | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã |
| number | TEXT | –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç "–¥-1") |
| name | TEXT | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ |
| quantity | DOUBLE PRECISION | –ü–ª–∞–Ω–æ–≤—ã–π –æ–±—ä–µ–º |
| price | DOUBLE PRECISION | –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É |
| total | DOUBLE PRECISION | –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ (quantity * price) |
| estimate_title | TEXT | –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–º–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ |

### –¢–∞–±–ª–∏—Ü–∞ `public.ks6a_periods` (–ñ—É—Ä–Ω–∞–ª –ö–°-6–∞)
| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|:---|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ |
| company_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é |
| contract_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä |
| start_date | DATE | –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ |
| end_date | DATE | –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ |
| status | ks6a_status | –°—Ç–∞—Ç—É—Å (draft/approved) |

### –¢–∞–±–ª–∏—Ü–∞ `public.ks6a_period_items` (–°—Ç—Ä–æ–∫–∏ –ö–°-6–∞)
| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|:---|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–æ–∫–∏ |
| company_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é |
| period_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–µ—Ä–∏–æ–¥ |
| estimate_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–º–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é |
| quantity | DOUBLE PRECISION | –û–±—ä–µ–º –∑–∞ –ø–µ—Ä–∏–æ–¥ |
| price_snapshot | DOUBLE PRECISION | –¶–µ–Ω–∞ (—Ñ–∏–∫—Å–∞—Ü–∏—è) |

### RLS (Row Level Security)
‚úÖ **–í–∫–ª—é—á—ë–Ω.**
- **Policy: "Strict SELECT/INSERT/UPDATE/DELETE"**
  - –£—Å–ª–æ–≤–∏–µ: `company_id IN (get_my_company_ids())` + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —á–µ—Ä–µ–∑ `check_permission`.
  - –î–ª—è `ks6a_period_items` –∏–∑–º–µ–Ω–µ–Ω–∏—è (U/D) –≤–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏–º–µ–µ—Ç `status = 'draft'`.

---

## ‚öô –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Audit)

### –ê–ª–≥–æ—Ä–∏—Ç–º –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞
1.  **Multi-tenancy:** –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ `company_id`. –î–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º –∫–æ–º–ø–∞–Ω–∏—è–º –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.
2.  **–û–±—ä–µ–∫—Ç–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –í–ª–∞–¥–µ–ª—å—Ü–µ–º, –æ–Ω –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, —á–µ–π `object_id` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –µ–≥–æ –º–∞—Å—Å–∏–≤–µ `profiles.object_ids`.
3.  **Security Definer:** –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç `SECURITY DEFINER` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∞–≤–∞–º–∏, –ø—Ä–∏ —ç—Ç–æ–º –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∂–µ—Å—Ç–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `auth.uid()`.

### –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞ (Execution Mode)
- **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (%):** `(SUM(work_items.quantity) / estimates.quantity) * 100`.
- **–û—Å—Ç–∞—Ç–æ–∫ —Ä–∞–±–æ—Ç:** `estimates.quantity - SUM(work_items.quantity)`.
- **–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:** –î–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π RPC `get_linked_materials_details`.

---

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Edge Functions:**
  - `excel_parse`: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –≤–æ–∑–≤—Ä–∞—â–∞—è JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
  - `generate_vor`: –§–æ—Ä–º–∏—Ä—É–µ—Ç –í–µ–¥–æ–º–æ—Å—Ç—å –û–±—ä–µ–º–æ–≤ –†–∞–±–æ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Å–º–µ—Ç—ã.
- **–°–∫–ª–∞–¥:** –°–≤—è–∑—å —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `material_aliases`. –ö–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è —Å–º–µ—Ç—ã –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–∏–∞—Å–æ–≤ –≤ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö.

---

## üó∫Ô∏è Roadmap
- üü¢ –°—Ç—Ä–æ–≥–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ (RLS + RPC) ‚Äî **Done**
- üü¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Äî **Done**
- üü¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ JOIN –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (RPC) ‚Äî **Done**
- üü¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è UI –±–ª–æ–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (Shimmer + Async) ‚Äî **Done**
- üü¢ –ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –æ–∫–æ–Ω (DesktopDialogContent.show) ‚Äî **Done**
- üü¢ –ñ—É—Ä–Ω–∞–ª –ö–°-6–∞ (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–∞, –¥–≤—É—Ö—Å–ª–æ–π–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã) ‚Äî **Done**
- üü° –ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π ‚Äî **Planned**
- üî¥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é ‚Äî **Planned**
