# Решение: Система комплектов материалов (BOM)

**Дата:** 9 октября 2025  
**Статус:** Проектное решение  
**Приоритет:** 🟡 Средний (важно для точности учёта)

---

## Проблема

**Ситуация:**
Смета: "Монтаж мачты" (1 шт)
- Требуется: 10 шайб + 5 гаек + 5 болтов + 10 м троса
- Все материалы привязаны через алиасы к одной сметной позиции

**Проблема FIFO:**
- FIFO списывает материалы с одного `estimate_id` в порядке поступления
- Если шайб пришло меньше → вместо них списываются гайки!
- Невозможно точно отследить использование каждого компонента

---

## Решение: BOM (Bill of Materials)

### Архитектура

Используем таблицу `kit_components` (уже существует в БД):

```
┌──────────────────────────────────────────────┐
│  estimates: "Монтаж мачты" (ABC)             │
│  - Родительская позиция (комплект)           │
└─────────────────┬────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  kit_components (связь родитель → компоненты)               │
├─────────────────────────────────────────────────────────────┤
│  1. parent_estimate_id: ABC                                 │
│     component_estimate_id: X1 (виртуальная: "Шайба М10")    │
│     qty_per_kit: 10                                         │
│  2. parent_estimate_id: ABC                                 │
│     component_estimate_id: X2 (виртуальная: "Гайка М10")    │
│     qty_per_kit: 5                                          │
│  3. parent_estimate_id: ABC                                 │
│     component_estimate_id: X3 (виртуальная: "Болт М10")     │
│     qty_per_kit: 5                                          │
│  4. parent_estimate_id: ABC                                 │
│     component_estimate_id: X4 (виртуальная: "Трос")         │
│     qty_per_kit: 10                                         │
└─────────────────────────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  estimates: Виртуальные позиции (X1, X2, X3, X4)            │
│  - Создаются автоматически при добавлении компонента        │
│  - number = "0" (признак виртуальной позиции)               │
│  - contract_id = ID договора родительской позиции           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  material_aliases (привязка компонент → материал накладной) │
│  - estimate_id: X1 → "Шайба увеличенная TLW M10"            │
│  - estimate_id: X2 → "Гайка шестигранная HN DIN 934 M10"    │
│  - estimate_id: X3 → "Болт М10×50"                          │
│  - estimate_id: X4 → "Трос оцинк. Ø6мм"                     │
└─────────────────────────────────────────────────────────────┘
```

---

## Как работает FIFO

### Пример использования

**Использовано в работах:**
- 3 "Монтаж мачты" (3 шт × 1 комплект)

**Расчёт использования компонентов:**
1. Шайбы: 3 × 10 = **30 шт** (списываются из X1)
2. Гайки: 3 × 5 = **15 шт** (списываются из X2)
3. Болты: 3 × 5 = **15 шт** (списываются из X3)
4. Трос: 3 × 10 = **30 м** (списывается из X4)

**FIFO-списание (РАЗДЕЛЬНО):**

Компонент X1 (Шайбы):
- Партия 1: 20 шт → использовано 20, остаток 0
- Партия 2: 15 шт → использовано 10, остаток 5

Компонент X2 (Гайки):
- Партия 1: 10 шт → использовано 10, остаток 0
- Партия 2: 10 шт → использовано 5, остаток 5

**Результат:** Нехватка шайб (партия 1) **НЕ влияет** на гайки!

---

## Реализация

### Этап 1: Обновление UI (MaterialsLinkButton)

**Добавить режим "Комплект":**
```dart
// Переключатель: обычная связь / комплект
bool _isKitMode = false;

// При _isKitMode = true:
// 1. Диалог НЕ закрывается после привязки материала
// 2. Для каждого материала запрашивается qty_per_kit
// 3. Создаётся виртуальная позиция + kit_component
```

### Этап 2: Функция создания компонента

```sql
CREATE FUNCTION add_kit_component(
  p_parent_estimate_id uuid,
  p_material_name text,
  p_material_unit text,
  p_qty_per_kit numeric,
  p_alias_raw text
) RETURNS uuid
LANGUAGE plpgsql
AS $$
DECLARE
  v_contract_id uuid;
  v_component_estimate_id uuid;
BEGIN
  -- Получаем contract_id родительской позиции
  SELECT contract_id INTO v_contract_id
  FROM estimates
  WHERE id = p_parent_estimate_id;

  -- Создаём виртуальную сметную позицию
  INSERT INTO estimates (name, unit, contract_id, number)
  VALUES (p_material_name, p_material_unit, v_contract_id, '0')
  RETURNING id INTO v_component_estimate_id;

  -- Добавляем в kit_components
  INSERT INTO kit_components (
    parent_estimate_id,
    component_estimate_id,
    qty_per_kit,
    uom_component
  ) VALUES (
    p_parent_estimate_id,
    v_component_estimate_id,
    p_qty_per_kit,
    p_material_unit
  );

  -- Создаём алиас для привязки к материалу накладной
  INSERT INTO material_aliases (
    estimate_id,
    alias_raw,
    multiplier_to_estimate
  ) VALUES (
    v_component_estimate_id,
    p_alias_raw,
    1.0 -- Для компонента всегда 1:1
  );

  RETURN v_component_estimate_id;
END;
$$;
```

### Этап 3: Обновление расчёта использования

**Функция раскрытия комплектов:**
```sql
CREATE VIEW v_work_items_expanded AS
SELECT
  wi.id,
  wi.work_id,
  CASE
    WHEN kc.id IS NOT NULL THEN kc.component_estimate_id
    ELSE wi.estimate_id
  END AS estimate_id,
  CASE
    WHEN kc.id IS NOT NULL THEN wi.quantity * kc.qty_per_kit
    ELSE wi.quantity
  END AS quantity,
  wi.created_at
FROM work_items wi
LEFT JOIN kit_components kc ON kc.parent_estimate_id = wi.estimate_id;
```

**Использование в FIFO:**
```sql
-- БЫЛО:
SELECT wi.estimate_id, SUM(wi.quantity) FROM work_items wi ...

-- СТАЛО:
SELECT wie.estimate_id, SUM(wie.quantity) FROM v_work_items_expanded wie ...
```

---

## Пример использования (UX)

1. Пользователь открывает кнопку "Связь" для "Монтаж мачты"
2. Включает режим "Комплект" (переключатель)
3. Ищет "Шайба М10" → выбирает → вводит количество: **10**
4. Ищет "Гайка М10" → выбирает → вводит количество: **5**
5. Ищет "Болт М10" → выбирает → вводит количество: **5**
6. Ищет "Трос оцинк" → выбирает → вводит количество: **10**
7. Закрывает диалог

**Результат:** Создано 4 виртуальные позиции + 4 записи в kit_components

---

## Преимущества

1. ✅ Точное списание по компонентам
2. ✅ Прозрачность использования
3. ✅ Гибкость (можно менять состав)
4. ✅ Совместимость (обычные материалы работают как раньше)
5. ✅ Использует существующую архитектуру

---

## Ограничения

1. Виртуальные позиции не отображаются в обычной смете (number = "0")
2. Нужно обучить пользователей новому режиму
3. Нельзя удалить компонент из комплекта (только деактивировать)

---

## Следующие шаги

1. ⏳ Обновить UI: добавить режим "Комплект"
2. ⏳ Создать функцию `add_kit_component()`
3. ⏳ Создать представление `v_work_items_expanded`
4. ⏳ Обновить `v_materials_with_usage` для использования expanded view
5. ⏳ Протестировать на реальных данных
6. ⏳ Обучить пользователей

**Оценка времени:** 4-6 часов

---

**Автор:** AI Assistant  
**Дата:** 9 октября 2025

