# Исправления модуля "Материалы"

## Дата: 8 октября 2025

---

### ✅ Исправление #1: RLS политики для таблицы `materials`

**Проблема:**
- Дублирование политик SELECT (`materials_read` и `materials_select_authenticated`)
- Конфликт политик: `materials_write` (ALL) блокировала INSERT

**Решение:**
- Удалена дублирующая политика `materials_select_authenticated`
- Удалена конфликтная политика `materials_write`
- Созданы раздельные политики:
  - `materials_update_own` (UPDATE) — изменять только свои записи
  - `materials_delete_own` (DELETE) — удалять только свои записи

**Миграция:** `supabase/migrations/fix_materials_rls_policies.sql`

**Результат:** RLS работает корректно, нет конфликтов при INSERT/UPDATE/DELETE

---

### ✅ Исправление #2: Парсинг номера договора в Edge Function

**Проблема:**
- Номер договора "№244 СУБ-07 от 17.05.2024" парсился как "244" (обрезался)
- Номер договора "№173-суб-07 от 25.05.2024" парсился правильно

**Причина:**
- **Edge Function `excel_parse`** использовала регулярку `([^\s]+)` (берёт до первого пробела)
- Код: `s.match(/№\s*([^\s]+)\b/i)` → берёт только "244", теряет " СУБ-07"

**Решение (код как швейцарские часы):**

Исправлена Edge Function `excel_parse` (строки 76-96):

```typescript
// БЫЛО (неправильно):
const m = s.match(/№\s*([^\s]+)\b/i);
contractNumber = m ? m[1] : s;

// СТАЛО (правильно):
let m = s.match(/№\s*(.+?)\s+от\s+/i);           // "№244 СУБ-07 от дата"
if (m) {
  contractNumber = m[1].trim();
} else {
  m = s.match(/№\s*(.+)/i);                      // "№244 СУБ-07"
  if (m) {
    contractNumber = m[1].trim();
  } else if (s.includes(' от ')) {
    contractNumber = s.split(' от ')[0].trim();  // "244 СУБ-07 от дата"
  } else {
    contractNumber = s;                          // как есть
  }
}
```

**Развёрнуто на сервере:**
- ✅ Edge Function обновлена (версия 4)
- ✅ Задеплоено через `mcp_supabase_deploy_edge_function`

**Тестирование:**
```
"№244 СУБ-07 от 17.05.2024" → "244 СУБ-07" ✅
"№173-суб-07 от 25.05.2024" → "173-суб-07" ✅
"244 СУБ-07"                 → "244 СУБ-07" ✅
```

**Результат:** 
- ✅ **ПРОБЛЕМА РЕШЕНА!** Новые загрузки накладных парсят правильно
- ℹ️ PostgreSQL функция и триггер оставлены как дополнительная защита

---

### ✅ Исправление #3: Проверка дублей накладных по договорам

**Проблема:**
- Накладные проверялись на дубли только по `(номер + дата)`
- Одна накладная с номером "0001" от 01.01.2025 не могла быть у РАЗНЫХ договоров
- При повторной загрузке той же накладной для другого договора - отклонялась

**Причина:**
- В таблице `receipts` не было колонки `contract_number`
- Уникальный constraint: `UNIQUE (receipt_number, receipt_date)`

**Решение:**

1. **Таблица `receipts`**: добавлена колонка `contract_number`
   - `NOT NULL` с `DEFAULT ''` (пустая строка если договора нет)
   - Миграция: `add_contract_number_to_receipts_v3.sql`

2. **Новый уникальный constraint**:
   ```sql
   UNIQUE (receipt_number, contract_number, receipt_date)
   ```
   - Одна накладная может быть у РАЗНЫХ договоров
   - Дубль определяется по ТРОЙКЕ полей

3. **Edge Function `receipts_import`** обновлена (версия 4):
   - Добавлен `contract_number` в upsert
   - Изменён `onConflict` на новую комбинацию

**Тестирование:**
```sql
-- Тест 1: Накладная для договора А
INSERT INTO receipts (receipt_number, contract_number, receipt_date)
VALUES ('0001', '244 СУБ-07', '2025-01-01'); -- ✅ OK

-- Тест 2: Та же накладная для договора А (дубль)
INSERT INTO receipts (receipt_number, contract_number, receipt_date)
VALUES ('0001', '244 СУБ-07', '2025-01-01'); -- ❌ ОШИБКА (дубль)

-- Тест 3: Та же накладная для ДРУГОГО договора Б
INSERT INTO receipts (receipt_number, contract_number, receipt_date)
VALUES ('0001', '173-суб-17', '2025-01-01'); -- ✅ OK (разные договора)
```

**Результат:**
- ✅ Накладные с одинаковым номером допустимы для РАЗНЫХ договоров
- ✅ Дубли накладных блокируются в рамках ОДНОГО договора
- ✅ Пустой contract_number (старые данные) = пустая строка ''

---

## Статистика исправлений

| Файл | Тип | Описание |
|------|-----|----------|
| `fix_materials_rls_policies.sql` | Миграция БД | Исправление RLS политик |
| `add_extract_contract_number_function.sql` | Миграция БД | Функция извлечения номера договора |
| `fix_contract_number_parsing.sql` | Миграция БД | Обновление триггера (доп. защита) |
| `add_contract_number_to_receipts_v3.sql` | Миграция БД | Добавление contract_number в receipts |
| `fix_receipts_contract_number_default.sql` | Миграция БД | NOT NULL + constraint для проверки дублей |
| `excel_parse` (сервер) | Edge Function v4 | Парсинг номера договора |
| `receipts_import` (сервер) | Edge Function v4 | Проверка дублей по (номер+договор+дата) |
| `materials_module.md` | Документация | Обновлены RLS, функции, триггеры, проверки |

**Всего:** 5 миграций БД + 2 Edge Functions (на сервере)

---

## ⚠️ Важно: Edge Functions хранятся на сервере!

**Edge Functions НЕ ХРАНЯТСЯ в локальном коде проекта!**

Они развёрнуты и выполняются на сервере Supabase:
- ✅ Код хранится в облаке Supabase
- ✅ Версионность управляется сервером
- ✅ Просмотр/редактирование через MCP Supabase

**Как просмотреть код Edge Function:**
```typescript
// Через MCP Supabase
mcp_supabase_get_edge_function("excel_parse")
// Вернёт актуальный код с сервера (версия 4)
```

**Почему не храним локально:**
- ❌ Конфликты TypeScript (Deno vs Node.js)
- ❌ Дублирование (истина на сервере)
- ❌ Захламление кода клиента

**Если нужно изменить:**
1. Получить код: `mcp_supabase_get_edge_function("excel_parse")`
2. Отредактировать
3. Задеплоить: `mcp_supabase_deploy_edge_function(...)`

---

## Проверка

### ✅ Edge Function `excel_parse` (развёрнута)
```
1. Загрузить накладную с номером договора "№244 СУБ-07 от 17.05.2024"
2. Проверить в таблице materials:
   SELECT contract_number FROM materials 
   WHERE receipt_number = '...' 
   ORDER BY created_at DESC LIMIT 1;
3. Должно быть: '244 СУБ-07' (НЕ '244'!)
```

### ✅ База данных (доп. защита)
```sql
-- Проверить функцию
SELECT extract_contract_number('№244 СУБ-07 от 17.05.2024'); 
-- Результат: '244 СУБ-07' ✅

-- Проверить триггер
INSERT INTO materials (name, contract_number, receipt_number, receipt_date, quantity)
VALUES ('ТЕСТ', '№999 ТЕС-Т от 01.01.2025', '0000', '2025-01-01', 1)
RETURNING contract_number;
-- Результат: '999 ТЕС-Т' ✅

-- Удалить тест
DELETE FROM materials WHERE name = 'ТЕСТ';
```

---

**Автор:** AI Assistant  
**Дата:** 8 октября 2025

