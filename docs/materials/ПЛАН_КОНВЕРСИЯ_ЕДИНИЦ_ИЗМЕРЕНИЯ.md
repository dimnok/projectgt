# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è FIFO

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 9 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ FIFO)

---

## –¶–µ–ª—å

–û–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ FIFO-—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è –º–µ–∂–¥—É —Å–º–µ—Ç–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö.

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π:**
- –†–∞–±–æ—Ç–∞: 10 —à—Ç ‚Üí –ú–∞—Ç–µ—Ä–∏–∞–ª: 20 –º (1 —à—Ç = 2 –º)
- –†–∞–±–æ—Ç–∞: 5 —É–ø–∞–∫ ‚Üí –ú–∞—Ç–µ—Ä–∏–∞–ª: 500 —à—Ç (1 —É–ø–∞–∫ = 100 —à—Ç)
- –†–∞–±–æ—Ç–∞: 100 –º ‚Üí –ú–∞—Ç–µ—Ä–∏–∞–ª: 10 –±—É—Ö—Ç (1 –±—É—Ö—Ç–∞ = 10 –º)

---

## –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üìä –≠—Ç–∞–ø 1: –ê—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (1 —á–∞—Å)

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `multiplier_to_estimate` –≤ `material_aliases`
2. ‚úÖ –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FIFO-—Ä–∞—Å—á—ë—Ç:
   - `v_materials_with_usage` (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
   - `v_materials_usage_period` (—Ñ—É–Ω–∫—Ü–∏—è)
3. ‚úÖ –ò–∑—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥ –º–∞–ø–ø–∏–Ω–≥–∞ (`materials_mapping_screen.dart`)
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

---

### üóÑÔ∏è –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î (2 —á–∞—Å–∞)

#### 2.1 –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_materials_with_usage`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```sql
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ work_items
SELECT COALESCE(SUM(wi.quantity), 0) AS used_qty
FROM work_items wi
WHERE wi.estimate_id = ...
```

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (—Å –∫–æ–Ω–≤–µ—Ä—Å–∏–µ–π):**
```sql
-- CTE –¥–ª—è —Å—É–º–º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å —É—á—ë—Ç–æ–º multiplier
WITH used_by_estimate_converted AS (
  SELECT 
    wi.estimate_id,
    ma.multiplier_to_estimate,
    COALESCE(SUM(wi.quantity), 0) * COALESCE(ma.multiplier_to_estimate, 1) AS used_qty_converted
  FROM work_items wi
  JOIN material_aliases ma ON ma.estimate_id = wi.estimate_id
  WHERE wi.estimate_id IS NOT NULL
  GROUP BY wi.estimate_id, ma.multiplier_to_estimate
)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–º–Ω–æ–∂–∞–µ–º `wi.quantity` –Ω–∞ `multiplier_to_estimate`
- –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö –ú–ê–¢–ï–†–ò–ê–õ–ê (–Ω–µ —Å–º–µ—Ç—ã)

#### 2.2 –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `v_materials_usage_period`

–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∫ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥.

#### 2.3 –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ multiplier
CREATE FUNCTION validate_material_alias_multiplier()
RETURNS trigger AS $$
BEGIN
  IF NEW.multiplier_to_estimate <= 0 THEN
    RAISE EXCEPTION 'Multiplier must be positive';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_validate_multiplier
BEFORE INSERT OR UPDATE ON material_aliases
FOR EACH ROW EXECUTE FUNCTION validate_material_alias_multiplier();
```

---

### üíª –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (3 —á–∞—Å–∞)

#### 3.1 –≠–∫—Ä–∞–Ω –º–∞–ø–ø–∏–Ω–≥–∞: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç"

**–§–∞–π–ª:** `lib/features/materials/presentation/screens/materials_mapping_screen.dart`

**–î–æ–±–∞–≤–∏—Ç—å:**
```dart
// –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
TextField(
  decoration: InputDecoration(
    labelText: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏',
    hintText: '1.0 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)',
    helperText: '–ù–∞–ø—Ä–∏–º–µ—Ä: 1 —à—Ç = 2 –º ‚Üí –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 2.0',
  ),
  keyboardType: TextInputType.numberWithOptions(decimal: true),
  onChanged: (value) {
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ state
  },
)
```

#### 3.2 –£–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –µ–¥–∏–Ω–∏—Ü

```dart
// –í–∏–¥–∂–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
if (materialUnit != estimateUnit) {
  WarningCard(
    title: '–ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è',
    message: '–ú–∞—Ç–µ—Ä–∏–∞–ª: $materialUnit, –°–º–µ—Ç–∞: $estimateUnit',
    action: '–£–∫–∞–∂–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏',
  );
}
```

#### 3.3 –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞

```dart
// –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
Row(
  children: [
    Text('1 $estimateUnit = '),
    SizedBox(
      width: 60,
      child: TextField(/* –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ */),
    ),
    Text(' $materialUnit'),
  ],
)
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç multiplier
```

---

### üß™ –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2 —á–∞—Å–∞)

#### 4.1 –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

```sql
-- –¢–µ—Å—Ç 1: –ö–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª (—à—Ç ‚Üí –º)
INSERT INTO material_aliases (estimate_id, alias_raw, multiplier_to_estimate)
VALUES ('...', '–ö–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª –ü–í–•', 2.0);  -- 1 —à—Ç = 2 –º

-- –¢–µ—Å—Ç 2: –°–∞–º–æ—Ä–µ–∑—ã (—É–ø–∞–∫ ‚Üí —à—Ç)
INSERT INTO material_aliases (estimate_id, alias_raw, multiplier_to_estimate)
VALUES ('...', '–°–∞–º–æ—Ä–µ–∑—ã 3.5x25', 100.0);  -- 1 —É–ø–∞–∫ = 100 —à—Ç
```

#### 4.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ FIFO

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: 10 —à—Ç –∫–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª–æ–≤
-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å–ø–∏—Å–∞–Ω–æ 20 –º –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω–æ–π
SELECT used, remaining FROM v_materials_with_usage
WHERE estimate_id = '...' AND name LIKE '%–ö–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª%';
```

---

### üìö –≠—Ç–∞–ø 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (1 —á–∞—Å)

1. –û–±–Ω–æ–≤–∏—Ç—å `materials_module.md`:
   - –†–∞–∑–¥–µ–ª "–ú–∞–ø–ø–∏–Ω–≥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"
   - –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –µ–¥–∏–Ω–∏—Ü

2. –î–æ–±–∞–≤–∏—Ç—å –≤ `–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø_–ú–û–î–£–õ–¨_–ú–ê–¢–ï–†–ò–ê–õ–´.md`:
   - –ù–æ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #4: –ö–æ–Ω–≤–µ—Ä—Å–∏—è –µ–¥–∏–Ω–∏—Ü

3. –°–æ–∑–¥–∞—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
   - –ö–∞–∫ —É–∫–∞–∑–∞—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
   - –ü—Ä–∏–º–µ—Ä—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–æ–Ω–≤–µ—Ä—Å–∏–π

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–æ—Ä–º—É–ª–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

```
–°–ø–∏—Å–∞–Ω–∏–µ –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞ = 
  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö —Å–º–µ—Ç—ã √ó multiplier_to_estimate

–ü—Ä–∏–º–µ—Ä:
  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 10 —à—Ç –∫–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª–æ–≤
  Multiplier: 2.0 (1 —à—Ç = 2 –º)
  –°–ø–∏—Å–∞–Ω–∏–µ: 10 √ó 2.0 = 20 –º –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω–æ–π
```

### –û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)

```
–û—Å—Ç–∞—Ç–æ–∫ –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö —Å–º–µ—Ç—ã = 
  –û—Å—Ç–∞—Ç–æ–∫ –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞ √∑ multiplier_to_estimate

–ü—Ä–∏–º–µ—Ä:
  –û—Å—Ç–∞—Ç–æ–∫: 50 –º –≤ –Ω–∞–∫–ª–∞–¥–Ω–æ–π
  Multiplier: 2.0
  –û—Å—Ç–∞—Ç–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 50 √∑ 2.0 = 25 —à—Ç
```

---

## –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

| –≠—Ç–∞–ø | –í—Ä–µ–º—è |
|------|-------|
| 1. –ê—É–¥–∏—Ç | 1 —á–∞—Å |
| 2. –ë–î | 2 —á–∞—Å–∞ |
| 3. UI | 3 —á–∞—Å–∞ |
| 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 2 —á–∞—Å–∞ |
| 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 1 —á–∞—Å |
| **–ò–¢–û–ì–û** | **9 —á–∞—Å–æ–≤** |

---

## –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (–º¬≤ ‚Üí –º √ó –º)**
   - –ü–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
   - –¢—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Ñ–æ—Ä–º—É–ª

2. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–∏–∞—Å—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ estimate_id**
   - –ö–∞–∂–¥—ã–π –∞–ª–∏–∞—Å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π multiplier
   - –ù—É–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∞–ª–∏–∞—Å–∞

3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
   - –°—Ç–∞—Ä—ã–µ –∞–ª–∏–∞—Å—ã –±–µ–∑ multiplier (NULL) ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1.0
   - –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `COALESCE(multiplier_to_estimate, 1)`

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø–ª–∞–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `v_materials_with_usage`
3. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UI –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
4. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 9 –æ–∫—Ç—è–±—Ä—è 2025

