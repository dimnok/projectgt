# –ú–æ–¥—É–ª—å –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (Materials)
**–î–∞—Ç–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:** 8 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞ (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Multi-tenancy)

---

## –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö

> **–í–Ω–∏–º–∞–Ω–∏–µ:**
> - –ú–æ–¥—É–ª—å –≤–ª–∞–¥–µ–µ—Ç **4 —Ç–∞–±–ª–∏—Ü–∞–º–∏**: `materials`, `receipts`, `material_aliases`, `kit_components`
> - **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç `company_id` –∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (RLS).
> - **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –≥–∏–±—Ä–∏–¥–Ω–∞—è ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö + –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–º–µ—Ç–∞–º —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã
> - **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: 
>   - `companies` ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª—è
>   - `estimates` (—Å–º–µ—Ç—ã) ‚Äî –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º –ø–æ–∑–∏—Ü–∏—è–º
>   - `contractors` (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã) ‚Äî –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
>   - `work_items` (–ø–æ–∑–∏—Ü–∏–∏ —Ä–∞–±–æ—Ç) ‚Äî –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
> - **–ú–µ—Ç–æ–¥ —Å–ø–∏—Å–∞–Ω–∏—è**: FIFO (First In, First Out) **—Å—Ç—Ä–æ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –∫–æ–º–ø–∞–Ω–∏–∏**
> - **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å**: –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_materials_with_usage` –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —É—á—ë—Ç–æ–º Multi-tenancy

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è

–ú–æ–¥—É–ª—å **–ú–∞—Ç–µ—Ä–∏–∞–ª—ã** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–ø–∏—Å–∞–Ω–∏–µ–º –ø–æ –º–µ—Ç–æ–¥—É FIFO (First In, First Out). 

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –º–æ–¥—É–ª—å

–ú–æ–¥—É–ª—å —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É **—Å–∫–≤–æ–∑–Ω–æ–≥–æ —É—á—ë—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
- –ò–º–ø–æ—Ä—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏–∑ Excel/CSV –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
- –ü—Ä–∏–≤—è–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∫ —Å–º–µ—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º (—á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –†–∞—Å—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –º–µ—Ç–æ–¥—É FIFO —Å —É—á—ë—Ç–æ–º –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ –∫–æ–º–ø–∞–Ω–∏–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (–ø–æ –Ω–æ–º–µ—Ä—É, –¥–∞—Ç–µ, –¥–æ–≥–æ–≤–æ—Ä—É –∏ –∫–æ–º–ø–∞–Ω–∏–∏)

### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

1. **–ò–º–ø–æ—Ä—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ Excel/CSV, –ø–∞—Ä—Å–∏–Ω–≥, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ `company_id`
2. **–ú–∞–ø–ø–∏–Ω–≥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤** ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∫ —Å–º–µ—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã
3. **–£–º–Ω—ã–π –ø–æ–∏—Å–∫** ‚Äî –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º trigram similarity –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
4. **FIFO-—Å–ø–∏—Å–∞–Ω–∏–µ** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É "–ø–µ—Ä–≤—ã–π –ø—Ä–∏—à—ë–ª ‚Äî –ø–µ—Ä–≤—ã–π —É—à—ë–ª"
5. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** ‚Äî –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º, –¥–æ–≥–æ–≤–æ—Ä–∞–º, –¥–∞—Ç–∞–º, –ø—Ä–∏–≤—è–∑–∫–µ –∫ —Å–º–µ—Ç–µ
6. **–≠–∫—Å–ø–æ—Ä—Ç** ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Excel –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–ò–∑–æ–ª—è—Ü–∏—è Multi-tenancy**: –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–¥–µ–ª–µ–Ω—ã —á–µ—Ä–µ–∑ RLS.
- **FIFO —Å—Ç—Ä–æ–≥–æ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É**: –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞—Ä—Ç–∏–π —Ç–æ–≥–æ –∂–µ –¥–æ–≥–æ–≤–æ—Ä–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Å–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è.
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –æ—Å—Ç–∞—Ç–∫–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –ª–µ—Ç—É —á–µ—Ä–µ–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_materials_with_usage`, —É—á–∏—Ç—ã–≤–∞—é—â–µ–µ `company_id`.
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —É—á–∏—Ç—ã–≤–∞—é—Ç `company_id`.
- **–£–º–Ω—ã–π –ø–æ–∏—Å–∫**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pg_trgm —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è

1. **`materials`** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (–≤–ª–∞–¥–µ–ª–µ—Ü: –∫–æ–º–ø–∞–Ω–∏—è)
2. **`receipts`** ‚Äî —Ä–µ–µ—Å—Ç—Ä –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (–≤–ª–∞–¥–µ–ª–µ—Ü: –∫–æ–º–ø–∞–Ω–∏—è)
3. **`material_aliases`** ‚Äî –∞–ª–∏–∞—Å—ã –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ —Å–º–µ—Ç–∞–º (–≤–ª–∞–¥–µ–ª–µ—Ü: –∫–æ–º–ø–∞–Ω–∏—è)
4. **`kit_components`** ‚Äî —Å–æ—Å—Ç–∞–≤ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤ (BOM) –¥–ª—è —Å–º–µ—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–≤–ª–∞–¥–µ–ª–µ—Ü: –∫–æ–º–ø–∞–Ω–∏—è)

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π

- **`companies`** ‚Äî –∫–æ–º–ø–∞–Ω–∏–∏ (–∫–æ—Ä–Ω–µ–≤–æ–π –≤–ª–∞–¥–µ–ª–µ—Ü –¥–∞–Ω–Ω—ã—Ö)
- **`estimates`** ‚Äî —Å–º–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã)
- **`contracts`** ‚Äî –¥–æ–≥–æ–≤–æ—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ FIFO –≤ —Ä–∞–º–∫–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞)
- **`contractors`** ‚Äî –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã/–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –∞–ª–∏–∞—Å–æ–≤)
- **`work_items`** ‚Äî –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞–±–æ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤)

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Ñ–∞–π–ª—ã –º–æ–¥—É–ª—è

### Presentation/UI (—ç–∫—Ä–∞–Ω—ã, –≤–∏–¥–∂–µ—Ç—ã, –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)

**–≠–∫—Ä–∞–Ω—ã:**
- `material_screen.dart` ‚Äî –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Å —Ç–∞–±–ª–∏—Ü–µ–π –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- `materials_mapping_screen.dart` ‚Äî —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ —Å–º–µ—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º

**–í–∏–¥–∂–µ—Ç—ã:**
- `materials_link_button.dart` ‚Äî –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ —Å —É–º–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
- `materials_import_action.dart` ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –∏–º–ø–æ—Ä—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º `company_id`
- `materials_export_action.dart` ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
- `materials_mapping_action.dart` ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ –º–∞–ø–ø–∏–Ω–≥—É
- `materials_search.dart` ‚Äî –ø–æ–∏—Å–∫ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–æ–º–ø–∞–Ω–∏–∏

**–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã (Riverpod):**
- `materials_providers.dart` ‚Äî –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ `activeCompanyIdProvider`
- `materials_pager.dart` ‚Äî –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ `company_id`
- `materials_mapping_providers.dart` ‚Äî –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –º–∞–ø–ø–∏–Ω–≥–∞ —Å —É—á—ë—Ç–æ–º Multi-tenancy

### Domain (—Å—É—â–Ω–æ—Å—Ç–∏, use cases)

–ú–æ–¥—É–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π.
- `material_item.dart` ‚Äî —Ç–µ–ø–µ—Ä—å –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å (Freezed)

### Data (–º–æ–¥–µ–ª–∏, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, data sources)

**–ú–æ–¥–µ–ª–∏:**
- `material_item.dart` ‚Äî –º–æ–¥–µ–ª—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (Freezed + json_serializable, —Å–æ–¥–µ—Ä–∂–∏—Ç `companyId`)

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:**
- `materials_repository.dart` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä `company_id`
- `materials_import_repository.dart` ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ `activeCompanyId` –≤ Edge Functions

---

## –î–µ—Ä–µ–≤–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥—É–ª—è

```
lib/features/materials/
‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ material_screen.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ materials_mapping_screen.dart
‚îÇ   ‚îú‚îÄ‚îÄ widgets/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials_link_button.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials_import_action.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials_export_action.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials_mapping_action.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials_search.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ materials_date_filter.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ contracts_filter_chips.dart
‚îÇ   ‚îî‚îÄ‚îÄ providers/
‚îÇ       ‚îú‚îÄ‚îÄ materials_providers.dart
‚îÇ       ‚îú‚îÄ‚îÄ materials_pager.dart
‚îÇ       ‚îî‚îÄ‚îÄ materials_mapping_providers.dart
‚îî‚îÄ‚îÄ data/
    ‚îú‚îÄ‚îÄ models/
    ‚îÇ   ‚îú‚îÄ‚îÄ material_item.dart
    ‚îÇ   ‚îî‚îÄ‚îÄ similar_estimate.dart
    ‚îú‚îÄ‚îÄ repositories/
    ‚îÇ   ‚îú‚îÄ‚îÄ materials_repository.dart
    ‚îÇ   ‚îî‚îÄ‚îÄ materials_import_repository.dart
    ‚îî‚îÄ‚îÄ parsers/
        ‚îî‚îÄ‚îÄ receipts_remote_parser.dart
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Multi-tenancy Audit)

### 1. –¢–∞–±–ª–∏—Ü–∞ `materials` (–ú–∞—Ç–µ—Ä–∏–∞–ª—ã)

**RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è –ø–æ `company_id`)

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|---------|-----|----------|----------------|----------------------|
| `id` | uuid | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | `gen_random_uuid()` |
| `company_id` | uuid | FK –∫ `public.companies.id` | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** | ‚Äî |
| `name` | text | –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | ‚Äî |
| `unit` | text | –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `quantity` | numeric | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `price` | numeric | –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `total` | numeric | –°—É–º–º–∞ (`quantity * price`) | Generated | `quantity * price` |
| `receipt_id` | uuid | FK –∫ `receipts.id` | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `receipt_number` | text | –ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `receipt_date` | date | –î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `contract_number` | text | –ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `file_url` | text | URL —Ñ–∞–π–ª–∞ –≤ Storage | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |
| `created_at` | timestamptz | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | `now()` |
| `created_by` | uuid | FK –∫ `auth.users.id` | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚Äî |

**–ò–Ω–¥–µ–∫—Å—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–æ):**
- `uq_materials_receipt_row`: UNIQUE (`company_id`, `receipt_id`, `lower(name)`, `unit`, `quantity`, `price`)

---

### 2. –¢–∞–±–ª–∏—Ü–∞ `receipts` (–ù–∞–∫–ª–∞–¥–Ω—ã–µ)

**RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è –ø–æ `company_id`)

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|---------|-----|----------|----------------|
| `id` | uuid | PK | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `company_id` | uuid | FK –∫ `companies` | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** |
| `receipt_number` | text | –ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `receipt_date` | date | –î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `contract_number` | text | –ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `onConflict`: (`receipt_number`, `contract_number`, `receipt_date`, `company_id`)

---

### 3. –¢–∞–±–ª–∏—Ü–∞ `material_aliases`

**RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è –ø–æ `company_id`)

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|---------|-----|----------|----------------|
| `id` | uuid | PK | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `company_id` | uuid | FK –∫ `companies` | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** |
| `estimate_id` | uuid | FK –∫ `estimates` | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `alias_raw` | text | –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω–æ–π | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `multiplier_...`| numeric | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |

---

### 4. –¢–∞–±–ª–∏—Ü–∞ `kit_components`

**RLS:** ‚úÖ –í–∫–ª—é—á—ë–Ω (–ò–∑–æ–ª—è—Ü–∏—è –ø–æ `company_id`)

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|---------|-----|----------|----------------|
| `id` | uuid | PK | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `company_id` | uuid | FK –∫ `companies` | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** |
| `parent_estimate_id` | uuid | FK –∫ `estimates` | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `component_estimate_id`| uuid | FK –∫ `estimates` | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |

---

## –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_materials_with_usage`

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (08.01.2026):** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Multi-tenancy.
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `company_id`.
- –†–∞—Å—á—ë—Ç FIFO (`PARTITION BY`) —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç `estimate_id`, `contract_number` –ò `company_id`.
- –°–≤—è–∑–∏ —Å —Ä–∞–±–æ—Ç–∞–º–∏ (`v_work_items_expanded`) –∏ –∞–ª–∏–∞—Å–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ `company_id`.

---

## Edge Functions (Multi-tenancy Support)

### 1. `receipts_import`
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `companyId`.
- –í—ã–ø–æ–ª–Ω—è–µ—Ç `upsert` –≤ `receipts` –∏ `insert` –≤ `materials` —Å —É–∫–∞–∑–∞–Ω–∏–µ–º `company_id`.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–∞–Ω–∏–∏.

### 2. `receipts-attach-fileurl`
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `companyId`.
- –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `file_url` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–µ–π.

---

## –§—É–Ω–∫—Ü–∏–∏ PostgreSQL (RPC)

### 1. `search_materials_by_similarity`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: `v.company_id IN (SELECT public.get_my_company_ids())`.
- –ü–æ–∏—Å–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### 2. `find_similar_estimates`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: `e.company_id IN (SELECT public.get_my_company_ids())`.
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ç–æ–ª—å–∫–æ —Å–º–µ—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏.

### 3. `v_materials_usage_period`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `company_id` –¥–ª—è –≤—Å–µ—Ö CTE (–∞–ª–∏–∞—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —Ä–∞–±–æ—Ç—ã).
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç—á—ë—Ç–∞—Ö.

### 4. `get_kit_components_with_names`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `company_id` —á–µ—Ä–µ–∑ `get_my_company_ids()`.

---

## RLS –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–í—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
```sql
USING (company_id IN (SELECT public.get_my_company_ids()))
```
–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏—é –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ—Å—Ç–æ–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

---

## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –ü—Ä–æ—Ü–µ—Å—Å –º–∞–ø–ø–∏–Ω–≥–∞ (–û–±–Ω–æ–≤–ª–µ–Ω–æ)
–ü—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∫ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏:
1. –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–æ—Ö–æ–∂–∏–µ —Ä–∞–±–æ—Ç—ã **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏**.
2. –°–æ–∑–¥–∞–≤–∞–µ–º—ã–π –∞–ª–∏–∞—Å –≤ `material_aliases` –ø–æ–ª—É—á–∞–µ—Ç `company_id` –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.
3. –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ (—É–º–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞) —Ç–∞–∫–∂–µ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç `company_id`.

### –ü—Ä–æ—Ü–µ—Å—Å –∏–º–ø–æ—Ä—Ç–∞ (–û–±–Ω–æ–≤–ª–µ–Ω–æ)
1. –ü–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º Flutter –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `activeCompanyId`.
2. Edge Function –ø–æ–ª—É—á–∞–µ—Ç ID –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ "–ø–µ—Ä–µ–º–µ—à–∞—é—Ç—Å—è" —Å –¥—Ä—É–≥–∏–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏.
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –≤ UI –¥–∏–∞–ª–æ–≥–µ —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç `company_id`.

---

## –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è (Roadmap)

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ ‚úÖ
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è Multi-tenancy –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –∏ RLS
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `company_id` –≤–æ –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Edge Functions –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ä–µ–¥–µ
- ‚úÖ –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –∏ –º–∞–ø–ø–∏–Ω–≥ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç FIFO –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏

### –í –ø–ª–∞–Ω–∞—Ö üîÑ
- üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è **Inventory** (–°–∫–ª–∞–¥) —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏
- üîÑ –ú–∞—Å—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª–∏–∞—Å–∞–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Å –æ–±–µ–∑–ª–∏—á–∏–≤–∞–Ω–∏–µ–º)

---

**–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è:** 8 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞
**,file_path: