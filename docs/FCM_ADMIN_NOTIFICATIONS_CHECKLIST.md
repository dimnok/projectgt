## FCM: —á–µ–∫‚Äë–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è PUSH –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ (iOS/Android)

–°—Ç–∞—Ç—É—Å: –ê–ö–¢–ò–í–ù–û. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—Ä–æ–¥-—Å—Ä–µ–¥–µ FCM HTTP v1.

–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–æ–¥–∫–∞ (—É—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤): admin_count=1, raw_tokens_count=1, tokens_total=1, sent=1.

### –ü—Ä–∏–º–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

- –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã:
```text
Title: üîì –°–º–µ–Ω–∞ - –û–¢–ö–†–´–¢–ê
Body:
üìç –û–±—ä–µ–∫—Ç: {objectName}
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {userName}
üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {employeesCount}
```

- –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã:
```text
Title: üîí –°–º–µ–Ω–∞ - –ó–ê–ö–†–´–¢–ê
Body:
üìç –û–±—ä–µ–∫—Ç: {objectName}
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {userName}
üí∞ –°—É–º–º–∞: 125 000 ‚ÇΩ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
‚öôÔ∏è –í—ã—Ä–∞–±–æ—Ç–∫–∞: 25 000 ‚ÇΩ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
```

### –û–±–ª–∞—Å—Ç—å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- [x] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PUSH —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º (`profiles.role='admin'`), —Å—Ç–∞—Ç—É—Å `status=true` –∏–ª–∏ `NULL`.
- [x] –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã iOS –∏ Android (web –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π).
- [x] –ò—Å–ø–æ–ª—å–∑—É–µ–º Supabase Edge Function `send_admin_work_event` (v32). CORS –≤–∫–ª—é—á—ë–Ω, `verify_jwt=true`. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º —Å –ø—Ä–æ–±–µ–ª–∞–º–∏.

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–º–∏–Ω–∏–º—É–º)
- [x] –ö–ª–∏–µ–Ω—Ç: –≤—ã–∑–æ–≤ `send_admin_work_event` —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `Authorization: Bearer <accessToken>`; —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `debugPrint`.
- [x] –ë–î: `public.user_tokens` —Å RLS –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å—é `(installation_id, platform)`; `token` –≥–ª–æ–±–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª–µ–Ω; `is_active` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.
- [x] Edge Function: —á–∏—Ç–∞–µ—Ç –ë–î —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π service‚Äë–∫–ª–∏–µ–Ω—Ç (–æ–±—Ö–æ–¥–∏—Ç RLS), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ FCM HTTP v1.
- [x] iOS: `aps-environment=production` (Ad Hoc/TestFlight), APNs .p8 (Key ID `TYMLTYTH4P`, Team ID `L37HR2KV4M`, Sandbox & Production) –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Firebase.
- [x] Android: `google-services.json` –ø–æ–¥–∫–ª—é—á—ë–Ω, FCM –∞–∫—Ç–∏–≤–µ–Ω.

### –¢—Ä–µ–±—É–µ–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã (Supabase ‚Üí Secrets)
- `SERVICE_ACCOUNT` ‚Äî —Å–µ—Ä–≤–∏—Å–Ω—ã–π JSON –¥–ª—è FCM HTTP v1.
- `SERVICE_ROLE_KEY` ‚Äî –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è Supabase (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ `profiles`/`user_tokens`).

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ Edge Function `send_admin_work_event`
- –í—Ö–æ–¥: `{ action: 'open' | 'close', work_id: UUID }`, JWT –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (`verify_jwt=true`).
- –§–∏–ª—å—Ç—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: –±–µ—Ä—ë–º `profiles.role='admin'` —Å–æ `status=true|NULL`; –ø–æ–ª—É—á–∞–µ–º –∏—Ö –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ `user_tokens` –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º iOS/Android.
- –û—Ç–≤–µ—Ç (JSON): –≤–∫–ª—é—á–∞–µ—Ç –º–∏–Ω–∏–º—É–º `{ sent, total, admin_count, raw_tokens_count, tokens_total }`.
- –õ–æ–≥–∏: `start`, `no_tokens` (–µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ), `summary` —Å –∫–ª—é—á–∞–º–∏ –≤—ã—à–µ.

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ `tokens_total: 0`)
1) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç `Authorization: Bearer <accessToken>` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏.
2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:
   - `profiles`: —É –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `role='admin'` –∏ `status=true` –∏–ª–∏ `NULL`.
   - `user_tokens`: –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ —Å –µ–≥–æ `user_id`, `is_active=true`, `platform in ('ios','android')`.
3) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã `SERVICE_ROLE_KEY` –∏ `SERVICE_ACCOUNT` –∑–∞–¥–∞–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ Supabase.
4) iOS: –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–±–æ—Ä–∫–∏ –∏ —Å—Ä–µ–¥—ã APNs (Ad Hoc/TestFlight ‚Üí production), `.p8` –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω, bundle id –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.
5) –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ FCM v1 (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤–Ω–µ —Ñ—É–Ω–∫—Ü–∏–∏).

### –ù—é–∞–Ω—Å—ã –∑–∞–ø–∏—Å–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É/–ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∑–∞ —Å—á—ë—Ç `UNIQUE (installation_id, platform)`.
- –ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É; —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è `is_active=false`.
- `onTokenRefresh` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å debounce; `token` —É–Ω–∏–∫–∞–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ.

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ next steps (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü–æ–∫–∞–∑ SnackBar `{sent}/{total}` –≤ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã.
- –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ (–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é) —ç–º–æ–¥–∑–∏.

### –ò—Å—Ç–æ—Ä–∏—è
- v29: —Ñ–∏–∫—Å ¬´–Ω–µ–≤–∏–¥–∏–º—ã—Ö¬ª —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑-–∑–∞ RLS ‚Äî —á—Ç–µ–Ω–∏–µ `profiles`/`user_tokens` —á–µ—Ä–µ–∑ service‚Äë–∫–ª–∏–µ–Ω—Ç; –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ –∏ CORS.
