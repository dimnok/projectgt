# Привязка пользователя к карточке сотрудника (1:1)

Документ описывает реализованную логику привязки профиля пользователя к карточке сотрудника и связанные изменения в приложении и БД.

## Цели
- Дать администратору возможность связать профиль пользователя с соответствующей карточкой сотрудника (1:1).
- Отображать у пользователя (для админа) привязанного сотрудника и использовать связь в функционале (например, финансовая информация).

## Изменения в UI

- Экран профиля пользователя `features/profile/presentation/screens/profile_screen.dart`:
  - В блоке информации добавлено поле "Привязанный сотрудник" (только для роли admin).
    - Виджет: `ProfileLinkedEmployeeInfo` (`features/profile/presentation/widgets/profile_employee_link_info.dart`).
    - Загружает список сотрудников один раз в `initState` и отображает ФИО привязанного сотрудника.
  - В форме редактирования профиля (нижний лист):
    - Добавлено поле выбора сотрудника только для админа на базе кастомного `GTDropdown` — `ProfileEmployeeLinkEditField` (`features/profile/presentation/widgets/profile_employee_link_edit_field.dart`).
    - Поддерживается очистка выбора (крестик).

- Навигация/права:
  - Отображение "Привязанный сотрудник" скрыто у обычных пользователей.
  - Привязку может выполнять только администратор (доступ к полю выбора есть только у админа).

## Логика данных

- Сохранение привязки:
  - В форме редактирования администратор выбирает сотрудника → `employee_id` попадает в `profile.object['employee_id']` и затем в `profiles.employee_id`.
  - Источник данных: `lib/data/datasources/profile_data_source.dart`
    - Чтение профиля: проксируем колонку `employee_id` в `profile.object['employee_id']` для совместимости UI.
    - Обновление профиля: извлекаем `employee_id` из `profile.object` и пишем его в колонку `profiles.employee_id` (при очистке ставим NULL).

- Чтение привязки:
  - `ProfileLinkedEmployeeInfo` берёт `employee_id` из `profile.object` и отображает ФИО из кэша/списка сотрудников.

## Изменения в БД

- Таблица `profiles`:
  - Добавлена колонка `employee_id uuid NULL`.
  - Внешний ключ: `FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE SET NULL`.
  - Уникальный индекс: `profiles_employee_id_unique ON profiles(employee_id) WHERE employee_id IS NOT NULL` (связь 1:1).

- RLS:
  - Кастомные политики, добавленные ранее, удалены по просьбе. На текущем этапе RLS для `profiles` использует существующие политики проекта. При необходимости можно вернуть политику "Admins can update employee link".

## Файлы
- `features/profile/presentation/screens/profile_screen.dart` — отображение поля для админа, кнопка "Финансовая информация".
- `features/profile/presentation/widgets/profile_employee_link_info.dart` — отображение привязанного сотрудника, безопасная загрузка списка сотрудников.
- `features/profile/presentation/widgets/profile_employee_link_edit_field.dart` — выпадающий список выбора сотрудника (GTDropdown).
- `data/datasources/profile_data_source.dart` — чтение/обновление `employee_id` в БД и проксирование в `object` для UI.

## Тест-кейсы (быстрые)
1. Войти под админом → открыть профиль любого пользователя → увидеть поле "Привязанный сотрудник".
2. Нажать редактирование профиля → выбрать сотрудника → сохранить → перезагрузить профиль → увидеть привязку.
3. Очистить привязку → сохранить → поле отображает "Не привязан".
4. Войти под обычным пользователем → открыть свой профиль → поле "Привязанный сотрудник" отсутствует.

## Риски/нюансы
- При больших списках сотрудников загрузка выполняется лениво один раз и кэшируется состоянием `employeeProvider`.
- При изменении схемы (переименование полей) нужно синхронизировать `profile_data_source` (проксирование/обновление `employee_id`).
