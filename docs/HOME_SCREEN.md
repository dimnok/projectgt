# Главный экран: «Календарь смен» (Heatmap)

## Назначение
- Показать распределение выручки по дням текущего месяца в компактном виде (heatmap) на главном экране.
- Быстро выявлять дни с максимальной суммой и дни без смен.
- Быстрый переход к деталям по выбранной дате (оборотная сторона карточки с разбиением по объектам и системам).

## Расположение
- Экран: `features/home/presentation/screens/home_screen.dart`
- Виджеты календаря и flip-анимации: `features/home/presentation/widgets/shifts_calendar_widgets.dart`
- Виджет прогресса по договору: `features/home/presentation/widgets/contract_progress_widget.dart`

## Источник данных
- Данные берутся из провайдера `exportProvider` (`features/export/presentation/providers/export_provider.dart`).
- Загрузка и обновление: в `HomeScreen.didChangeDependencies()` вызывается `loadReportData()` с периодом последних 30 дней.

## Логика агрегации
- Используются отчёты `ExportReport` после группировки на уровне data source (`ExportDataSourceImpl`).
- Для heatmap фильтруются записи текущего месяца, далее:
  - Суммирование по дню: `sumByDate[date] += (report.total ?? 0)`.
  - Подсчитывается `maxValue` по всем датам месяца для цветового акцента.
- Ключевая правка: группировка отчётных строк учитывает дату (по дню), что исключает «слипание» сумм разных дат и гарантирует корректные суммы.

## Отрисовка
- Сетка месяца (Пн..Вс) формируется по текущему месяцу с префиксными пустыми ячейками.
- Цвет ячейки:
  - 0 — мягкий красный (`_softRed`).
  - максимум месяца — зелёный (`_whatsappGreen`).
  - прочие значения — синий (`_telegramBlue`).
- Ячейка — `AnimatedContainer` (~14×14); при наведении показывается `Tooltip`: `DD.MM.YYYY — ₽ сумма`.

## Интерэктивность
- Mobile/Tablet: Тап по дате переворачивает карточку (flip) и показывает оборотную сторону с деталями по выбранной дате.
  - Оборотная сторона: вверху дата (слева) и кнопка возврата в календарь (справа, иконка `swap_horiz`).
  - Контент: список по объектам (название объекта и сумма), под каждым объектом — список его систем в виде строк «• название системы — сумма».
- Desktop (ширина ≥ 1100): календарь отображается без flip, как отдельная карточка слева; справа — карточка прогресса по договору.

## Темизация
- Акцентные цвета:
  - `_softRed = Color(0xFFE57373)`
  - `_whatsappGreen = Color(0xFF25D366)`
  - `_telegramBlue = Color(0xFF229ED9)`
- Прозрачности — через новый метод `withValues(alpha: ...)`.

## Производительность
- Размер ячеек вычисляется через `LayoutBuilder`; используется лёгкая разметка `Row`/`SizedBox`.
- Анимации короткие (≈220–250 мс), чтобы не перегружать UI.

## Прогресс по договору (новое)
- Виджет: `ContractProgressWidget`
- Источники данных: суммарные сметы (`estimates`) и выполненные объёмы (`work_items` с join на `estimates.contract_id`).
- Особенности:
  - По умолчанию отображается договор с максимальным процентом выполнения.
  - Переключение между договорами стрелками (влево/вправо).
  - Индикатор: круговой прогресс с кастомной отрисовкой (сегментами) и градиентом от красного → оранжевого → жёлтого → зелёного, утолщённая дуга, «выпуклый» эффект (тени/подсветка).
  - Внутри — процент; ниже — суммы: `Итого смета / Выполнено`.

## Различия по платформам
- Desktop (≥1100px): календарь и прогресс по договору — в отдельных карточках, расположены рядом; сетка карточек адаптивна (до 4 в ряд).
- Mobile/Tablet: календарь и прогресс по договору объединены в один контейнер со свайпом (`PageView`).

## Связанные файлы
- `features/export/data/datasources/export_data_source_impl.dart` — группировка по дню
- `features/export/domain/entities/export_report.dart` — сущность отчёта
- `features/home/presentation/screens/home_screen.dart` — точка интеграции
- `features/home/presentation/widgets/shifts_calendar_widgets.dart` — календарь и flip
- `features/home/presentation/widgets/contract_progress_widget.dart` — прогресс договора

## Связанные файлы
- `features/export/data/datasources/export_data_source_impl.dart` — группировка по дню
- `features/export/domain/entities/export_report.dart` — сущность отчёта
- `features/home/presentation/screens/home_screen.dart` — реализация heatmap
