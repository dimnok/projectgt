# Исправление ошибки с profileProvider
**Дата:** 10 октября 2025 года

---

## Проблема

**Ошибка:** Когда администратор переходил в профиль другого пользователя, приложение считало что текущий пользователь изменился.

**Причина:** Неправильное использование провайдеров:
- `profileProvider` используется для просмотра профилей ЛЮБЫХ пользователей (включая чужие)
- `currentUserProfileProvider` используется для профиля ТЕКУЩЕГО авторизованного пользователя

В модуле Works везде использовался `profileProvider` для проверки прав владения и авторизации, что приводило к:
- Потере профиля текущего пользователя при просмотре чужих профилей
- Неправильной проверке прав (isOwner проверялся для неправильного пользователя)
- Невозможности модифицировать смены после просмотра профилей

---

## Исправление

### Обновлённые файлы (7 файлов):

1. **works_master_detail_screen.dart**
   - Строка 125: `profileProvider` → `currentUserProfileProvider`
   - Использование: проверка hasOpenByUser (только одна открытая смена)

2. **work_data_tab.dart** (2 места)
   - Строка 51: `profileProvider` → `currentUserProfileProvider`
   - Строка 706: `profileProvider` → `currentUserProfileProvider`
   - Использование: проверка isOwner для canModify, права на добавление вечернего фото

3. **work_hours_tab.dart**
   - Строка 128: `profileProvider` → `currentUserProfileProvider`
   - Использование: проверка isOwner для canModify (редактирование часов)

4. **work_details_panel.dart**
   - Строка 603: `profileProvider` → `currentUserProfileProvider`
   - Использование: проверка isOwner для canModify (редактирование работ)

5. **work_photo_view.dart**
   - Строка 412: `profileProvider` → `currentUserProfileProvider`
   - Использование: проверка _canModify для добавления/замены фото

6. **work_form_screen.dart** (3 места)
   - Строка 72: `profileProvider` → `currentUserProfileProvider`
   - Строка 352: `profileProvider` → `currentUserProfileProvider`
   - Строка 457: `profileProvider` → `currentUserProfileProvider`
   - Использование: получение objectIds текущего пользователя, openedBy при создании смены

7. **work_details_screen.dart**
   - Строка 31: `profileProvider` → `currentUserProfileProvider`
   - Использование: проверка isOwner для отображения кнопок управления

---

## Правило использования провайдеров

### `currentUserProfileProvider` — ВСЕГДА для:
- ✅ Проверки прав (isOwner, canModify)
- ✅ Получения ID текущего пользователя (openedBy, createdBy)
- ✅ Получения objectIds текущего пользователя
- ✅ Любых операций, связанных с авторизацией и правами

### `profileProvider` — ТОЛЬКО для:
- ✅ Просмотра профилей других пользователей
- ✅ Отображения информации о чужих пользователях
- ❌ НЕ использовать для проверки прав текущего пользователя!

### `userProfileProvider(userId)` — для:
- ✅ Отображения имени пользователя по ID (с кэшированием)
- ✅ Загрузки профиля любого пользователя (кэш автоматический)

---

## Результат

- ✅ Профиль текущего пользователя не меняется при просмотре чужих профилей
- ✅ Проверка прав (isOwner) работает корректно для текущего пользователя
- ✅ Администратор может просматривать профили без потери своих прав
- ✅ Все операции редактирования смен работают корректно
- ✅ Нет ошибок линтера во всех обновлённых файлах

---

## Тестирование

### Сценарий 1: Администратор просматривает чужой профиль
1. Войти как admin
2. Открыть список смен → проверить что FAB доступен
3. Перейти в профиль другого пользователя
4. Вернуться в список смен
5. ✅ FAB всё ещё доступен, права admin сохранились

### Сценарий 2: Пользователь проверяет права владения
1. Войти как обычный пользователь
2. Открыть свою смену → проверить canModify = true
3. Перейти в профиль → вернуться
4. ✅ canModify всё ещё true, права сохранились

### Сценарий 3: Создание смены после просмотра профилей
1. Войти как пользователь
2. Просмотреть несколько чужих профилей
3. Открыть форму создания смены
4. ✅ openedBy = ID текущего пользователя (не последнего просмотренного)

---

**Статус:** ✅ Исправлено и протестировано

