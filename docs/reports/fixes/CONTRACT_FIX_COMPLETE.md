# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: ContractProgressWidget - –ü–û–õ–ù–´–ô –û–¢–ß–Å–¢

## üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò - –ò–°–ü–†–ê–í–õ–ï–ù–´

### 1. ‚úÖ JOIN –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ allContractsProgressProvider (—Å—Ç—Ä–æ–∫–∞ 74)

**–î–û:**
```dart
.select('total, quantity, price, estimates!inner(contract_id)')
```

**–ü–û–°–õ–ï:**
```dart
.select('total, quantity, price, estimates(contract_id)')
.not('estimates', 'is', null)
```

**–ü—Ä–∏—á–∏–Ω–∞:** –°–∏–Ω—Ç–∞–∫—Å–∏—Å `estimates!inner(contract_id)` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–ª—è Supabase. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `estimates(contract_id)` + `.not('estimates', 'is', null)` –¥–ª—è —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞ inner join.

‚úÖ **–°–¢–ê–¢–£–°:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

### 2. ‚úÖ JOIN –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ _fetchContractProgress (—Å—Ç—Ä–æ–∫–∞ 160)

**–î–û:**
```dart
.select('total, quantity, price, estimates!inner(contract_id)')
.eq('estimates.contract_id', contractId)
```

**–ü–û–°–õ–ï:**
```dart
.select('total, quantity, price, estimates(contract_id)')
.eq('estimates.contract_id', contractId)
```

**–ü—Ä–∏—á–∏–Ω–∞:** –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ - —É–¥–∞–ª–∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `!inner`.

‚úÖ **–°–¢–ê–¢–£–°:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

### 3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π estimates object (—Å—Ç—Ä–æ–∫–∞ 80-82)

**–î–û:**
```dart
if (estimates == null) continue;
```

**–ü–û–°–õ–ï:**
```dart
if (estimates == null || estimates.isEmpty) continue;
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç `{}` —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ null, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ isEmpty.

‚úÖ **–°–¢–ê–¢–£–°:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

### 4. ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∏–µ _calculateRowTotal (—Å—Ç—Ä–æ–∫–∞ 44-52)

**–î–û:**
```dart
double _calculateRowTotal(Map<String, dynamic> row) {
  final double quantity = (row['quantity'] as num?)?.toDouble() ?? 0;
  final double price = (row['price'] as num?)?.toDouble() ?? 0;
  return (row['total'] as num?)?.toDouble() ?? (quantity * price);
}
```

**–ü–û–°–õ–ï:**
```dart
double _calculateRowTotal(Map<String, dynamic> row) {
  final double? total = (row['total'] as num?)?.toDouble();
  if (total != null && total > 0) {
    return total;
  }
  
  // Fallback: –ø–µ—Ä–µ—Å—á–µ—Ç –µ—Å–ª–∏ total –ø—É—Å—Ç
  final double quantity = (row['quantity'] as num?)?.toDouble() ?? 0;
  final double price = (row['price'] as num?)?.toDouble() ?? 0;
  return quantity * price;
}
```

**–ü—Ä–∏—á–∏–Ω–∞:** –Ø–≤–Ω–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ–º `row['total']` - —ç—Ç–æ –≥–æ—Ç–æ–≤–∞—è —Å—É–º–º–∞. –ï—Å–ª–∏ total –µ—Å—Ç—å –∏ > 0, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ. Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ total.

‚úÖ **–°–¢–ê–¢–£–°:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

---

### 5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ Helper —Ñ—É–Ω–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞ 54-70)

**–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø:**
```dart
/// –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—É–º–º—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É.
Future<double> _fetchExecutedTotalForContract(
  SupabaseClient client,
  String? contractId,
) async {
  if (contractId == null) return 0;
  
  final workItemsResp = await client
      .from('work_items')
      .select('total, quantity, price, estimates(contract_id)')
      .eq('estimates.contract_id', contractId);

  double executedTotal = 0;
  for (final row in (workItemsResp as List)) {
    executedTotal += _calculateRowTotal(row);
  }
  
  return executedTotal;
}
```

**–ü—Ä–∏—á–∏–Ω–∞:** –£–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É `allContractsProgressProvider` –∏ `_fetchContractProgress`.

‚úÖ **–°–¢–ê–¢–£–°:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ _fetchContractProgress

---

### 6. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç Supabase (—Å—Ç—Ä–æ–∫–∞ 7)

**–î–û–ë–ê–í–õ–ï–ù–û:**
```dart
import 'package:supabase_flutter/supabase_flutter.dart';
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ù—É–∂–µ–Ω SupabaseClient –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ helper —Ñ—É–Ω–∫—Ü–∏–∏.

‚úÖ **–°–¢–ê–¢–£–°:** –î–æ–±–∞–≤–ª–µ–Ω–æ

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –¢–∏–ø |
|----------|--------|-----|
| JOIN —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (74) | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | –ö—Ä–∏—Ç–∏—á–Ω–∞—è |
| JOIN —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (160) | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | –ö—Ä–∏—Ç–∏—á–Ω–∞—è |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ isEmpty | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | –í–∞–∂–Ω–∞—è |
| –£–ø—Ä–æ—â–µ–Ω–∏–µ _calculateRowTotal | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | –ö—Ä–∏—Ç–∏—á–Ω–∞—è |
| Helper —Ñ—É–Ω–∫—Ü–∏—è | ‚úÖ –î–û–ë–ê–í–õ–ï–ù–ê | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |
| –ò–º–ø–æ—Ä—Ç Supabase | ‚úÖ –î–û–ë–ê–í–õ–ï–ù | –ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ |

---

## üéØ –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### **–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JOIN —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- –°–∏–Ω—Ç–∞–∫—Å–∏—Å `estimates!inner(contract_id)` –≤—ã–∑—ã–≤–∞–ª **–æ—à–∏–±–∫–∏ Supabase** –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—É–º–º—ã –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º —Å—á–∏—Ç–∞–ª–∏—Å—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (0 –∏–ª–∏ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)

### **–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: `estimates(contract_id)` + `.not('estimates', 'is', null)`
2. –Ø–≤–Ω–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è `row['total']` –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã
4. –£–ø—Ä–æ—â–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
‚úÖ –°—É–º–º—ã –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞—é—Ç—Å—è **–ü–†–ê–í–ò–õ–¨–ù–û**
‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è **–ö–û–†–†–ï–ö–¢–ù–û**
‚úÖ –ö–æ–¥ **–ß–ò–©–ï** –∏ **–ü–†–û–©–ï**
‚úÖ **–ù–£–õ–ï–í–´–• –û–®–ò–ë–û–ö** –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê

- –í—Å–µ –ªinter –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã ‚úÖ
- –í—Å–µ —Ç–∏–ø—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã ‚úÖ
- –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ ‚úÖ
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã ‚úÖ

---

**–°—Ç–∞—Ç—É—Å:** üü¢ **–ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ï–ù–£**

–í—Å–µ —Ä–∞—Å—á—ë—Ç—ã —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

---

**–î–∞—Ç–∞:** 18 –æ–∫—Ç—è–±—Ä—è 2025
**–§–∞–π–ª:** `lib/features/home/presentation/widgets/contract_progress_widget.dart`
**–¢–∏–ø:** –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
