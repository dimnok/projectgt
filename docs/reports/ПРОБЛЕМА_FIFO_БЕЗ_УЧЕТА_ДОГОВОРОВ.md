# ‚úÖ –†–ï–®–ï–ù–û: FIFO —Å–ø–∏—Å—ã–≤–∞–ª –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ –¥—Ä—É–≥–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞

**–î–∞—Ç–∞ –≤—ã—è–≤–ª–µ–Ω–∏—è:** 6 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è:** 6 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–±—ã–ª)  
**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–π –º–æ–¥—É–ª—å:** –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (v_materials_with_usage)

---

## ‚úÖ –°–¢–ê–¢–£–° –†–ï–®–ï–ù–ò–Ø

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ –¥–æ–≥–æ–≤–æ—Ä–∞–º** ‚Äî FIFO —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞.

**–°–º. –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç:** `–û–¢–ß–Å–¢_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_FIFO_–î–û–ì–û–í–û–†–´.md`  
**SQL-–º–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/20251006_fix_materials_fifo_by_contract.sql`

---

## üìã –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (—Ä–µ—à–µ–Ω–∞)

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_materials_with_usage` –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–µ—Ç–æ–¥ FIFO (First In, First Out) –≥–ª–æ–±–∞–ª—å–Ω–æ –ø–æ –≤—Å–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞.**

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**  
–ú–∞—Ç–µ—Ä–∏–∞–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞, –Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å–∫–ª–∞–¥–∞ –∏–∑ –ø–∞—Ä—Ç–∏–∏ **–¥—Ä—É–≥–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞** (–ø–æ –¥–∞—Ç–µ –ø—Ä–∏—Ö–æ–¥–∞, –∞ –Ω–µ –ø–æ –ø—Ä–∏–≤—è–∑–∫–µ –∫ –¥–æ–≥–æ–≤–æ—Ä—É).

---

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª—É—á–∞—è

### –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ú–∞—Ç–µ—Ä–∏–∞–ª:**  
`–ü—Ä–æ—Ñ–∏–ª—å –º–æ–Ω—Ç–∞–∂–Ω—ã–π TSC 41—Ö82Dx2,0-6000 Zn275 (1 —à—Ç/–∫–æ—Ä)`

**–°–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è:**
- ID: `4acd9c76-15a9-4804-b721-d0fd06503385`
- –ù–∞–∑–≤–∞–Ω–∏–µ: `–ü—Ä–æ—Ñ–∏–ª—å –º–æ–Ω—Ç–∞–∂–Ω—ã–π TSC 41—Ö82Dx2,0-6000 Zn275, TERMOCLIP, 9369103`
- **–î–æ–≥–æ–≤–æ—Ä:** `173-—Å—É–±-26` ‚úÖ
- –û–±—ä–µ–∫—Ç: –¶–û–î –î—É–±–Ω–∞

**–ü—Ä–∏–≤—è–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (`material_aliases`):**
- –ê–ª–∏–∞—Å: `–ü—Ä–æ—Ñ–∏–ª—å –º–æ–Ω—Ç–∞–∂–Ω—ã–π TSC 41—Ö82Dx2,0-6000 Zn275 (1 —à—Ç/–∫–æ—Ä)`
- –ü—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-26` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (`work_items`):**
- –î–∞—Ç–∞: 1 –æ–∫—Ç—è–±—Ä—è 2025
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: **30 –º–µ—Ç—Ä–æ–≤**
- –û–±—ä–µ–∫—Ç: –¶–û–î –î—É–±–Ω–∞
- –°–º–µ–Ω–∞: –∑–∞–∫—Ä—ã—Ç–∞
- **–û–∂–∏–¥–∞–Ω–∏–µ:** –º–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–ª–∂–µ–Ω —Å–ø–∏—Å–∞—Ç—å—Å—è –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-26`

---

### –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–∞ —Å–∫–ª–∞–¥–µ (—Ç–∞–±–ª–∏—Ü–∞ `materials`)

#### –î–æ–≥–æ–≤–æ—Ä 173-—Å—É–±-17 (1 –ø–∞—Ä—Ç–∏—è)

| ID | –ù–∞–∫–ª–∞–¥–Ω–∞—è | –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ | –ö–æ–ª-–≤–æ | –î–æ–≥–æ–≤–æ—Ä |
|----|-----------|--------------|--------|---------|
| `7a5d7551-741c-40bc-84f9-6aa93aacee0f` | 2212 | **17.06.2024** ‚≠ê | 60 –º | 173-—Å—É–±-17 |

**–í–∞–∂–Ω–æ:** –≠—Ç–æ **–°–ê–ú–ê–Ø –†–ê–ù–ù–Ø–Ø** –ø–∞—Ä—Ç–∏—è!

---

#### –î–æ–≥–æ–≤–æ—Ä 173-—Å—É–±-26 (9 –ø–∞—Ä—Ç–∏–π)

| ID | –ù–∞–∫–ª–∞–¥–Ω–∞—è | –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ | –ö–æ–ª-–≤–æ | –î–æ–≥–æ–≤–æ—Ä |
|----|-----------|--------------|--------|---------|
| `490269d2-ccc0-4e2a-81f2-85891cf81b0c` | 2240 | 21.06.2024 | 492 –º | 173-—Å—É–±-26 |
| `3a1fb522-353e-49f6-bd82-fd6132e986d7` | 2344 | 28.06.2024 | 516 –º | 173-—Å—É–±-26 |
| `630d3496-7bc2-4551-a208-cde5994c3b99` | 2559 | 22.07.2024 | 504 –º | 173-—Å—É–±-26 |
| `7882b54d-f932-4c80-b097-d60991cb58e7` | 2653 | 01.08.2024 | 420 –º | 173-—Å—É–±-26 |
| `e3eb73e9-c74c-4c9e-8d52-c3fe79c43fd2` | 2805 | 22.08.2024 | 180 –º | 173-—Å—É–±-26 |
| `121a5bd2-0328-431f-a7ea-f7583543c358` | 3110 | 16.09.2024 | 504 –º | 173-—Å—É–±-26 |
| `0adbf4ae-c2e1-4fec-a7b4-c557cfc27bbd` | 3696 | 03.12.2024 | 528 –º | 173-—Å—É–±-26 |
| `5e09d8f3-ab7f-4c08-9c21-c566fc203ce8` | 455 | 28.02.2025 | 246 –º | 173-—Å—É–±-26 |
| `3bd2a6b7-dd9c-4f3e-a403-e5f67d4700bd` | 1637 | 14.07.2025 | 600 –º | 173-—Å—É–±-26 |

**–ò—Ç–æ–≥–æ:** 3990 –º–µ—Ç—Ä–æ–≤ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ 173-—Å—É–±-26

---

### –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –≤ `v_materials_with_usage`

| –î–æ–≥–æ–≤–æ—Ä | –ü–∞—Ä—Ç–∏–π | –í—Å–µ–≥–æ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ | –û—Å—Ç–∞—Ç–æ–∫ |
|---------|--------|-------|--------------|---------|
| **173-—Å—É–±-17** | 1 | 60 –º | **30 –º** ‚ùå | 30 –º |
| **173-—Å—É–±-26** | 9 | 3990 –º | **0 –º** ‚ùå | 3990 –º |

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

### –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

1. ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω** –≤ —Å–º–µ–Ω–µ –ø–æ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-26`
2. ‚ùå –ú–∞—Ç–µ—Ä–∏–∞–ª **—Å–ø–∏—Å–∞–ª—Å—è** –∏–∑ –ø–∞—Ä—Ç–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-17` (–ø–æ FIFO ‚Äî —Å–∞–º–∞—è —Ä–∞–Ω–Ω—è—è –¥–∞—Ç–∞)
3. ‚ùå –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-26` –æ—Å—Ç–∞–ª–∏—Å—å **–Ω–µ —Ç—Ä–æ–Ω—É—Ç—ã–º–∏** (0 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)

### –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –±—ã—Ç—å (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

1. ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω** –≤ —Å–º–µ–Ω–µ –ø–æ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-26`
2. ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª **–¥–æ–ª–∂–µ–Ω —Å–ø–∏—Å–∞—Ç—å—Å—è** –∏–∑ –ø–∞—Ä—Ç–∏–π –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-26` (–ø–æ FIFO –≤–Ω—É—Ç—Ä–∏ –¥–æ–≥–æ–≤–æ—Ä–∞)
3. ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞ `173-—Å—É–±-17` –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è **–Ω–µ —Ç—Ä–æ–Ω—É—Ç—ã–º–∏**

---

## ‚öôÔ∏è –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã: –ª–æ–≥–∏–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è `v_materials_with_usage`

### –¢–µ–∫—É—â–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º FIFO (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)

```sql
-- –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è v_materials_with_usage

-- –®–∞–≥ 1: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
norm_materials AS (
  SELECT m.*, lower(regexp_replace(...)) AS normalized_name
  FROM materials m
)

-- –®–∞–≥ 2: –ü—Ä–∏–≤—è–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ —Å–º–µ—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º –ü–û –ù–ê–ó–í–ê–ù–ò–Æ
material_estimate AS (
  SELECT nm.*, (
    SELECT na.estimate_id 
    FROM norm_aliases na 
    WHERE na.normalized_name = nm.normalized_name 
    LIMIT 1
  ) AS estimate_id
  FROM norm_materials nm
)

-- –®–∞–≥ 3: FIFO –ø–æ –í–°–ï–ú –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º estimate_id
me_fifo AS (
  SELECT 
    me.*,
    sum(quantity) OVER (
      PARTITION BY me.estimate_id  -- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¢–û–õ–¨–ö–û –ø–æ —Å–º–µ—Ç–µ!
      ORDER BY me.receipt_date, me.id  -- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –ø—Ä–∏—Ö–æ–¥–∞
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS prev_cum_qty
  FROM material_estimate me
)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–û–∫–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `PARTITION BY me.estimate_id` –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã **—Ç–æ–ª—å–∫–æ –ø–æ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏**, –∏–≥–Ω–æ—Ä–∏—Ä—É—è `contract_number`!

---

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã

#### –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```
–°–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è: "–ü—Ä–æ—Ñ–∏–ª—å TSC 41—Ö82"
‚îú‚îÄ –î–æ–≥–æ–≤–æ—Ä: 173-—Å—É–±-26
‚îî‚îÄ estimate_id: 4acd9c76...

    ‚Üì –ü—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ material_aliases (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)

–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–∞ —Å–∫–ª–∞–¥–µ (FIFO –≥–ª–æ–±–∞–ª—å–Ω–æ):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. 173-—Å—É–±-17, 60 –º, 17.06.2024  ‚Üê –°–ü–ò–°–ê–õ–û–°–¨ 30 –º ‚ùå
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. 173-—Å—É–±-26, 492 –º, 21.06.2024      ‚îÇ
‚îÇ 3. 173-—Å—É–±-26, 516 –º, 28.06.2024      ‚îÇ
‚îÇ 4. 173-—Å—É–±-26, 504 –º, 22.07.2024      ‚îÇ
‚îÇ ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ 6 –ø–∞—Ä—Ç–∏–π 173-—Å—É–±-26)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
FIFO –≤—ã–±–∏—Ä–∞–µ—Ç **—Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –ø–∞—Ä—Ç–∏—é** –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∏–∑ 173-—Å—É–±-17.

---

#### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å):

```
–°–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è: "–ü—Ä–æ—Ñ–∏–ª—å TSC 41—Ö82"
‚îú‚îÄ –î–æ–≥–æ–≤–æ—Ä: 173-—Å—É–±-26 ‚úÖ
‚îî‚îÄ estimate_id: 4acd9c76...

    ‚Üì –ü—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ material_aliases + –§–ò–õ–¨–¢–† –ø–æ contract_number

–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–∞ —Å–∫–ª–∞–¥–µ (FIFO –≤–Ω—É—Ç—Ä–∏ –¥–æ–≥–æ–≤–æ—Ä–∞):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –î–æ–≥–æ–≤–æ—Ä 173-—Å—É–±-26 (–¢–û–õ–¨–ö–û —ç—Ç–∏ –ø–∞—Ä—Ç–∏–∏) ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. 492 –º, 21.06.2024  ‚Üê –°–ü–ò–°–ê–¢–¨ 30 –º ‚úÖ‚îÇ
‚îÇ 2. 516 –º, 28.06.2024                   ‚îÇ
‚îÇ 3. 504 –º, 22.07.2024                   ‚îÇ
‚îÇ ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ 6 –ø–∞—Ä—Ç–∏–π)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –î–æ–≥–æ–≤–æ—Ä 173-—Å—É–±-17 (–ù–ï –¢–†–û–ì–ê–ï–ú)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. 60 –º, 17.06.2024  ‚Üê –ù–ï –°–ü–ò–°–´–í–ê–¢–¨ ‚úÖ ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
FIFO —Ä–∞–±–æ—Ç–∞–µ—Ç **–≤ —Ä–∞–º–∫–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞** ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∏–∑ 173-—Å—É–±-26.

---

## üîó –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

### –û–±—ä–µ–∫—Ç "–¶–û–î –î—É–±–Ω–∞" –∏ –¥–æ–≥–æ–≤–æ—Ä—ã

–û–±—ä–µ–∫—Ç **–¶–û–î –î—É–±–Ω–∞** —Å–≤—è–∑–∞–Ω —Å **—Ç—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏**:

| –î–æ–≥–æ–≤–æ—Ä | –î–∞—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|---------|------|--------|
| 173-—Å—É–±-17 | 01.09.2025 | active |
| 173-—Å—É–±-25 | 01.08.2025 | active |
| 173-—Å—É–±-26 | 01.08.2025 | active |

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ù–∞ –æ–¥–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ ‚Üí –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–æ–≥—É—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö.

---

### –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≤—è–∑–∫–∏ `material_aliases`

**–¶–µ–ª—å:**  
–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã) —Å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–∑ —Å–º–µ—Ç—ã.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
material_aliases:
  - estimate_id: FK to estimates (—Å–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è)
  - alias_raw: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω–æ–π
  - supplier_id: –ø–æ—Å—Ç–∞–≤—â–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - multiplier_to_estimate: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—á—ë—Ç–∞
```

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
- –ü—Ä–∏–≤—è–∑–∫–∞ –∏–¥—ë—Ç **–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é** (alias_raw ‚Üí estimate)
- –î–æ–≥–æ–≤–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞ **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è**
- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è **–ø–µ—Ä–≤–∞—è** –Ω–∞–π–¥–µ–Ω–Ω–∞—è —Å–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –µ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö, `material_aliases` –Ω–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –∏—Ö!

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö
SELECT 
  name,
  COUNT(DISTINCT contract_number) as contracts_count,
  STRING_AGG(DISTINCT contract_number, ', ') as contracts
FROM materials
GROUP BY name
HAVING COUNT(DISTINCT contract_number) > 1;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**  
–î–µ—Å—è—Ç–∫–∏/—Å–æ—Ç–Ω–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö ‚Üí **–ø—Ä–æ–±–ª–µ–º–∞ –º–∞—Å—Å–æ–≤–∞—è**!

---

## üéØ –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º üî¥

- –û—Å—Ç–∞—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ **–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç** —Ä–µ–∞–ª—å–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É
- –î–æ–≥–æ–≤–æ—Ä 173-—Å—É–±-17 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥, —Ö–æ—Ç—è –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è
- –î–æ–≥–æ–≤–æ—Ä 173-—Å—É–±-26 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏, —Ö–æ—Ç—è –º–∞—Ç–µ—Ä–∏–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è

### 2. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ üî¥

- –û—Ç—á—ë—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º **–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã**
- –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
- –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —É—á—ë—Ç–∞

### 3. –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ ‚ö†Ô∏è

- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ 173-—Å—É–±-26 –æ—Å—Ç–∞—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±—É–¥—É—Ç **–∑–∞–≤—ã—à–µ–Ω—ã**
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ 173-—Å—É–±-17 –æ—Å—Ç–∞—Ç–∫–∏ –±—É–¥—É—Ç **–∑–∞–Ω–∏–∂–µ–Ω—ã**

### 4. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏ üî¥

- –ù–∞ –æ–¥–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –º–æ–≥—É—Ç –∑–∞–∫—É–ø–∞—Ç—å—Å—è –ø–æ —Ä–∞–∑–Ω—ã–º –¥–æ–≥–æ–≤–æ—Ä–∞–º
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –∏–∑ –∫–∞–∫–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ —Ä–µ–∞–ª—å–Ω–æ —Å–ø–∏—Å–∞–Ω –º–∞—Ç–µ—Ä–∏–∞–ª

---

## üí° –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ contract_number –≤ FIFO (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ò–¥–µ—è:**  
–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è `v_materials_with_usage`, —á—Ç–æ–±—ã FIFO —Ä–∞–±–æ—Ç–∞–ª **–≤ —Ä–∞–º–∫–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞**.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞—Ç—å `contract_number`
2. –í –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ FIFO –¥–æ–±–∞–≤–∏—Ç—å `PARTITION BY estimate_id, contract_number`
3. –°–ø–∏—Å—ã–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ç–æ–ª—å–∫–æ –∏–∑ —Ç–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Å–º–µ—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è

**SQL (–∫–æ–Ω—Ü–µ–ø—Ç):**
```sql
me_fifo AS (
  SELECT 
    me.*,
    sum(quantity) OVER (
      PARTITION BY me.estimate_id, me.contract_number  -- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å contract_number
      ORDER BY me.receipt_date, me.id
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS prev_cum_qty
  FROM material_estimate me
  -- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ —Ç–æ–≥–æ –∂–µ –¥–æ–≥–æ–≤–æ—Ä–∞, —á—Ç–æ –∏ estimate
  WHERE me.contract_number = (
    SELECT c.number 
    FROM estimates e 
    JOIN contracts c ON c.id = e.contract_id 
    WHERE e.id = me.estimate_id
  )
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `v_materials_with_usage`
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `v_materials_usage_period`

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ contract_number –≤ material_aliases

**–ò–¥–µ—è:**  
–•—Ä–∞–Ω–∏—Ç—å –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ `material_aliases` –¥–ª—è —è–≤–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∫ –¥–æ–≥–æ–≤–æ—Ä—É.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `contract_number` –≤ —Ç–∞–±–ª–∏—Ü—É `material_aliases`
2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–ª–∏–∞—Å–∞ —É–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä
3. –ü—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —É—á–∏—Ç—ã–≤–∞—Ç—å –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏ –¥–æ–≥–æ–≤–æ—Ä

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –Ø–≤–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∫ –¥–æ–≥–æ–≤–æ—Ä—É
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å (–æ–¥–∏–Ω –º–∞—Ç–µ—Ä–∏–∞–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö —Å —Ä–∞–∑–Ω—ã–º–∏ –∞–ª–∏–∞—Å–∞–º–∏)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è)
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è UI (–≤—ã–±–æ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ)
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞: –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞

**–ò–¥–µ—è:**  
–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–æ–π —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É
2. –í UI –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å–º–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å constraint –≤ –ë–î –Ω–∞ —É—Ä–æ–≤–Ω–µ `material_aliases`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ FIFO

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –ù–µ–≥–∏–±–∫–æ—Å—Ç—å (–Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ –¥—Ä—É–≥–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1 —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏

**–≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ –º–∞—Å—à—Ç–∞–±–∞ –ø—Ä–æ–±–ª–µ–º—ã (1 –¥–µ–Ω—å)**
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ —Å–º–µ—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ
3. –û—Ü–µ–Ω–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ç—á—ë—Ç—ã

**–≠—Ç–∞–ø 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è `v_materials_with_usage` (1-2 –¥–Ω—è)**
1. –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ contract_number –≤ FIFO
2. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–∏–≤—è–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ —Å–º–µ—Ç–∞–º
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–≠—Ç–∞–ø 3: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `v_materials_usage_period` (1 –¥–µ–Ω—å)**
1. –î–æ–±–∞–≤–∏—Ç—å —É—á—ë—Ç contract_number –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥

**–≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (1-2 –¥–Ω—è)**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º –≤ UI
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤

**–≠—Ç–∞–ø 5: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
1. –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
2. –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ `used` –≤ —Ç–∞–±–ª–∏—Ü–µ `materials` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

---

## üìù SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

```sql
-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ v_materials_with_usage
CREATE OR REPLACE VIEW public.v_materials_with_usage AS
WITH norm_aliases AS (
  SELECT 
    lower(regexp_replace(translate(ma.alias_raw, '–ú–º', 'mm'), '\s+', ' ', 'g')) AS normalized_name,
    ma.estimate_id
  FROM material_aliases ma
),
used_by_estimate AS (
  SELECT 
    wi.estimate_id,
    COALESCE(sum(wi.quantity), 0::numeric) AS used_qty
  FROM work_items wi
  WHERE wi.estimate_id IS NOT NULL
  GROUP BY wi.estimate_id
),
norm_materials AS (
  SELECT 
    m.id,
    m.name,
    m.unit,
    m.quantity,
    m.price,
    m.total,
    m.receipt_number,
    m.receipt_date,
    m.file_url,
    m.contract_number,
    lower(regexp_replace(translate(m.name, '–ú–º', 'mm'), '\s+', ' ', 'g')) AS normalized_name
  FROM materials m
),
material_estimate AS (
  SELECT 
    nm.id,
    nm.name,
    nm.unit,
    nm.quantity,
    nm.price,
    nm.total,
    nm.receipt_number,
    nm.receipt_date,
    nm.file_url,
    nm.contract_number,
    nm.normalized_name,
    (
      SELECT na.estimate_id
      FROM norm_aliases na
      WHERE na.normalized_name = nm.normalized_name
      LIMIT 1
    ) AS estimate_id
  FROM norm_materials nm
),
-- ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –§–ò–õ–¨–¢–† –ü–û –î–û–ì–û–í–û–†–£
material_estimate_filtered AS (
  SELECT 
    me.*,
    (SELECT c.number FROM estimates e JOIN contracts c ON c.id = e.contract_id WHERE e.id = me.estimate_id) AS estimate_contract
  FROM material_estimate me
  -- ‚úÖ –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ —Ç–æ–≥–æ –∂–µ –¥–æ–≥–æ–≤–æ—Ä–∞, —á—Ç–æ –∏ —Å–º–µ—Ç–∞
  WHERE me.estimate_id IS NULL 
    OR me.contract_number = (
      SELECT c.number 
      FROM estimates e 
      JOIN contracts c ON c.id = e.contract_id 
      WHERE e.id = me.estimate_id
    )
),
me_fifo AS (
  SELECT 
    mef.id,
    mef.name,
    mef.unit,
    mef.quantity,
    mef.price,
    mef.total,
    mef.receipt_number,
    mef.receipt_date,
    mef.file_url,
    mef.contract_number,
    mef.normalized_name,
    mef.estimate_id,
    COALESCE(mef.quantity, 0) AS qty,
    -- ‚úÖ PARTITION —Ç–µ–ø–µ—Ä—å –ø–æ estimate_id –ò contract_number
    sum(COALESCE(mef.quantity, 0)) OVER (
      PARTITION BY mef.estimate_id, mef.contract_number
      ORDER BY mef.receipt_date, mef.id
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS prev_cum_qty,
    row_number() OVER (
      PARTITION BY mef.estimate_id, mef.contract_number
      ORDER BY mef.receipt_date, mef.id
    ) AS rn,
    count(*) OVER (
      PARTITION BY mef.estimate_id, mef.contract_number
    ) AS cnt
  FROM material_estimate_filtered mef
)
SELECT 
  mef.id,
  mef.name,
  mef.unit,
  mef.quantity,
  mef.price,
  mef.total,
  mef.receipt_number,
  mef.receipt_date,
  mef.file_url,
  mef.contract_number,
  GREATEST(0, LEAST(
    COALESCE(mef.qty, 0),
    COALESCE(ube.used_qty, 0) - COALESCE(mef.prev_cum_qty, 0)
  )) AS used,
  CASE
    WHEN mef.quantity IS NULL THEN NULL
    WHEN mef.estimate_id IS NOT NULL AND mef.rn = mef.cnt THEN
      COALESCE(mef.quantity, 0) - GREATEST(0,
        COALESCE(ube.used_qty, 0) - COALESCE(mef.prev_cum_qty, 0)
      )
    ELSE
      COALESCE(mef.quantity, 0) - GREATEST(0, LEAST(
        COALESCE(mef.qty, 0),
        COALESCE(ube.used_qty, 0) - COALESCE(mef.prev_cum_qty, 0)
      ))
  END AS remaining,
  mef.estimate_id
FROM me_fifo mef
LEFT JOIN used_by_estimate ube ON ube.estimate_id = mef.estimate_id;
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:

| –î–æ–≥–æ–≤–æ—Ä | –ü–∞—Ä—Ç–∏–π | –í—Å–µ–≥–æ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ | –û—Å—Ç–∞—Ç–æ–∫ |
|---------|--------|-------|--------------|---------|
| **173-—Å—É–±-17** | 1 | 60 –º | **0 –º** ‚úÖ | 60 –º |
| **173-—Å—É–±-26** | 9 | 3990 –º | **30 –º** ‚úÖ | 3960 –º |

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≤–æ–ø—Ä–æ—Å—ã

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:** –ü—Ä–æ–µ–∫—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞  
**–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞:** 6 –æ–∫—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞  
**–í–µ—Ä—Å–∏—è:** 1.0

---

**–í–ê–ñ–ù–û:**  
–ü—Ä–æ–±–ª–µ–º–∞ –∏–º–µ–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** üî¥ –∏ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—à–µ–Ω–∏—è –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–Ω. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—á—ë—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º –≤–µ–¥—ë—Ç –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –æ—à–∏–±–∫–∞–º –∏ –ø—Ä–æ–±–ª–µ–º–∞–º —Å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–µ–π.

