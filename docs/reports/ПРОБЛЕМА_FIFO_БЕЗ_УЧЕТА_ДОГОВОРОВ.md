# ✅ РЕШЕНО: FIFO списывал материалы из другого договора

**Дата выявления:** 6 октября 2025 года  
**Дата решения:** 6 октября 2025 года  
**Статус:** ✅ РЕШЕНО  
**Приоритет:** Критический (был)  
**Затронутый модуль:** Материалы (v_materials_with_usage)

---

## ✅ СТАТУС РЕШЕНИЯ

**Проблема полностью решена!**

Реализована **строгая привязка материалов к договорам** — FIFO теперь работает только в рамках одного договора.

**См. итоговый отчёт:** `ОТЧЁТ_ИСПРАВЛЕНИЕ_FIFO_ДОГОВОРЫ.md`  
**SQL-миграция:** `supabase/migrations/20251006_fix_materials_fifo_by_contract.sql`

---

## 📋 Исходная проблема (решена)

---

## 📋 Краткое описание проблемы

**Представление `v_materials_with_usage` применяет метод FIFO (First In, First Out) глобально по всем материалам с одинаковым названием, игнорируя номер договора.**

**Последствие:**  
Материал используется в рамках одного договора, но списывается со склада из партии **другого договора** (по дате прихода, а не по привязке к договору).

---

## 🔍 Детальный анализ конкретного случая

### Исходные данные

**Материал:**  
`Профиль монтажный TSC 41х82Dx2,0-6000 Zn275 (1 шт/кор)`

**Сметная позиция:**
- ID: `4acd9c76-15a9-4804-b721-d0fd06503385`
- Название: `Профиль монтажный TSC 41х82Dx2,0-6000 Zn275, TERMOCLIP, 9369103`
- **Договор:** `173-суб-26` ✅
- Объект: ЦОД Дубна

**Привязка материала (`material_aliases`):**
- Алиас: `Профиль монтажный TSC 41х82Dx2,0-6000 Zn275 (1 шт/кор)`
- Привязан к сметной позиции из договора `173-суб-26` ✅

**Использование (`work_items`):**
- Дата: 1 октября 2025
- Количество: **30 метров**
- Объект: ЦОД Дубна
- Смена: закрыта
- **Ожидание:** материал должен списаться из договора `173-суб-26`

---

### Материалы на складе (таблица `materials`)

#### Договор 173-суб-17 (1 партия)

| ID | Накладная | Дата прихода | Кол-во | Договор |
|----|-----------|--------------|--------|---------|
| `7a5d7551-741c-40bc-84f9-6aa93aacee0f` | 2212 | **17.06.2024** ⭐ | 60 м | 173-суб-17 |

**Важно:** Это **САМАЯ РАННЯЯ** партия!

---

#### Договор 173-суб-26 (9 партий)

| ID | Накладная | Дата прихода | Кол-во | Договор |
|----|-----------|--------------|--------|---------|
| `490269d2-ccc0-4e2a-81f2-85891cf81b0c` | 2240 | 21.06.2024 | 492 м | 173-суб-26 |
| `3a1fb522-353e-49f6-bd82-fd6132e986d7` | 2344 | 28.06.2024 | 516 м | 173-суб-26 |
| `630d3496-7bc2-4551-a208-cde5994c3b99` | 2559 | 22.07.2024 | 504 м | 173-суб-26 |
| `7882b54d-f932-4c80-b097-d60991cb58e7` | 2653 | 01.08.2024 | 420 м | 173-суб-26 |
| `e3eb73e9-c74c-4c9e-8d52-c3fe79c43fd2` | 2805 | 22.08.2024 | 180 м | 173-суб-26 |
| `121a5bd2-0328-431f-a7ea-f7583543c358` | 3110 | 16.09.2024 | 504 м | 173-суб-26 |
| `0adbf4ae-c2e1-4fec-a7b4-c557cfc27bbd` | 3696 | 03.12.2024 | 528 м | 173-суб-26 |
| `5e09d8f3-ab7f-4c08-9c21-c566fc203ce8` | 455 | 28.02.2025 | 246 м | 173-суб-26 |
| `3bd2a6b7-dd9c-4f3e-a403-e5f67d4700bd` | 1637 | 14.07.2025 | 600 м | 173-суб-26 |

**Итого:** 3990 метров в договоре 173-суб-26

---

### Результат расчёта в `v_materials_with_usage`

| Договор | Партий | Всего | Использовано | Остаток |
|---------|--------|-------|--------------|---------|
| **173-суб-17** | 1 | 60 м | **30 м** ❌ | 30 м |
| **173-суб-26** | 9 | 3990 м | **0 м** ❌ | 3990 м |

---

## 🔴 Проблема

### Что произошло (неправильно):

1. ✅ Материал **использован** в смене по сметной позиции договора `173-суб-26`
2. ❌ Материал **списался** из партии договора `173-суб-17` (по FIFO — самая ранняя дата)
3. ❌ Материалы договора `173-суб-26` остались **не тронутыми** (0 использовано)

### Что должно было быть (правильно):

1. ✅ Материал **использован** в смене по сметной позиции договора `173-суб-26`
2. ✅ Материал **должен списаться** из партий договора `173-суб-26` (по FIFO внутри договора)
3. ✅ Материалы договора `173-суб-17` должны остаться **не тронутыми**

---

## ⚙️ Анализ причины: логика представления `v_materials_with_usage`

### Текущий алгоритм FIFO (неправильный)

```sql
-- Упрощённая логика из представления v_materials_with_usage

-- Шаг 1: Нормализация названий материалов
norm_materials AS (
  SELECT m.*, lower(regexp_replace(...)) AS normalized_name
  FROM materials m
)

-- Шаг 2: Привязка материалов к сметным позициям ПО НАЗВАНИЮ
material_estimate AS (
  SELECT nm.*, (
    SELECT na.estimate_id 
    FROM norm_aliases na 
    WHERE na.normalized_name = nm.normalized_name 
    LIMIT 1
  ) AS estimate_id
  FROM norm_materials nm
)

-- Шаг 3: FIFO по ВСЕМ материалам с одинаковым estimate_id
me_fifo AS (
  SELECT 
    me.*,
    sum(quantity) OVER (
      PARTITION BY me.estimate_id  -- Группировка ТОЛЬКО по смете!
      ORDER BY me.receipt_date, me.id  -- Сортировка по дате прихода
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS prev_cum_qty
  FROM material_estimate me
)
```

**Проблема:**  
Оконная функция `PARTITION BY me.estimate_id` группирует материалы **только по сметной позиции**, игнорируя `contract_number`!

---

### Визуализация проблемы

#### Текущая логика (неправильно):

```
Сметная позиция: "Профиль TSC 41х82"
├─ Договор: 173-суб-26
└─ estimate_id: 4acd9c76...

    ↓ Привязка через material_aliases (по названию)

Материалы на складе (FIFO глобально):
┌────────────────────────────────────────┐
│ 1. 173-суб-17, 60 м, 17.06.2024  ← СПИСАЛОСЬ 30 м ❌
├────────────────────────────────────────┤
│ 2. 173-суб-26, 492 м, 21.06.2024      │
│ 3. 173-суб-26, 516 м, 28.06.2024      │
│ 4. 173-суб-26, 504 м, 22.07.2024      │
│ ... (остальные 6 партий 173-суб-26)   │
└────────────────────────────────────────┘
```

**Результат:**  
FIFO выбирает **самую раннюю партию** независимо от договора → списывается из 173-суб-17.

---

#### Правильная логика (как должно быть):

```
Сметная позиция: "Профиль TSC 41х82"
├─ Договор: 173-суб-26 ✅
└─ estimate_id: 4acd9c76...

    ↓ Привязка через material_aliases + ФИЛЬТР по contract_number

Материалы на складе (FIFO внутри договора):
┌────────────────────────────────────────┐
│ Договор 173-суб-26 (ТОЛЬКО эти партии) │
├────────────────────────────────────────┤
│ 1. 492 м, 21.06.2024  ← СПИСАТЬ 30 м ✅│
│ 2. 516 м, 28.06.2024                   │
│ 3. 504 м, 22.07.2024                   │
│ ... (остальные 6 партий)               │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ Договор 173-суб-17 (НЕ ТРОГАЕМ)        │
├────────────────────────────────────────┤
│ 1. 60 м, 17.06.2024  ← НЕ СПИСЫВАТЬ ✅ │
└────────────────────────────────────────┘
```

**Результат:**  
FIFO работает **в рамках договора** → списывается из 173-суб-26.

---

## 🔗 Связь с другими модулями

### Объект "ЦОД Дубна" и договоры

Объект **ЦОД Дубна** связан с **тремя активными договорами**:

| Договор | Дата | Статус |
|---------|------|--------|
| 173-суб-17 | 01.09.2025 | active |
| 173-суб-25 | 01.08.2025 | active |
| 173-суб-26 | 01.08.2025 | active |

**Проблема:**  
На одном объекте может быть несколько договоров → материалы с одинаковым названием могут быть в разных договорах.

---

### Система привязки `material_aliases`

**Цель:**  
Сопоставить названия материалов из накладных (разные форматы) с каноническими названиями из сметы.

**Структура:**
```sql
material_aliases:
  - estimate_id: FK to estimates (сметная позиция)
  - alias_raw: название из накладной
  - supplier_id: поставщик (опционально)
  - multiplier_to_estimate: коэффициент пересчёта
```

**Текущая логика:**
- Привязка идёт **по названию** (alias_raw → estimate)
- Договор материала **НЕ проверяется**
- Привязывается **первая** найденная сметная позиция

**Проблема:**  
Если материал с одинаковым названием есть в нескольких договорах, `material_aliases` не различает их!

---

## 📊 Статистика проблемы

### Глобальная оценка

```sql
-- Количество материалов, которые есть в нескольких договорах
SELECT 
  name,
  COUNT(DISTINCT contract_number) as contracts_count,
  STRING_AGG(DISTINCT contract_number, ', ') as contracts
FROM materials
GROUP BY name
HAVING COUNT(DISTINCT contract_number) > 1;
```

**Ожидаемый результат:**  
Десятки/сотни материалов могут быть в нескольких договорах → **проблема массовая**!

---

## 🎯 Последствия проблемы

### 1. Неправильный учёт остатков по договорам 🔴

- Остатки материалов **не соответствуют** реальному использованию по договору
- Договор 173-суб-17 показывает расход, хотя материал не использовался
- Договор 173-суб-26 показывает полные остатки, хотя материал использовался

### 2. Невозможность корректной отчётности 🔴

- Отчёты по расходу материалов по договорам **некорректны**
- Бухгалтерия не может правильно списать расходы на договор
- Нарушение финансового учёта

### 3. Проблемы при закрытии договора ⚠️

- При закрытии договора 173-суб-26 остатки материалов будут **завышены**
- При закрытии договора 173-суб-17 остатки будут **занижены**

### 4. Конфликт при работе с несколькими договорами 🔴

- На одном объекте может быть несколько договоров
- Материалы могут закупаться по разным договорам
- Невозможно отследить, из какого договора реально списан материал

---

## 💡 Варианты решения

### Вариант 1: Добавить фильтр по contract_number в FIFO (рекомендуется)

**Идея:**  
Изменить логику представления `v_materials_with_usage`, чтобы FIFO работал **в рамках договора**.

**Алгоритм:**
1. При привязке материалов к сметной позиции учитывать `contract_number`
2. В оконной функции FIFO добавить `PARTITION BY estimate_id, contract_number`
3. Списывать материалы только из того договора, к которому относится сметная позиция

**SQL (концепт):**
```sql
me_fifo AS (
  SELECT 
    me.*,
    sum(quantity) OVER (
      PARTITION BY me.estimate_id, me.contract_number  -- ✅ Добавить contract_number
      ORDER BY me.receipt_date, me.id
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS prev_cum_qty
  FROM material_estimate me
  -- ✅ Добавить фильтр: только материалы из того же договора, что и estimate
  WHERE me.contract_number = (
    SELECT c.number 
    FROM estimates e 
    JOIN contracts c ON c.id = e.contract_id 
    WHERE e.id = me.estimate_id
  )
)
```

**Преимущества:**
- ✅ Правильный учёт остатков по договорам
- ✅ Корректная отчётность
- ✅ Минимальные изменения в БД (только представление)
- ✅ Обратная совместимость с приложением

**Недостатки:**
- ⚠️ Нужно изменить представление `v_materials_with_usage`
- ⚠️ Нужно пересмотреть функцию `v_materials_usage_period`

---

### Вариант 2: Добавить поле contract_number в material_aliases

**Идея:**  
Хранить номер договора в `material_aliases` для явной привязки материала к договору.

**Алгоритм:**
1. Добавить колонку `contract_number` в таблицу `material_aliases`
2. При создании алиаса указывать договор
3. При привязке материалов учитывать и название, и договор

**Преимущества:**
- ✅ Явная привязка материала к договору
- ✅ Гибкость (один материал может быть в нескольких договорах с разными алиасами)

**Недостатки:**
- ❌ Требует изменения схемы БД (миграция)
- ❌ Требует изменения UI (выбор договора при привязке)
- ❌ Сложнее для пользователей

---

### Вариант 3: Строгая привязка: материалы только из одного договора

**Идея:**  
Запретить использовать материалы из разных договоров для одной сметной позиции.

**Алгоритм:**
1. При импорте материалов автоматически фильтровать по договору
2. В UI показывать только материалы из договора сметной позиции
3. Добавить constraint в БД на уровне `material_aliases`

**Преимущества:**
- ✅ Полная изоляция договоров
- ✅ Простая логика FIFO

**Недостатки:**
- ❌ Негибкость (нельзя использовать материал из другого договора даже если нужно)
- ❌ Требует изменения бизнес-процессов

---

## ✅ Рекомендуемое решение

### Вариант 1 с дополнительными проверками

**Этап 1: Анализ масштаба проблемы (1 день)**
1. Выполнить SQL-запрос для поиска всех материалов в нескольких договорах
2. Проверить, сколько сметных позиций затронуто
3. Оценить влияние на существующие отчёты

**Этап 2: Изменение представления `v_materials_with_usage` (1-2 дня)**
1. Добавить фильтр по contract_number в FIFO
2. Обновить логику привязки материалов к сметам
3. Протестировать на тестовых данных

**Этап 3: Изменение функции `v_materials_usage_period` (1 день)**
1. Добавить учёт contract_number при расчёте использования за период
2. Протестировать экспорт за период

**Этап 4: Тестирование в приложении (1-2 дня)**
1. Проверить отображение остатков по договорам
2. Проверить фильтрацию по договорам в UI
3. Проверить экспорт отчётов

**Этап 5: Исправление исторических данных (опционально)**
1. Создать скрипт для пересчёта использованных материалов
2. Обновить поле `used` в таблице `materials` (если нужно)

---

## 📝 SQL для исправления представления

```sql
-- Исправленное представление v_materials_with_usage
CREATE OR REPLACE VIEW public.v_materials_with_usage AS
WITH norm_aliases AS (
  SELECT 
    lower(regexp_replace(translate(ma.alias_raw, 'Мм', 'mm'), '\s+', ' ', 'g')) AS normalized_name,
    ma.estimate_id
  FROM material_aliases ma
),
used_by_estimate AS (
  SELECT 
    wi.estimate_id,
    COALESCE(sum(wi.quantity), 0::numeric) AS used_qty
  FROM work_items wi
  WHERE wi.estimate_id IS NOT NULL
  GROUP BY wi.estimate_id
),
norm_materials AS (
  SELECT 
    m.id,
    m.name,
    m.unit,
    m.quantity,
    m.price,
    m.total,
    m.receipt_number,
    m.receipt_date,
    m.file_url,
    m.contract_number,
    lower(regexp_replace(translate(m.name, 'Мм', 'mm'), '\s+', ' ', 'g')) AS normalized_name
  FROM materials m
),
material_estimate AS (
  SELECT 
    nm.id,
    nm.name,
    nm.unit,
    nm.quantity,
    nm.price,
    nm.total,
    nm.receipt_number,
    nm.receipt_date,
    nm.file_url,
    nm.contract_number,
    nm.normalized_name,
    (
      SELECT na.estimate_id
      FROM norm_aliases na
      WHERE na.normalized_name = nm.normalized_name
      LIMIT 1
    ) AS estimate_id
  FROM norm_materials nm
),
-- ✅ ДОБАВЛЯЕМ ФИЛЬТР ПО ДОГОВОРУ
material_estimate_filtered AS (
  SELECT 
    me.*,
    (SELECT c.number FROM estimates e JOIN contracts c ON c.id = e.contract_id WHERE e.id = me.estimate_id) AS estimate_contract
  FROM material_estimate me
  -- ✅ Оставляем только материалы из того же договора, что и смета
  WHERE me.estimate_id IS NULL 
    OR me.contract_number = (
      SELECT c.number 
      FROM estimates e 
      JOIN contracts c ON c.id = e.contract_id 
      WHERE e.id = me.estimate_id
    )
),
me_fifo AS (
  SELECT 
    mef.id,
    mef.name,
    mef.unit,
    mef.quantity,
    mef.price,
    mef.total,
    mef.receipt_number,
    mef.receipt_date,
    mef.file_url,
    mef.contract_number,
    mef.normalized_name,
    mef.estimate_id,
    COALESCE(mef.quantity, 0) AS qty,
    -- ✅ PARTITION теперь по estimate_id И contract_number
    sum(COALESCE(mef.quantity, 0)) OVER (
      PARTITION BY mef.estimate_id, mef.contract_number
      ORDER BY mef.receipt_date, mef.id
      ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
    ) AS prev_cum_qty,
    row_number() OVER (
      PARTITION BY mef.estimate_id, mef.contract_number
      ORDER BY mef.receipt_date, mef.id
    ) AS rn,
    count(*) OVER (
      PARTITION BY mef.estimate_id, mef.contract_number
    ) AS cnt
  FROM material_estimate_filtered mef
)
SELECT 
  mef.id,
  mef.name,
  mef.unit,
  mef.quantity,
  mef.price,
  mef.total,
  mef.receipt_number,
  mef.receipt_date,
  mef.file_url,
  mef.contract_number,
  GREATEST(0, LEAST(
    COALESCE(mef.qty, 0),
    COALESCE(ube.used_qty, 0) - COALESCE(mef.prev_cum_qty, 0)
  )) AS used,
  CASE
    WHEN mef.quantity IS NULL THEN NULL
    WHEN mef.estimate_id IS NOT NULL AND mef.rn = mef.cnt THEN
      COALESCE(mef.quantity, 0) - GREATEST(0,
        COALESCE(ube.used_qty, 0) - COALESCE(mef.prev_cum_qty, 0)
      )
    ELSE
      COALESCE(mef.quantity, 0) - GREATEST(0, LEAST(
        COALESCE(mef.qty, 0),
        COALESCE(ube.used_qty, 0) - COALESCE(mef.prev_cum_qty, 0)
      ))
  END AS remaining,
  mef.estimate_id
FROM me_fifo mef
LEFT JOIN used_by_estimate ube ON ube.estimate_id = mef.estimate_id;
```

---

## 🔍 Проверка после исправления

После применения исправленного представления результат должен быть:

| Договор | Партий | Всего | Использовано | Остаток |
|---------|--------|-------|--------------|---------|
| **173-суб-17** | 1 | 60 м | **0 м** ✅ | 60 м |
| **173-суб-26** | 9 | 3990 м | **30 м** ✅ | 3960 м |

---

## 📞 Контакты и вопросы

**Разработчик:** Проектная команда  
**Дата отчёта:** 6 октября 2025 года  
**Версия:** 1.0

---

**ВАЖНО:**  
Проблема имеет **критический приоритет** 🔴 и требует решения до внедрения в продакшн. Неправильный учёт материалов по договорам ведёт к финансовым ошибкам и проблемам с бухгалтерией.

