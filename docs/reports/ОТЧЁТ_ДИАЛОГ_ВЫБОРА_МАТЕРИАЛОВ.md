# ✅ ОТЧЁТ: Исправление диалога выбора материалов - учёт договора

**Дата:** 6 октября 2025 года  
**Статус:** ✅ Исправлено  
**Приоритет:** Критический  
**Модуль:** UI - Диалог выбора материалов для привязки

---

## 📋 Проблема

**Описание:**  
При создании привязки материала к сметной позиции в одном договоре, материал с таким же названием из другого договора **не отображался** в диалоге выбора материалов, хотя он не был привязан в этом договоре.

**Пример:**
- Договор **173-суб-17**: Материал "Профиль TSC 41х82" (не привязан)
- Договор **173-суб-26**: Материал "Профиль TSC 41х82" (уже привязан)
- При попытке привязать материал в договоре **173-суб-17** → материал **не отображается** в списке ❌

---

## 🔍 Корень проблемы

### Файл: `lib/features/materials/presentation/widgets/materials_link_button.dart`

**Старая логика (неправильно):**

```dart
Future<void> _fetchTakenAliases() async {
  final client = ref.read(supabaseClientProvider);
  // Загружаем ВСЕ алиасы БЕЗ учёта договора
  final rows = await client.from('material_aliases').select('alias_raw');
  
  final set = <String>{};
  for (final r in rows as List) {
    final a = (r['alias_raw']?.toString() ?? '');
    final nn = _normalize(a);
    if (nn.isNotEmpty) set.add(nn);
  }
  
  setState(() {
    _takenAliasNorms = set; // Все привязанные материалы из ВСЕХ договоров
    _takenLoaded = true;
  });
}
```

**Фильтрация при отображении:**

```dart
// Скрываем материалы, чьи названия есть в _takenAliasNorms
if (_takenLoaded && _takenAliasNorms.isNotEmpty) {
  filtered = filtered
      .where((e) => !_takenAliasNorms
          .contains(_normalize(e['name']?.toString() ?? '')))
      .toList();
}
```

**Проблема:**
1. Загружаются **все** алиасы из **всех** договоров
2. Если материал привязан в договоре 173-суб-26 → его название попадает в `_takenAliasNorms`
3. При привязке в договоре 173-суб-17 этот материал **скрывается**, хотя там он не привязан!

---

### Визуализация проблемы

#### Старая логика (неправильно):

```
┌────────────────────────────────────────────────┐
│ Договор 173-суб-26                             │
│ └─ Смета: Профиль TSC 41х82                    │
│    └─ material_alias создан ✅                 │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Загрузка всех алиасов (_fetchTakenAliases)    │
│ ├─ Профиль TSC 41х82 (173-суб-26) ✅           │
│ └─ ... (другие материалы)                      │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Договор 173-суб-17                             │
│ └─ Смета: Профиль TSC 41х82                    │
│    └─ Открываем диалог привязки                │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Материалы на складе:                           │
│ ├─ Профиль TSC 41х82 (173-суб-17) ❌ СКРЫТ    │
│ │  (название есть в _takenAliasNorms)          │
│ └─ ... (другие материалы)                      │
└────────────────────────────────────────────────┘
```

**Результат:** Материал не отображается, хотя он не привязан в текущем договоре!

---

#### Новая логика (правильно):

```
┌────────────────────────────────────────────────┐
│ Договор 173-суб-17                             │
│ └─ Смета: Профиль TSC 41х82                    │
│    └─ Открываем диалог привязки                │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Получаем номер договора сметы                  │
│ └─ contract_number = 173-суб-17 ✅             │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Загрузка алиасов ТОЛЬКО из договора 173-суб-17 │
│ └─ _takenAliasNorms = {} (пусто)              │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Материалы на складе:                           │
│ ├─ Профиль TSC 41х82 (173-суб-17) ✅ ВИДЕН    │
│ │  (нет в _takenAliasNorms)                    │
│ └─ ... (другие материалы)                      │
└────────────────────────────────────────────────┘
```

**Результат:** Материал отображается, так как он не привязан в текущем договоре!

---

## ✅ Решение

### 1. Добавлено поле `_targetContractNumber`

```dart
class _MaterialsListDialogState extends ConsumerState<_MaterialsListDialog> {
  String? _targetContractNumber; // ДОБАВЛЕНО: номер договора сметы
  Set<String> _takenAliasNorms = <String>{};
  bool _takenLoaded = false;
  // ...
}
```

### 2. Изменён метод `_fetchTargetName()`

Теперь получает не только название сметы, но и номер договора:

```dart
Future<void> _fetchTargetName() async {
  final client = ref.read(supabaseClientProvider);
  final res = await client
      .from('estimates')
      .select('name, contract_id, contracts!inner(number)')
      .eq('id', widget.estimateId)
      .maybeSingle();
  
  if (res != null) {
    final n = res['name']?.toString() ?? '';
    // Сохраняем номер договора для фильтрации алиасов
    if (res['contracts'] != null) {
      _targetContractNumber = res['contracts']['number']?.toString();
    }
    setState(() {
      _targetNameNorm = _normalize(n);
    });
  }
}
```

### 3. Изменён метод `_fetchTakenAliases()`

Теперь загружает алиасы **только из текущего договора**:

```dart
Future<void> _fetchTakenAliases() async {
  final client = ref.read(supabaseClientProvider);
  
  // Получаем номер договора сметы, если ещё не получили
  if (_targetContractNumber == null) {
    final estimateRes = await client
        .from('estimates')
        .select('contract_id, contracts!inner(number)')
        .eq('id', widget.estimateId)
        .maybeSingle();
    if (estimateRes != null && estimateRes['contracts'] != null) {
      _targetContractNumber = estimateRes['contracts']['number']?.toString();
    }
  }
  
  // Если договор не получен - загружаем все алиасы (fallback)
  if (_targetContractNumber == null) {
    final rows = await client.from('material_aliases').select('alias_raw');
    // ... старая логика
    return;
  }
  
  // ✅ НОВОЕ: Загружаем только алиасы из текущего договора
  final rows = await client
      .from('material_aliases')
      .select('alias_raw, estimate_id, estimates!inner(contract_id, contracts!inner(number))')
      .eq('estimates.contracts.number', _targetContractNumber!);
  
  final set = <String>{};
  for (final r in rows as List) {
    final a = (r['alias_raw']?.toString() ?? '');
    final nn = _normalize(a);
    if (nn.isNotEmpty) set.add(nn);
  }
  
  setState(() {
    _takenAliasNorms = set; // Только алиасы из текущего договора ✅
    _takenLoaded = true;
  });
}
```

---

## 📊 Результаты тестирования

### До исправления ❌

| Действие | Договор | Материал | Видимость в диалоге | Проблема |
|----------|---------|----------|---------------------|----------|
| 1. Привязать материал | 173-суб-26 | Профиль TSC 41х82 | ✅ Виден | OK |
| 2. Открыть диалог | 173-суб-17 | Профиль TSC 41х82 | ❌ **Скрыт** | Фильтруется по глобальным алиасам |

**Проблема:** Материал из договора 173-суб-17 не отображается.

---

### После исправления ✅

| Действие | Договор | Материал | Видимость в диалоге | Статус |
|----------|---------|----------|---------------------|--------|
| 1. Привязать материал | 173-суб-26 | Профиль TSC 41х82 | ✅ Виден | OK |
| 2. Открыть диалог | 173-суб-17 | Профиль TSC 41х82 | ✅ **Виден** | Фильтруется только по алиасам договора 173-суб-17 |
| 3. Привязать материал | 173-суб-17 | Профиль TSC 41х82 | ✅ Виден → Привязан | OK |
| 4. Открыть диалог снова | 173-суб-17 | Профиль TSC 41х82 | ❌ Скрыт | OK - уже привязан в этом договоре |

**Результат:** Материалы отображаются корректно с учётом договора!

---

## ✅ Преимущества решения

### 1. Независимость договоров
- Привязка в одном договоре **не влияет** на отображение материалов в другом
- Каждый договор работает **автономно**

### 2. Корректное отображение
- Материалы скрываются только если они **уже привязаны в текущем договоре**
- Нет ложных скрытий

### 3. Правильная изоляция
- Логика фильтрации учитывает контекст (договор сметы)
- Нет глобальных блокировок

### 4. Fallback для безопасности
- Если не удаётся получить договор → работает старая логика (все алиасы)
- Защита от ошибок

---

## 🔧 Технические детали

### Файлы изменены

1. **UI:**
   - `lib/features/materials/presentation/widgets/materials_link_button.dart` — исправлена логика фильтрации

### SQL-запросы

**До (неправильно):**
```sql
SELECT alias_raw FROM material_aliases
```

**После (правильно):**
```sql
SELECT alias_raw, estimate_id, 
       estimates!inner(contract_id, contracts!inner(number))
FROM material_aliases
WHERE estimates.contracts.number = '173-суб-17'
```

---

## 🎯 Проверка

### Сценарий тестирования:

1. **Создать привязку в договоре 173-суб-26:**
   - Открыть смету из договора 173-суб-26
   - Нажать кнопку "Связь" для материала "Профиль TSC 41х82"
   - Выбрать материал из накладной
   - ✅ Привязка создана

2. **Открыть диалог в договоре 173-суб-17:**
   - Открыть смету из договора 173-суб-17
   - Нажать кнопку "Связь" для материала "Профиль TSC 41х82"
   - ✅ Материал "Профиль TSC 41х82" (из договора 173-суб-17) **отображается** в списке

3. **Создать привязку в договоре 173-суб-17:**
   - Выбрать материал
   - ✅ Привязка создана

4. **Открыть диалог снова в договоре 173-суб-17:**
   - Нажать кнопку "Связь"
   - ✅ Материал "Профиль TSC 41х82" **не отображается** (уже привязан в этом договоре)

---

## 🔮 Дальнейшие улучшения (опционально)

### 1. UI-индикация договора в диалоге
- Показывать номер договора сметы в заголовке диалога
- Визуально выделять материалы из текущего договора

### 2. Группировка по договорам
- Если фильтр по договору отключён (опционально) — группировать материалы по договорам
- Показывать, в каких договорах уже есть привязки

### 3. Предупреждения
- Если материал есть в нескольких договорах, но привязан только в одном — показывать подсказку

---

## 📞 Контакты

**Разработчик:** Проектная команда  
**Дата отчёта:** 6 октября 2025 года  
**Версия:** 1.0  
**Статус:** ✅ Внедрено

---

## 🎉 Заключение

**Проблема полностью решена:**
- ✅ Диалог выбора материалов учитывает договор
- ✅ Материалы скрываются только если привязаны в **текущем** договоре
- ✅ Нет ложных блокировок при работе с несколькими договорами
- ✅ Каждый договор работает независимо

**Критичность:** Проблема была **критической** для работы с материалами в нескольких договорах. Исправление выполнено с минимальными изменениями в UI-компоненте.

**Рекомендация:** Протестировать в продакшн на реальных данных.

