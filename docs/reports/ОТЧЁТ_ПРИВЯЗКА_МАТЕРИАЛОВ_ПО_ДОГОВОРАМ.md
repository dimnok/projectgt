# ✅ ОТЧЁТ: Исправление привязки материалов - учёт договора

**Дата:** 6 октября 2025 года  
**Статус:** ✅ Исправлено  
**Приоритет:** Критический  
**Модуль:** Материалы (v_materials_with_usage)

---

## 📋 Проблема

**Описание:**  
При создании связи (material_alias) материала к сметной позиции в одном договоре, материалы с таким же названием из **другого договора** переставали отображаться в таблице "Материал по М-15".

**Пример:**
- Есть материал "Профиль TSC 41х82" в договоре **173-суб-17**
- Есть материал "Профиль TSC 41х82" в договоре **173-суб-26**
- Создаётся привязка (material_alias) для договора **173-суб-26**
- Материал из договора **173-суб-17** исчезает из таблицы ❌

---

## 🔍 Корень проблемы

### Старая логика (неправильно):

```sql
-- Шаг 1: Поиск estimate_id БЕЗ учёта договора
material_estimate AS (
  SELECT 
    nm.*,
    (
      SELECT na.estimate_id
      FROM norm_aliases na
      WHERE na.normalized_name = nm.normalized_name
      LIMIT 1  -- ← Берётся ПЕРВЫЙ попавшийся estimate_id!
    ) AS estimate_id
  FROM norm_materials nm
)

-- Шаг 2: Фильтрация по договору
material_estimate_filtered AS (
  SELECT me.*
  FROM material_estimate me
  WHERE me.estimate_id IS NULL 
    OR me.contract_number = (
      SELECT c.number FROM estimates e 
      JOIN contracts c ON c.id = e.contract_id 
      WHERE e.id = me.estimate_id
    )
)
```

**Проблема:**
1. Материал из договора **173-суб-17** ищет привязку по названию
2. Находится estimate_id из договора **173-суб-26** (первый в списке)
3. При фильтрации проверяется: `173-суб-17 == 173-суб-26`?  → **НЕТ**
4. Материал **отсекается** ❌

---

### Новая логика (правильно):

```sql
-- Шаг 1: Поиск estimate_id С УЧЁТОМ договора
material_estimate AS (
  SELECT 
    nm.*,
    (
      SELECT na.estimate_id
      FROM norm_aliases na
      JOIN estimates e ON e.id = na.estimate_id
      JOIN contracts c ON c.id = e.contract_id
      WHERE na.normalized_name = nm.normalized_name
        AND c.number = nm.contract_number  -- ← Проверяем договор!
      LIMIT 1
    ) AS estimate_id
  FROM norm_materials nm
)

-- Шаг 2: Фильтрация НЕ НУЖНА - привязка уже в рамках договора
```

**Результат:**
1. Материал из договора **173-суб-17** ищет estimate_id **только в договоре 173-суб-17**
2. Если нет привязки - estimate_id остаётся `NULL`
3. Материал **отображается** в таблице ✅

---

## ✅ Решение

### Изменения в представлении `v_materials_with_usage`

**Было:**
```sql
(
  SELECT na.estimate_id
  FROM norm_aliases na
  WHERE na.normalized_name = nm.normalized_name
  LIMIT 1
) AS estimate_id
```

**Стало:**
```sql
(
  SELECT na.estimate_id
  FROM norm_aliases na
  JOIN estimates e ON e.id = na.estimate_id
  JOIN contracts c ON c.id = e.contract_id
  WHERE na.normalized_name = nm.normalized_name
    AND c.number = nm.contract_number  -- ← Добавлена проверка договора
  LIMIT 1
) AS estimate_id
```

### Изменения в функции `v_materials_usage_period`

Та же логика - добавлена проверка договора при поиске estimate_id.

### Удалён CTE `material_estimate_filtered`

Больше не нужен - фильтрация по договору происходит на этапе привязки.

---

## 📊 Результаты тестирования

### До исправления ❌

| Договор | Материал | Видимость в М-15 | Проблема |
|---------|----------|------------------|----------|
| 173-суб-17 | Профиль TSC 41х82 (60 м) | ❌ НЕ виден | Отсекается фильтром |
| 173-суб-26 | Профиль TSC 41х82 (3990 м) | ✅ Виден | Есть привязка |

**Проблема:**  
Материал из 173-суб-17 не отображается после создания привязки в 173-суб-26.

---

### После исправления ✅

| Договор | Материал | Видимость в М-15 | estimate_id | Статус |
|---------|----------|------------------|-------------|--------|
| 173-суб-17 | Профиль TSC 41х82 (60 м) | ✅ Виден | `NULL` | Нет привязки в этом договоре |
| 173-суб-26 | Профиль TSC 41х82 (3990 м) | ✅ Виден | `4acd...` | Есть привязка |

**Результат:**  
Оба материала отображаются независимо друг от друга!

---

## 🔧 Архитектура решения

### Логика привязки по договорам

```
┌──────────────────────────────────────────────────┐
│ Материал 1: Профиль TSC 41х82                    │
│ ├─ Договор: 173-суб-17                           │
│ ├─ Накладная: 2212, Дата: 17.06.2024            │
│ └─ Количество: 60 м                              │
└──────────────────────────────────────────────────┘
                    ↓ Поиск estimate_id
┌──────────────────────────────────────────────────┐
│ Ищем material_alias:                             │
│ ├─ Название: Профиль TSC 41х82                   │
│ └─ ИЗ ДОГОВОРА 173-суб-17 ← ВАЖНО!               │
└──────────────────────────────────────────────────┘
                    ↓ Результат
┌──────────────────────────────────────────────────┐
│ estimate_id: NULL (нет привязки в этом договоре) │
│ Материал ОТОБРАЖАЕТСЯ в М-15 ✅                  │
└──────────────────────────────────────────────────┘

───────────────────────────────────────────────────

┌──────────────────────────────────────────────────┐
│ Материал 2: Профиль TSC 41х82                    │
│ ├─ Договор: 173-суб-26                           │
│ ├─ Накладная: 2240, Дата: 21.06.2024            │
│ └─ Количество: 492 м                             │
└──────────────────────────────────────────────────┘
                    ↓ Поиск estimate_id
┌──────────────────────────────────────────────────┐
│ Ищем material_alias:                             │
│ ├─ Название: Профиль TSC 41х82                   │
│ └─ ИЗ ДОГОВОРА 173-суб-26 ← ВАЖНО!               │
└──────────────────────────────────────────────────┘
                    ↓ Результат
┌──────────────────────────────────────────────────┐
│ estimate_id: 4acd9c76... (есть привязка)         │
│ Материал ОТОБРАЖАЕТСЯ в М-15 ✅                  │
│ FIFO работает по этой смете                      │
└──────────────────────────────────────────────────┘
```

---

## ✅ Преимущества решения

### 1. Независимость договоров
- Материалы разных договоров не влияют друг на друга
- Привязка в одном договоре не скрывает материалы из другого

### 2. Правильная изоляция
- Каждый договор работает **автономно**
- Привязка material_alias работает **в рамках договора**

### 3. Корректное отображение
- Все материалы отображаются в таблице М-15
- Нет "пропаж" материалов при создании привязок

### 4. Чистая логика
- Не нужна дополнительная фильтрация
- Логика привязки учитывает договор сразу

---

## 📝 Что изменено

### Файлы:
1. `supabase/migrations/20251006_fix_materials_fifo_by_contract.sql` — обновлена миграция
2. БД: представление `v_materials_with_usage` — добавлен JOIN к contracts при поиске estimate_id
3. БД: функция `v_materials_usage_period` — добавлена та же логика

---

## 🎯 Проверка

### SQL для проверки:

```sql
-- Проверить материалы из обоих договоров
SELECT 
  m.contract_number,
  m.name,
  m.receipt_number,
  m.quantity,
  v.estimate_id,
  v.used,
  v.remaining
FROM materials m
LEFT JOIN v_materials_with_usage v ON v.id = m.id
WHERE LOWER(m.name) LIKE '%профиль монтажный tsc 41х82dx2,0-6000 zn275%'
  AND m.contract_number IN ('173-суб-17', '173-суб-26')
ORDER BY m.contract_number, m.receipt_date;
```

**Ожидаемый результат:**
- Материалы из **173-суб-17** видны, `estimate_id = NULL`
- Материалы из **173-суб-26** видны, `estimate_id = 4acd9c76...`

---

## 🔮 Дальнейшие улучшения (опционально)

### 1. UI для привязки по договорам
- При создании привязки явно показывать договор
- Не позволять привязывать к смете из другого договора

### 2. Индикация непривязанных материалов
- Визуально выделять материалы без estimate_id
- Подсказывать, что нужно создать привязку

### 3. Массовая привязка
- Инструмент для автоматической привязки материалов к сметам в рамках договора
- Сопоставление по названию с учётом договора

---

## 📞 Контакты

**Разработчик:** Проектная команда  
**Дата отчёта:** 6 октября 2025 года  
**Версия:** 1.0  
**Статус:** ✅ Внедрено

---

## 🎉 Заключение

**Проблема полностью решена:**
- ✅ Материалы из разных договоров отображаются независимо
- ✅ Привязка material_alias учитывает договор
- ✅ Нет "пропаж" материалов при создании связей
- ✅ Каждый договор работает автономно

**Критичность:** Проблема была **критической** и могла привести к путанице в учёте материалов. Исправление выполнено с минимальными изменениями в логике представления.

**Рекомендация:** Применить миграцию немедленно.

