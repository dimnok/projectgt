# üîç –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –ö–ê–õ–ï–ù–î–ê–†–Ø –°–ú–ï–ù: –ê–ù–ê–õ–ò–ó –ò –†–ï–®–ï–ù–ò–ï

## üéØ –ü–†–û–ë–õ–ï–ú–ê: –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `works` —Å–æ–¥–µ—Ä–∂–∏—Ç 33 –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (–æ–∫—Ç—è–±—Ä—å 2025): 33 –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ü–µ—Ä–∏–æ–¥: —Å 2025-10-01 –ø–æ 2025-10-18
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã (`objects`, `work_items`) –∑–∞–ø–æ–ª–Ω–µ–Ω—ã

---

## üîê –í–´–Ø–í–õ–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: RLS (Row-Level Security)

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞

–¢–∞–±–ª–∏—Ü–∞ `works` –∏–º–µ–µ—Ç **4 RLS-–ø–æ–ª–∏—Ç–∏–∫–∏**, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç:

```sql
-- –ü–æ–ª–∏—Ç–∏–∫–∞ SELECT
(EXISTS (
  SELECT 1 FROM profiles p
  WHERE p.id = auth.uid() 
    AND (p.role = 'admin' OR p.object_ids @> ARRAY[works.object_id])
))
```

### –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Ä–∞–±–æ—Ç—É, –¢–û–õ–¨–ö–û –µ—Å–ª–∏:**
1. ‚úÖ –û–Ω –∞–¥–º–∏–Ω (`role = 'admin'`)
2. **–ò–õ–ò** –æ–±—ä–µ–∫—Ç –≤ –µ–≥–æ `profiles.object_ids`

**–ï—Å–ª–∏ –ù–ò –æ–¥–Ω–æ –∏–∑ —ç—Ç–æ–≥–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Üí Supabase –ë–õ–û–ö–ò–†–£–ï–¢ –∑–∞–ø—Ä–æ—Å ‚Üí –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è!**

---

## üìã –ß–¢–û–ë–´ –û–ü–†–ï–î–ï–õ–ò–¢–¨ –ü–†–ò–ß–ò–ù–£

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
SELECT 
  id,
  email,
  role,
  object_ids,
  approved_at
FROM profiles
WHERE id = auth.uid()
```

**–ü—Ä–æ–≤–µ—Ä—å:**
- ‚úÖ `role = 'admin'` ? –ï—Å–ª–∏ –¥–∞ ‚Üí –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –í–°–ï —Ä–∞–±–æ—Ç—ã
- ‚úÖ `object_ids` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã –∏–∑ `works` ? –ï—Å–ª–∏ –¥–∞ ‚Üí –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å —Ä–∞–±–æ—Ç—ã
- ‚ùå `role != 'admin'` –ò `object_ids` –ø—É—Å—Ç–∞/NULL ‚Üí **–ë–õ–û–ö–ò–†–û–í–ö–ê!**

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å –æ–±—ä–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–∞—Ö

```sql
SELECT DISTINCT object_id FROM works WHERE date >= CURRENT_DATE - INTERVAL '30 days'
```

**–ü—Ä–æ–≤–µ—Ä—å:**
- –ï—Å—Ç—å –ª–∏ —ç—Ç–∏ ID –≤ `profiles.object_ids` —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

---

## ‚úÖ –†–ï–®–ï–ù–ò–Ø

### –†–µ—à–µ–Ω–∏–µ 1: –°–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º (–ë–´–°–¢–†–û)

```sql
UPDATE profiles
SET role = 'admin'
WHERE id = '<–≤–∞—à-user-id>';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –í–°–ï —Ä–∞–±–æ—Ç—ã –Ω–∞ –í–°–ï –æ–±—ä–µ–∫—Ç—ã ‚úÖ

---

### –†–µ—à–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã –≤ `object_ids` (–ü–†–ê–í–ò–õ–¨–ù–û)

```sql
UPDATE profiles
SET object_ids = ARRAY['<object-id-1>', '<object-id-2>']
WHERE id = '< –≤–∞—à-user-id>';
```

**–ü–æ–ª—É—á–∏—Ç—å ID –æ–±—ä–µ–∫—Ç–æ–≤:**
```sql
SELECT id, name FROM objects LIMIT 10
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –æ–±—ä–µ–∫—Ç—ã ‚úÖ

---

### –†–µ—à–µ–Ω–∏–µ 3: –ò–∑–º–µ–Ω–∏—Ç—å RLS-–ø–æ–ª–∏—Ç–∏–∫–∏ (–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï)

–ï—Å–ª–∏ RLS —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è, –º–æ–∂–Ω–æ –æ—Å–ª–∞–±–∏—Ç—å, –Ω–æ —ç—Ç–æ **—Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```sql
-- –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ—Å—Ç—É–ø –∫–æ –í–°–ï–ú —Ä–∞–±–æ—Ç–∞–º
CREATE POLICY "allow_all_select_works" ON works
  FOR SELECT USING (true);

-- –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ—Å—Ç—É–ø –∫ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
CREATE POLICY "allow_approved_users" ON works
  FOR SELECT
  USING (EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid()
    AND approved_at IS NOT NULL
  ));
```

---

## üìä –¶–ï–ü–¨ –î–ê–ù–ù–´–• (–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–ø—Ä–æ—Å)

```
ShiftsCalendarFlipCard
  ‚Üì
shiftsForMonthProvider (Riverpod)
  ‚Üì
ShiftsRepositoryImpl.getShiftsForMonth(month)
  ‚Üì
ShiftsDataSourceImpl.getShiftsForMonth(month)
  ‚Üì
supabaseClient.from('works').select(...) ‚Üê –ó–î–ï–°–¨ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è RLS!
  ‚Üì
‚úÖ SELECT –≤—ã–ø–æ–ª–Ω–µ–Ω (–µ—Å–ª–∏ RLS –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∞)
  ‚úó Supabase –ë–õ–û–ö–ò–†–£–ï–¢ (–µ—Å–ª–∏ RLS –ù–ï –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∞)
  ‚Üì
shiftsForMonthProvider.when(
  loading: () => Spinner,
  error: (err) => Error text,    ‚Üê –ó–î–ï–°–¨ –≤–∏–¥–Ω–∞ –æ—à–∏–±–∫–∞ RLS
  data: (shifts) => Calendar     ‚Üê –ó–î–ï–°–¨ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ
)
```

---

## üîß –®–ê–ì –ó–ê –®–ê–ì–û–ú: –ö–ê–ö –ò–°–ü–†–ê–í–ò–¢–¨

### 1. –û–ø—Ä–µ–¥–µ–ª–∏ —Å–≤–æ–π user_id

–í Firebase Console –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: **Settings ‚Üí Profile**

### 2. –í—ã–ø–æ–ª–Ω–∏ –≤ Supabase SQL Editor

```sql
-- –í–∞—Ä–∏–∞–Ω—Ç A: –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
UPDATE profiles
SET role = 'admin'
WHERE email = '—Ç–≤–æ–π-email@example.com';

-- –ò–õ–ò –í–∞—Ä–∏–∞–Ω—Ç B: –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã
UPDATE profiles
SET object_ids = ARRAY[
  (SELECT id FROM objects LIMIT 1)::uuid
]
WHERE email = '—Ç–≤–æ–π-email@example.com';
```

### 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### 4. –ü—Ä–æ–≤–µ—Ä—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å

---

## üêõ –ö–û–î: –ì–î–ï –ú–û–ñ–ï–¢ –ë–´–¢–¨ –û–®–ò–ë–ö–ê

### ‚úÖ –ö–æ–¥ –ë–ï–ó –æ—à–∏–±–æ–∫:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏—á–∏–Ω–∞ |
|-----------|--------|---------|
| `ShiftsCalendarFlipCard` | ‚úÖ OK | –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä |
| `shiftsForMonthProvider` | ‚úÖ OK | –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç –º–µ—Å—è—Ü |
| `ShiftsRepositoryImpl` | ‚úÖ OK | –ü—Ä–∞–≤–∏–ª—å–Ω–æ –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç datasource |
| `ShiftsDataSourceImpl` | ‚úÖ OK | –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–∞—Ç–∞-–∑–∞–ø–∏—Å—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞) |
| –¢–∞–±–ª–∏—Ü–∞ `works` | ‚úÖ OK | –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å (33 –∑–∞–ø–∏—Å–∏) |

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –ó–î–ï–°–¨:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–±–ª–µ–º–∞ |
|-----------|--------|----------|
| **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** | ‚ùå –ë–õ–û–ö–ò–†–£–ï–¢ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—ä–µ–∫—Ç–∞–º |
| **–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** | ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û | `object_ids` –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–æ–ª—å |

---

## üìù –ë–´–°–¢–†–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

–í—Å—Ç–∞–≤—å –≤ –±—Ä–∞—É–∑–µ—Ä DevTools Console:

```javascript
// –ë—É–¥–µ—Ç –≤—ã–¥–∞–Ω–∞ –æ—à–∏–±–∫–∞ RLS –µ—Å–ª–∏
// "user is not authorized to access..."
// "policies do not grant the necessary permissions..."
```

–ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Supabase:
- –°—Épabase Dashboard ‚Üí Logs ‚Üí API ‚Üí –ò—â–∏ –æ—à–∏–±–∫–∏ RLS

---

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –ß–ï–ö-–õ–ò–°–¢

- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ profiles —Ç–∞–±–ª–∏—Ü–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª role (–∞–¥–º–∏–Ω –∏–ª–∏ –Ω–µ—Ç)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª object_ids (—Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –Ω—É–∂–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
- [ ] –í—ã–ø–æ–ª–Ω–∏–ª UPDATE –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- [ ] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ ‚úÖ

---

**–°—Ç–∞—Ç—É—Å:** üî¥ **–¢–†–ï–ë–£–ï–¢ –î–ï–ô–°–¢–í–ò–Ø** - –ù—É–∂–Ω–æ –¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—ä–µ–∫—Ç–∞–º
