# üóÑÔ∏è –û–¢–ß–Å–¢: –ë–î-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç—á—ë—Ç–∞ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–º–µ—Ç

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 27 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

---

## üìä –ù–ê–ô–î–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –í –ë–î

### ‚úÖ –§—É–Ω–∫—Ü–∏—è #1: `get_estimate_completion_report()`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–£–©–ï–°–¢–í–£–ï–¢ –≤ –ë–î  
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:** ‚ùå –ù–ï –ù–ê–ô–î–ï–ù–ê (–≤–∏–¥–∏–º–æ, —Å–æ–∑–¥–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –≤ —Ä–∞–º–∫–∞—Ö –¥—Ä—É–≥–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ:**
```dart
lib/data/datasources/estimate_data_source.dart, —Å—Ç—Ä–æ–∫–∞ 201:
final response = await client.rpc('get_estimate_completion_report');
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- ‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –Ω–µ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–µ –º–∏–≥—Ä–∞—Ü–∏–π
- ‚ö†Ô∏è –ù–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –∫–æ–≥–¥–∞ –æ–Ω–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
- ‚ö†Ô∏è –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å, –≥–¥–µ –æ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞

---

### ‚úÖ –§—É–Ω–∫—Ü–∏—è #2: `get_estimate_completion_paginated()`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–£–©–ï–°–¢–í–£–ï–¢ –ò –ó–ê–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–ê  
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:** ‚úÖ `/supabase/migrations/20251027_add_estimate_completion_paginated.sql`  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 27 –æ–∫—Ç—è–±—Ä—è 2025 (–≤—á–µ—Ä–∞!)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–º–µ—Ç
-- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∏–ª–ª–∏–æ–Ω—ã —Å—Ç—Ä–æ–∫ —Å infinite scroll
-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ë–î (—Å–∏—Å—Ç–µ–º–∞ ‚Üí –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ ‚Üí –Ω–æ–º–µ—Ä)

CREATE OR REPLACE FUNCTION get_estimate_completion_paginated(
  p_offset INT DEFAULT 0,
  p_limit INT DEFAULT 50,
  p_object_ids UUID[] DEFAULT NULL,
  p_contract_ids UUID[] DEFAULT NULL,
  p_systems TEXT[] DEFAULT NULL
)
RETURNS JSONB AS $$
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. üìç –ü–æ–ª—É—á–∞–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞
2. üìä –°—á–∏—Ç–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–¥–ª—è infinite scroll)
3. ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
4. üîÑ –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `estimates` –∏ `works`
5. üìà –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
6. üìã –°–û–†–¢–ò–†–£–ï–¢ –ù–ê –ë–î: —Å–∏—Å—Ç–µ–º–∞ ‚Üí –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ ‚Üí –Ω–æ–º–µ—Ä

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "data": [...],           // –ú–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  "total_count": 500,      // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
  "has_next": true         // –ï—Å—Ç—å –ª–∏ –µ—â—ë —Å—Ç—Ä–∞–Ω–∏—Ü—ã?
}
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|-----|---------|--------------|
| `p_offset` | INT | –°–º–µ—â–µ–Ω–∏–µ (–¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏) | 0 |
| `p_limit` | INT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É | 50 |
| `p_object_ids` | UUID[] | –§–∏–ª—å—Ç—Ä –ø–æ –æ–±—ä–µ–∫—Ç–∞–º | NULL (–≤—Å–µ) |
| `p_contract_ids` | UUID[] | –§–∏–ª—å—Ç—Ä –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º | NULL (–≤—Å–µ) |
| `p_systems` | TEXT[] | –§–∏–ª—å—Ç—Ä –ø–æ —Å–∏—Å—Ç–µ–º–∞–º | NULL (–≤—Å–µ) |

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** O(n) –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é + O(n log n) –Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É

---

## üìç –ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ï –¢–ê–ë–õ–ò–¶–´

### –¢–∞–±–ª–∏—Ü–∞ 1: `estimates` (–æ—Å–Ω–æ–≤–Ω–∞—è)
```
–ö–æ–ª–æ–Ω–∫–∞    | –¢–∏–ø    | –†–æ–ª—å
-----------|--------|----------------------------------
id         | UUID   | PRIMARY KEY
object_id  | UUID   | Foreign Key ‚Üí objects.id
contract_id| UUID   | Foreign Key ‚Üí contracts.id
system     | TEXT   | –°–∏—Å—Ç–µ–º–∞ (—ç–ª–µ–∫—Ç—Ä–∏–∫–∞, –≤–æ–¥–æ–ø—Ä–æ–≤–æ–¥)
subsystem  | TEXT   | –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ (—Ä–∞–∑–¥–µ–ª—ã)
number     | TEXT   | –ù–æ–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
name       | TEXT   | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
unit       | TEXT   | –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
quantity   | DOUBLE | –ü–ª–∞–Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
total      | DOUBLE | –ü–ª–∞–Ω–æ–≤–∞—è —Å—É–º–º–∞
```

### –¢–∞–±–ª–∏—Ü–∞ 2: `works` (—Å–≤—è–∑–∞–Ω–Ω–∞—è)
```
–ö–æ–ª–æ–Ω–∫–∞          | –¢–∏–ø    | –†–æ–ª—å
-----------------|--------|----------------------------------
id               | UUID   | PRIMARY KEY
estimate_id      | UUID   | Foreign Key ‚Üí estimates.id
completed_quantity| DOUBLE | –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
completed_cost   | DOUBLE | –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Å—É–º–º–∞
```

**–°–≤—è–∑—å:**
```
estimates (1) ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ (N) works
   ‚Üì
  id  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí estimate_id
```

---

## üîß –ò–ù–î–ï–ö–°–´ –î–õ–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### ‚úÖ –ò–Ω–¥–µ–∫—Å #1: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
```sql
CREATE INDEX idx_estimates_filters 
ON estimates(object_id, contract_id, system);
```
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£—Å–∫–æ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –æ–±—ä–µ–∫—Ç–∞–º, –¥–æ–≥–æ–≤–æ—Ä–∞–º –∏ —Å–∏—Å—Ç–µ–º–∞–º  
**–≠—Ñ—Ñ–µ–∫—Ç:** üëç –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è

### ‚úÖ –ò–Ω–¥–µ–∫—Å #2: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
```sql
CREATE INDEX idx_estimates_sort 
ON estimates(system, subsystem, number);
```
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£—Å–∫–æ—Ä–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –Ω–∞ –ë–î  
**–≠—Ñ—Ñ–µ–∫—Ç:** üëç –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å

### ‚úÖ –ò–Ω–¥–µ–∫—Å #3: –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
```sql
CREATE INDEX idx_estimates_name_gin
ON estimates USING GIN (to_tsvector('russian', name));
```
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë—ã—Å—Ç—Ä—ã–π –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫  
**–§–∞–π–ª:** `/supabase/migrations/20251009_add_gin_index_estimates_name.sql`

---

## üö® –ü–†–û–ë–õ–ï–ú–´ –ò –ù–ï–£–í–Ø–ó–ö–ò

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #1: –î–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞!

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```
1Ô∏è‚É£  get_estimate_completion_report()     ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ (–Ω–æ –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞?)
    ‚îú‚îÄ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ‚ùå –ù–ï–ò–ó–í–ï–°–¢–ù–´
    ‚îú‚îÄ –ú–∏–≥—Ä–∞—Ü–∏—è: ‚ùå –ù–ï –ù–ê–ô–î–ï–ù–ê
    ‚îî‚îÄ –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π

2Ô∏è‚É£  get_estimate_completion_paginated()  ‚Üê –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è (27.10.2025)
    ‚îú‚îÄ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–∏—Å–∞–Ω—ã
    ‚îú‚îÄ –ú–∏–≥—Ä–∞—Ü–∏—è: ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç (20251027_add_estimate_completion_paginated.sql)
    ‚îî‚îÄ –°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è, —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
- üìç –ë—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–≤—á–µ—Ä–∞)
- üìç –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –∫–æ–¥–µ
- üìç –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—Å—ë –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_estimate_completion_report()` –≤–º–µ—Å—Ç–æ `get_estimate_completion_paginated()`

**–†–∏—Å–∫–∏:**
- ‚ùå –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ä–∞–∑ (–Ω–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
- ‚ùå –ù–∞ 1000+ —Å—Ç—Ä–æ–∫ = –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- ‚ùå –ù–µ—Ç infinite scroll
- ‚ùå –î–µ–Ω—å–≥–∏ –Ω–∞ –≤–µ—Ç–µ—Ä: —Ñ—É–Ω–∫—Ü–∏—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!

---

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #2: –§—É–Ω–∫—Ü–∏—è `get_estimate_completion_report()` –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–í–æ–ø—Ä–æ—Å—ã:**
1. ‚ùì –ì–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_estimate_completion_report()`?
2. ‚ùì –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç?
3. ‚ùì –ö–∞–∫ –æ–Ω–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?
4. ‚ùì –ú–æ–∂–µ—Ç –ª–∏ –±—ã—Ç—å, —á—Ç–æ —ç—Ç–æ VIEW –≤–º–µ—Å—Ç–æ FUNCTION?

**–¢–µ–æ—Ä–∏—è:**
- –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ VIEW (–º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
- –í–æ–∑–º–æ–∂–Ω–æ, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Supabase (–Ω–µ –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö)
- –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –∑–∞–±—ã–ª–∏ –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö

---

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #3: –¢–µ–∫—É—â–∏–π –∫–æ–¥ –º–æ–∂–µ—Ç –≤–æ–æ–±—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å!

**–í —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ:**
```dart
// lib/data/datasources/estimate_data_source.dart, —Å—Ç—Ä–æ–∫–∞ 201
final response = await client.rpc('get_estimate_completion_report');
```

**–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è `get_estimate_completion_report` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î:**
- ‚ùå –≠–∫—Ä–∞–Ω –æ—Ç—á—ë—Ç–∞ –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π
- ‚ùå RPC-–≤—ã–∑–æ–≤ —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π 404/400

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å RPC –≤—Ä—É—á–Ω—É—é –≤ Supabase SQL Editor
2. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–æ–±—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è #1: –ù–∞–π—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `get_estimate_completion_report()`

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# 1. –ü–æ–∏—Å–∫ –≤ —Ñ–∞–π–ª–∞—Ö
grep -r "get_estimate_completion_report" /Users/dmitrit./projectgt/

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Supabase Dashboard
#    Functions ‚Üí public ‚Üí get_estimate_completion_report

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å SQL:
SELECT pg_get_functiondef('public.get_estimate_completion_report'::regprocedure);
```

---

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è #2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π

**–¢–µ–∫—É—â–µ–µ (–ü–õ–û–•–û):**
```dart
final response = await client.rpc('get_estimate_completion_report');
// –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ä–∞–∑!
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ (–•–û–†–û–®–û):**
```dart
final response = await client.rpc(
  'get_estimate_completion_paginated',
  params: {
    'p_offset': 0,
    'p_limit': 50,  // –ü–µ—Ä–≤—ã–µ 50 –∑–∞–ø–∏—Å–µ–π
    'p_object_ids': objectIds,
    'p_contract_ids': contractIds,
    'p_systems': systems,
  },
);

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// {
//   "data": [...],
//   "total_count": 500,
//   "has_next": true
// }
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
‚úÖ –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö  
‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ infinite scroll  
‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ë–î (—ç–∫–æ–Ω–æ–º–∏—è CPU)  
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ –Ω–∞ –º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π  

---

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è #3: –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è `get_estimate_completion_report()`

–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞:

```sql
-- /supabase/migrations/20251028_create_estimate_completion_report.sql

CREATE OR REPLACE FUNCTION get_estimate_completion_report(
  p_object_ids UUID[] DEFAULT NULL,
  p_contract_ids UUID[] DEFAULT NULL,
  p_systems TEXT[] DEFAULT NULL
)
RETURNS TABLE (
  estimate_id UUID,
  object_id UUID,
  contract_id UUID,
  system TEXT,
  subsystem TEXT,
  number TEXT,
  name TEXT,
  unit TEXT,
  quantity DOUBLE PRECISION,
  total DOUBLE PRECISION,
  completed_quantity DOUBLE PRECISION,
  completed_total DOUBLE PRECISION,
  percentage INT,
  remaining_quantity DOUBLE PRECISION
) AS $$
BEGIN
  -- ... –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ...
END;
$$ LANGUAGE plpgsql STABLE;
```

---

## üìã –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –§–£–ù–ö–¶–ò–ô

| –§—É–Ω–∫—Ü–∏—è | –°–æ–∑–¥–∞–Ω–∞ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã | –°—Ç–∞—Ç—É—Å | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|---------|-----------|--------|-------------|--------------|
| `get_estimate_completion_report()` | ‚ùì | ‚ùì | ‚ö†Ô∏è –ù–µ—è—Å–Ω–æ | ‚úÖ –î–∞ | üî¥ –ù–∞–π—Ç–∏ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å |
| `get_estimate_completion_paginated()` | 27.10 | ‚úÖ –ü–æ–ª–Ω—ã–µ | ‚úÖ –•–æ—Ä–æ—à–æ | ‚ùå –ù–µ—Ç | üü¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–¥–µ |

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–°–µ–π—á–∞—Å:**
```
–§—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Üí RPC 'get_estimate_completion_report' ‚Üí –î–ë (–í–°–ï –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ä–∞–∑) ‚ùå
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
–§—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Üí ListView.builder ‚Üí RPC 'get_estimate_completion_paginated' (50 –∑–∞–ø–∏—Å–µ–π) 
           ‚Üí –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª ‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–∏—Ö 50 –ø—Ä–∏ –Ω—É–∂–¥–µ ‚úÖ
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

**–î–∞—Ç–∞:** 27.10.2025  
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ –≤ Supabase Dashboard
