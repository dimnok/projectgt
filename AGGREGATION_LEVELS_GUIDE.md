# üìä –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: –ù–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏

## üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

### 1Ô∏è‚É£ `AggregationLevel.detailed` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ 9 –ø–æ–ª—è–º:**
```
–û–±—ä–µ–∫—Ç | –î–æ–≥–æ–≤–æ—Ä | –°–∏—Å—Ç–µ–º–∞ | –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ | –£—á–∞—Å—Ç–æ–∫ | –≠—Ç–∞–∂ | ‚Ññ –ø–æ–∑–∏—Ü–∏–∏ | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ | –ï–¥. –∏–∑–º.
```

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫:**
```
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | –ó–∞–ª | 1 | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ | –º
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | –ó–∞–ª | 2 | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ | –º
‚Üì –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç—Å—è
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | –ó–∞–ª | 1 | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ | –º (–∏—Ç–æ–≥–æ: –∫–æ–ª-–≤–æ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | –ó–∞–ª | 2 | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ | –º (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)
```

---

### 2Ô∏è‚É£ `AggregationLevel.summary` (–Ω–æ–≤–æ–µ!)
**–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ 6 –ø–æ–ª—è–º:**
```
–û–±—ä–µ–∫—Ç | –î–æ–≥–æ–≤–æ—Ä | –°–∏—Å—Ç–µ–º–∞ | –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ | ‚Ññ –ø–æ–∑–∏—Ü–∏–∏ | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
```

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫:**
```
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏
‚Üì –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ –≤—Å–µ–º–∏:
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | –ó–∞–ª | 1 | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ | –º
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | –ó–∞–ª | 2 | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ | –º
‚Üì –∏—Ç–æ–≥
–î–æ–º –ê | –î-1 | –í–ö | –≠–ª–µ–∫—Ç—Ä–æ | 1.1 | –ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ–≤–æ–¥–∫–∏ (total quantity + total sum)
```

---

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–¥–µ (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á—ë—Ç–∞):

```dart
// –î–µ—Ç–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
final filter1 = ExportFilter(
  dateFrom: DateTime.now(),
  dateTo: DateTime.now(),
  aggregationLevel: AggregationLevel.detailed,  // ‚Üê –í–°–ï 9 –ø–æ–ª–µ–π
);
ref.read(exportProvider.notifier).loadReportData(filter1);

// –°–æ–∫—Ä–∞—â—ë–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
final filter2 = ExportFilter(
  dateFrom: DateTime.now(),
  dateTo: DateTime.now(),
  aggregationLevel: AggregationLevel.summary,  // ‚Üê –¢–û–õ–¨–ö–û 6 –ø–æ–ª–µ–π
);
ref.read(exportProvider.notifier).loadReportData(filter2);
```

---

## üéØ –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –≤ UI

### –í–∞—Ä–∏–∞–Ω—Ç 1: RadioButton –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö

```dart
// –í _ExportFiltersPanel –¥–æ–±–∞–≤–∏—Ç—å:
SizedBox(height: 16),
Text('–£—Ä–æ–≤–µ–Ω—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:', 
    style: theme.textTheme.titleSmall?.copyWith(fontWeight: FontWeight.bold)),
const SizedBox(height: 8),
Row(
  children: [
    Expanded(
      child: RadioListTile<AggregationLevel>(
        contentPadding: EdgeInsets.zero,
        title: const Text('–î–µ—Ç–∞–ª—å–Ω–∞—è (–≤—Å–µ –ø–æ–ª—è)'),
        value: AggregationLevel.detailed,
        groupValue: st.aggregationLevel,  // ‚Üê –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ state
        onChanged: (value) {
          if (value != null) {
            ref.read(exportFilterProvider.notifier)
                .setAggregationLevel(value);
          }
        },
      ),
    ),
    Expanded(
      child: RadioListTile<AggregationLevel>(
        contentPadding: EdgeInsets.zero,
        title: const Text('–ö—Ä–∞—Ç–∫–∞—è (6 –ø–æ–ª–µ–π)'),
        value: AggregationLevel.summary,
        groupValue: st.aggregationLevel,
        onChanged: (value) {
          if (value != null) {
            ref.read(exportFilterProvider.notifier)
                .setAggregationLevel(value);
          }
        },
      ),
    ),
  ],
),
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: SegmentedButton (–±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ)

```dart
import 'package:flutter/material.dart';

SegmentedButton<AggregationLevel>(
  segments: const [
    ButtonSegment(
      value: AggregationLevel.detailed,
      label: Text('–î–µ—Ç–∞–ª—å–Ω–∞—è'),
    ),
    ButtonSegment(
      value: AggregationLevel.summary,
      label: Text('–ö—Ä–∞—Ç–∫–∞—è'),
    ),
  ],
  selected: {st.aggregationLevel},
  onSelectionChanged: (newSelection) {
    ref.read(exportFilterProvider.notifier)
        .setAggregationLevel(newSelection.first);
  },
)
```

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫

```
User –≤—ã–±–∏—Ä–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å (Detailed/Summary)
    ‚Üì
ExportFilterNotifier.setAggregationLevel(level)
    ‚Üì
ExportFilterState.aggregationLevel = level
    ‚Üì
ExportFilter —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å aggregationLevel
    ‚Üì
ExportRepositoryImpl.getExportData(filter)
    ‚Üì
aggregateReports(reports, level: filter.aggregationLevel)
    ‚Üì
UI/Excel –ø–æ–ª—É—á–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —É—Ä–æ–≤–Ω—é –¥–∞–Ω–Ω—ã–µ
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –≤ ExportFilterState

–î–æ–±–∞–≤—å—Ç–µ –≤ `ExportFilterState`:

```dart
class ExportFilterState {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
  
  /// –í—ã–±—Ä–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏.
  final AggregationLevel aggregationLevel;

  ExportFilterState({
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ...
    this.aggregationLevel = AggregationLevel.detailed,
  });

  /// –°–æ–∑–¥–∞—ë—Ç –∫–æ–ø–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏.
  ExportFilterState copyWith({
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ...
    AggregationLevel? aggregationLevel,
  }) =>
      ExportFilterState(
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
        aggregationLevel: aggregationLevel ?? this.aggregationLevel,
      );
}

class ExportFilterNotifier extends StateNotifier<ExportFilterState> {
  // ...
  
  /// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏.
  void setAggregationLevel(AggregationLevel level) {
    state = state.copyWith(aggregationLevel: level);
  }
}
```

---

## ‚úÖ –ü–ª—é—Å—ã –ø–æ–¥—Ö–æ–¥–∞

1. ‚úÖ **–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏** ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω case –≤ enum
2. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –Ω—É–∂–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
3. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞** ‚Äî –≤—Å—ë –≤ `aggregateReports()`
4. ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Excel –∏ UI
5. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë —É—Ä–æ–≤–Ω–∏ (ultra_brief, detailed_with_custom_field –∏ —Ç.–¥.)

