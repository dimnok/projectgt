<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Система управления проектами и сметами">
  <meta name="keywords" content="project management, estimates, construction">
  
  <!-- App version info for package_info_plus -->
  <meta name="version" content="1.0.1">
  <meta name="build-number" content="21">
  
  <!-- PWA meta tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ProjectGT">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="ProjectGT">
  
  <!-- iOS icons -->
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/Icon-512.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>
  
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Telegram WebApp SDK - необходимо для Telegram Mini App авторизации -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <title>ProjectGT</title>
  
  <!-- Status Bar Control -->
  <script>
    // Функция для установки цвета статус-бара
    function setStatusBarColor(color) {
      const themeMeta = document.querySelector('meta[name="theme-color"]');
      if (themeMeta) {
        themeMeta.setAttribute('content', color);
      }
      
      // Установить цвет для iOS
      const appleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
      if (appleMeta) {
        // Определить яркость цвета
        const r = parseInt(color.slice(1, 3), 16);
        const g = parseInt(color.slice(3, 5), 16);
        const b = parseInt(color.slice(5, 7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        if (brightness > 125) {
          appleMeta.setAttribute('content', 'default');
        } else {
          appleMeta.setAttribute('content', 'black-translucent');
        }
      }
      
      // Сохранить цвет в CSS переменную
      document.documentElement.style.setProperty('--status-bar-color', color);
    }
    
    // Функция для инициализации PWA стилей
    function initializePWAStyles() {
      // Добавить CSS для safe area
      const style = document.createElement('style');
      style.textContent = '@media (display-mode: standalone) {\\n' +
        '  body {\\n' +
        '    padding-top: env(safe-area-inset-top);\\n' +
        '    padding-bottom: env(safe-area-inset-bottom);\\n' +
        '  }\\n' +
        '  .safe-area-top {\\n' +
        '    height: env(safe-area-inset-top);\\n' +
        '    background: var(--status-bar-color, #000000);\\n' +
        '  }\\n' +
        '  .safe-area-bottom {\\n' +
        '    height: env(safe-area-inset-bottom);\\n' +
        '  }\\n' +
        '  .app-bar {\\n' +
        '    margin-top: env(safe-area-inset-top);\\n' +
        '  }\\n' +
        '}\\n' +
        '@media (max-width: 600px) {\\n' +
        '  body { font-size: 14px; }\\n' +
        '}';
      document.head.appendChild(style);
      
      // Установить начальный цвет статус-бара (белый для светлой темы)
      setStatusBarColor('#ffffff');
    }
    
    // Инициализация Telegram WebApp с повторными попытками
    function initializeTelegramWebApp() {
      // Telegram WebApp SDK может загружаться асинхронно на мобильных устройствах
      // Пробуем инициализировать несколько раз с задержкой
      
      function tryInitialize(attempt = 1) {
        if (window.Telegram && window.Telegram.WebApp) {
          // Готовим WebApp для использования
          window.Telegram.WebApp.ready();
          
          // Расширяем WebApp на весь экран
          window.Telegram.WebApp.expand();
          
          console.log('[Telegram WebApp] Initialized successfully on attempt', attempt);
          console.log('[Telegram WebApp] initData available:', !!window.Telegram.WebApp.initData);
          console.log('[Telegram WebApp] initData:', window.Telegram.WebApp.initData);
          
          // Сохраняем флаг инициализации
          window.__telegramWebAppReady = true;
        } else if (attempt < 5) {
          // Если SDK ещё не загружен - пробуем через 100ms
          console.log('[Telegram WebApp] SDK not ready yet, retrying... (attempt', attempt, ')');
          setTimeout(() => tryInitialize(attempt + 1), 100);
        } else {
          console.log('[Telegram WebApp] Not running in Telegram environment after 5 attempts');
          window.__telegramWebAppReady = false;
        }
      }
      
      tryInitialize();
    }
    
    // Инициализация при загрузке и сразу же
    window.addEventListener('load', initializePWAStyles);
    window.addEventListener('load', initializeTelegramWebApp);
    
    // Попробуем инициализировать Telegram сразу (может быть готов уже)
    initializeTelegramWebApp();
    
    // Функция для Flutter вызова
    window.flutterStatusBar = {
      setColor: setStatusBarColor,
      getColor: function() {
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        return themeMeta ? themeMeta.getAttribute('content') : '#000000';
      }
    };
    
    // Конфигурация для Flutter.js с автоматической регистрацией service worker
    window.addEventListener('load', function() {
      // Service Worker будет зарегистрирован автоматически через flutter.js
      // Настроим обработку обновлений
      if ('serviceWorker' in navigator) {
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', function() {
          if (refreshing) return;
          refreshing = true;
          window.location.reload();
        });
      }
    });
  </script>
  
</head>
<body>
  <!-- Flutter Bootstrap - современный способ инициализации -->
  <script src="flutter_bootstrap.js" async></script>

</body>
</html>
